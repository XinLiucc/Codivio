# 技术决策记录 (ADR)

## ADR-001: 技术栈选择 - Spring Boot + Vue

**日期**: 2025-07-07
**状态**: 已采纳
**决策者**: 项目团队

### 背景
需要为Codivio项目选择合适的技术栈，实现实时协作代码编辑器的核心功能。

### 决策
选择Spring Boot + Vue 3技术栈组合。

#### 后端: Spring Boot 3.x
- **框架**: Spring Boot 3.x + Spring WebFlux
- **数据库**: MySQL 8.0 (主数据) + Redis 7.0 (缓存) + MongoDB (日志)
- **ORM**: MyBatis Plus
- **安全**: Spring Security + JWT
- **实时通信**: Spring WebSocket + SockJS

#### 前端: Vue 3
- **框架**: Vue 3 + Composition API
- **语言**: TypeScript
- **状态管理**: Pinia
- **UI组件**: Element Plus
- **编辑器**: Monaco Editor
- **构建工具**: Vite

### 理由
1. **Spring Boot优势**:
   - 成熟的企业级框架，生态丰富
   - 自动配置减少开发复杂度
   - 强大的WebSocket支持
   - 优秀的监控和运维支持

2. **Vue 3优势**:
   - 渐进式框架，学习曲线平缓
   - Composition API提供更好的逻辑复用
   - TypeScript支持优秀
   - 社区活跃，组件生态丰富

3. **组合优势**:
   - 技术成熟度高，风险可控
   - 求职市场需求量大
   - 文档资料丰富，问题解决方便
   - 适合团队技术背景

### 考虑的替代方案
1. **Node.js + React**: 全栈JavaScript，但缺乏企业级特性
2. **Go + Angular**: 性能优秀，但学习成本较高
3. **Python Django + React**: 开发效率高，但性能略逊

### 影响
- 开发周期: 中等 (学习成本适中)
- 性能表现: 优秀 (Spring Boot性能稳定)
- 可维护性: 良好 (代码结构清晰)
- 团队学习: 适中 (技术栈主流)

---

## ADR-002: 实时协作算法选择 - 操作转换(OT)

**日期**: 2025-07-07
**状态**: 讨论中
**决策者**: 技术团队

### 背景
实时协作编辑需要解决多用户同时编辑时的冲突问题，需要选择合适的一致性算法。

### 决策
采用操作转换(Operational Transformation, OT)算法。

### 理由
1. **技术成熟度**: OT算法被广泛应用于Google Docs等产品
2. **实现复杂度**: 相比CRDT算法，OT实现相对简单
3. **性能考虑**: 对于文本编辑场景，OT性能表现优秀
4. **学习资源**: 相关资料和实现案例较多

### 核心实现
```java
public class OperationTransform {
    public Operation transform(Operation op1, Operation op2) {
        // 插入-插入转换
        if (op1.isInsert() && op2.isInsert()) {
            if (op1.getPosition() <= op2.getPosition()) {
                return op2.withPosition(op2.getPosition() + op1.getLength());
            }
            return op2;
        }
        // 其他转换逻辑...
    }
}
```

### 考虑的替代方案
1. **CRDT**: 无中心化，但实现复杂度高
2. **Event Sourcing**: 数据一致性好，但存储开销大
3. **简单锁机制**: 实现简单，但用户体验差

### 影响
- 开发复杂度: 中等
- 性能表现: 良好
- 扩展性: 适中
- 用户体验: 优秀

---

## ADR-003: 数据库架构设计 - 微服务分库

**日期**: 2025-07-07
**状态**: 讨论中
**决策者**: 架构团队

### 背景
随着功能模块增加，需要设计合理的数据库架构支持微服务。

### 决策
采用按业务域分库的微服务数据库架构:
- **codivio_user**: 用户数据库 (MySQL)
- **codivio_project**: 项目数据库 (MySQL)
- **codivio_system**: 系统数据库 (MySQL)
- **Redis**: 缓存和实时状态
- **MongoDB**: 操作历史和日志

### 理由
1. **服务隔离**: 每个微服务拥有独立数据库
2. **技术适配**: 不同数据特性选择最适合的存储
3. **性能优化**: 避免跨库事务，提高性能
4. **扩展性**: 支持独立扩展每个数据库

### 数据一致性策略
- **最终一致性**: 通过消息队列实现
- **分布式事务**: 使用Saga模式处理
- **数据同步**: 定期同步关键数据

### 影响
- 开发复杂度: 高 (需要处理分布式事务)
- 性能表现: 优秀 (避免单点瓶颈)
- 可维护性: 良好 (清晰的数据边界)
- 扩展性: 优秀 (支持独立扩展)

---

## ADR-004: 容器化部署策略 - Docker + Kubernetes

**日期**: 2025-07-07
**状态**: 讨论中
**决策者**: 运维团队

### 背景
需要选择适合的部署方式，支持高可用和弹性扩展。

### 决策
采用Docker容器化 + Kubernetes编排的部署策略。

### 理由
1. **环境一致性**: Docker确保开发、测试、生产环境一致
2. **自动扩展**: Kubernetes提供HPA自动扩展能力
3. **服务发现**: 内置服务发现和负载均衡
4. **故障恢复**: 自动重启和故障转移
5. **资源管理**: 精确的资源分配和限制

### 部署架构
```yaml
Production Cluster:
  - Namespace: codivio
  - Services: frontend, backend, gateway
  - Databases: mysql, redis, mongodb
  - Monitoring: prometheus, grafana
  - Logging: elk stack
```

### 考虑的替代方案
1. **虚拟机部署**: 资源利用率低，扩展不便
2. **Docker Compose**: 适合开发，不适合生产
3. **Serverless**: 成本可控，但功能限制多

### 影响
- 部署复杂度: 高 (需要K8s专业知识)
- 运维效率: 优秀 (自动化程度高)
- 成本控制: 良好 (资源利用率高)
- 可扩展性: 优秀 (弹性扩展)

---

## ADR-005: 前端状态管理 - Pinia vs Vuex

**日期**: 2025-07-07
**状态**: 讨论中
**决策者**: 前端团队

### 背景
Vue 3项目需要选择合适的状态管理方案。

### 决策
选择Pinia作为状态管理库。

### 理由
1. **Vue 3优化**: 专为Vue 3设计，完全支持Composition API
2. **TypeScript支持**: 原生TypeScript支持，类型推导优秀
3. **DevTools**: 完整的Vue DevTools支持
4. **模块化**: 自然的模块化设计，无需modules概念
5. **轻量级**: 更小的包体积，更简单的API

### 使用示例
```typescript
// stores/user.ts
export const useUserStore = defineStore('user', () => {
  const user = ref<User | null>(null)
  const isLoggedIn = computed(() => !!user.value)
  
  const login = async (credentials: LoginForm) => {
    const response = await api.login(credentials)
    user.value = response.data
  }
  
  return { user, isLoggedIn, login }
})
```

### 考虑的替代方案
1. **Vuex 4**: Vue官方方案，但TypeScript支持不佳
2. **原生Composition API**: 简单场景够用，复杂状态管理困难
3. **Zustand**: React生态方案，Vue适配不完整

### 影响
- 开发体验: 优秀 (API简洁，类型安全)
- 学习成本: 低 (相比Vuex更简单)
- 性能表现: 优秀 (按需响应式)
- 生态支持: 良好 (Vue官方推荐)

---

## ADR-006: 代码执行环境 - Docker安全沙箱

**日期**: 2025-07-07
**状态**: 讨论中
**决策者**: 安全团队

### 背景
在线代码执行功能需要确保安全性，防止恶意代码攻击。

### 决策
采用Docker容器作为代码执行的安全沙箱环境。

### 安全措施
1. **容器隔离**: 每次执行创建独立容器
2. **资源限制**: 严格限制CPU、内存、磁盘使用
3. **网络隔离**: 禁用网络访问
4. **权限控制**: 非root用户执行
5. **时间限制**: 强制执行超时机制

### 实现方案
```java
ContainerConfig config = ContainerConfig.builder()
    .image(getSecureImage(language))
    .user("sandbox:sandbox")
    .workingDir("/sandbox")
    .build();

HostConfig hostConfig = HostConfig.builder()
    .memory(128 * 1024 * 1024L) // 128MB内存限制
    .cpuShares(512L)             // CPU限制
    .networkMode("none")         // 禁用网络
    .readonlyRootfs(true)       // 只读根文件系统
    .build();
```

### 考虑的替代方案
1. **虚拟机**: 安全性高但资源消耗大
2. **进程隔离**: 性能好但安全性不足
3. **第三方服务**: 依赖性强，成本较高

### 影响
- 安全性: 优秀 (多层安全防护)
- 性能表现: 良好 (容器启动快)
- 资源消耗: 适中 (相比虚拟机轻量)
- 开发复杂度: 中等 (需要容器管理)

---

## ADR-007: API设计风格 - RESTful + GraphQL混合

**日期**: 2025-07-07
**状态**: 讨论中
**决策者**: 后端团队

### 背景
需要选择合适的API设计风格，满足不同场景的需求。

### 决策
采用RESTful为主，GraphQL为辅的混合API架构。

### 理由
1. **RESTful优势**: 
   - 简单易懂，团队熟悉
   - 缓存友好，HTTP标准支持
   - 工具生态成熟

2. **GraphQL优势**:
   - 按需查询，减少过度获取
   - 强类型schema，自文档化
   - 适合复杂查询场景

### 使用策略
```yaml
RESTful APIs:
  - 用户认证和授权
  - 文件上传下载
  - 简单的CRUD操作
  - 缓存需求高的接口

GraphQL APIs:
  - 复杂的数据查询
  - 仪表板统计数据
  - 关联数据获取
  - 前端灵活查询需求
```

### 考虑的替代方案
1. **纯RESTful**: 简单但灵活性不足
2. **纯GraphQL**: 灵活但学习成本高
3. **gRPC**: 性能优秀但HTTP不友好

### 影响
- 开发复杂度: 中等 (需要维护两套API)
- 性能表现: 优秀 (各取所长)
- 学习成本: 中等 (团队需要学习GraphQL)
- 客户端体验: 优秀 (灵活的数据获取)

---

## ADR-008: 消息队列选择 - RabbitMQ vs Apache Kafka

**日期**: 2025-07-07
**状态**: 讨论中
**决策者**: 架构团队

### 背景
微服务架构需要可靠的消息队列来处理异步通信。

### 决策
选择RabbitMQ作为主要消息队列中间件。

### 理由
1. **使用场景匹配**: 
   - 主要用于服务间异步通信
   - 消息量适中，不需要超高吞吐
   - 需要消息确认和事务支持

2. **技术特性**:
   - 丰富的路由功能
   - 消息确认机制完善
   - 管理界面友好
   - Spring Boot集成简单

3. **运维考虑**:
   - 部署相对简单
   - 监控工具成熟
   - 社区支持好

### 消息设计
```yaml
Exchanges:
  - user.events: 用户相关事件
  - project.events: 项目相关事件
  - editor.events: 编辑协作事件

Queues:
  - user.created: 用户创建后处理
  - project.updated: 项目更新同步
  - editor.operation: 编辑操作记录
```

### 考虑的替代方案
1. **Apache Kafka**: 高吞吐但复杂度高
2. **Redis Pub/Sub**: 简单但功能有限
3. **AWS SQS/SNS**: 托管服务但厂商绑定

### 影响
- 开发复杂度: 低 (Spring Boot集成简单)
- 性能表现: 良好 (满足业务需求)
- 运维复杂度: 中等 (需要集群管理)
- 成本控制: 良好 (开源方案)

---

## ADR-009: 监控和可观测性 - Prometheus + Grafana + ELK

**日期**: 2025-07-07
**状态**: 讨论中
**决策者**: 运维团队

### 背景
生产环境需要完整的监控和可观测性方案。

### 决策
采用Prometheus + Grafana + ELK Stack的监控方案。

### 组件选择
1. **Prometheus**: 指标收集和存储
2. **Grafana**: 可视化仪表板
3. **Elasticsearch**: 日志存储和搜索
4. **Logstash**: 日志处理
5. **Kibana**: 日志可视化
6. **Filebeat**: 日志收集

### 监控策略
```yaml
应用监控:
  - JVM指标 (内存、GC、线程)
  - 业务指标 (用户在线、协作操作)
  - 接口性能 (响应时间、错误率)

基础设施监控:
  - 服务器资源 (CPU、内存、磁盘)
  - 数据库性能 (连接数、查询时间)
  - 网络状态 (延迟、丢包率)

日志管理:
  - 应用日志 (业务操作、错误信息)
  - 访问日志 (请求记录、用户行为)
  - 系统日志 (操作系统、容器日志)
```

### 考虑的替代方案
1. **Datadog**: 功能强大但成本高
2. **New Relic**: SaaS方案但数据外流
3. **Zabbix**: 传统监控但现代化不足

### 影响
- 运维效率: 优秀 (全面的可观测性)
- 成本控制: 良好 (开源方案为主)
- 学习成本: 中等 (需要掌握多个工具)
- 问题诊断: 优秀 (完整的链路追踪)

---

## ADR-010: 安全策略 - 多层防护架构

**日期**: 2025-07-07
**状态**: 讨论中
**决策者**: 安全团队

### 背景
在线代码编辑器面临多种安全威胁，需要完整的安全防护策略。

### 决策
采用多层防护的安全架构。

### 安全层级
```
网络层安全:
  - HTTPS/WSS加密传输
  - WAF Web应用防火墙
  - DDoS防护

应用层安全:
  - JWT令牌认证
  - RBAC权限控制
  - 输入验证和过滤
  - SQL注入防护
  - XSS攻击防护

数据层安全:
  - 数据加密存储
  - 敏感信息脱敏
  - 定期备份策略

代码执行安全:
  - Docker容器隔离
  - 资源使用限制
  - 网络访问禁用
  - 恶意代码检测
```

### 实施策略
1. **身份认证**: JWT + OAuth2.0双重认证
2. **权限控制**: 基于角色的细粒度权限
3. **代码安全**: 静态分析 + 动态检测
4. **数据保护**: 端到端加密传输
5. **审计日志**: 完整的操作记录

### 考虑的替代方案
1. **第三方安全服务**: 成本高，定制性差
2. **简单防护**: 安全风险大
3. **过度防护**: 用户体验差，开发复杂

### 影响
- 安全性: 优秀 (多层防护)
- 开发复杂度: 高 (需要安全专业知识)
- 用户体验: 良好 (安全与体验平衡)
- 合规性: 优秀 (满足安全标准)

---

## 决策跟踪表

| ADR编号 | 决策内容 | 状态 | 决策日期 | 影响范围 | 后续行动 |
|---------|----------|------|----------|----------|----------|
| ADR-001 | Spring Boot + Vue技术栈 | ✅ 已采纳 | 2025-07-07 | 整体架构 | 已实施 |
| ADR-002 | 操作转换算法(OT) | 🔄 讨论中 | 2025-07-07 | 实时协作 | 评估中 |
| ADR-003 | 微服务分库架构 | 🔄 讨论中 | 2025-07-07 | 数据架构 | 评估中 |
| ADR-004 | Docker + K8s部署 | 🔄 讨论中 | 2025-07-07 | 部署策略 | 评估中 |
| ADR-005 | Pinia状态管理 | 🔄 讨论中 | 2025-07-07 | 前端架构 | 评估中 |
| ADR-006 | Docker安全沙箱 | 🔄 讨论中 | 2025-07-07 | 代码执行 | 评估中 |
| ADR-007 | RESTful + GraphQL混合 | 🔄 讨论中 | 2025-07-07 | API设计 | 评估中 |
| ADR-008 | RabbitMQ消息队列 | 🔄 讨论中 | 2025-07-07 | 异步通信 | 评估中 |
| ADR-009 | Prometheus监控方案 | 🔄 讨论中 | 2025-07-07 | 监控运维 | 评估中 |
| ADR-010 | 多层安全防护 | 🔄 讨论中 | 2025-07-07 | 安全策略 | 评估中 |

---

## 决策回顾和改进

### 定期回顾
- **月度回顾**: 评估已实施决策的效果
- **季度总结**: 分析决策对项目目标的影响
- **年度审计**: 全面评估技术决策的合理性

### 改进机制
- **决策质量评估**: 根据实施效果评估决策质量
- **经验教训总结**: 记录决策过程中的经验教训
- **决策模板优化**: 持续改进决策记录模板

### 知识分享
- **技术分享会**: 定期分享重要技术决策
- **文档维护**: 保持ADR文档的及时更新
- **团队培训**: 确保团队理解关键技术决策