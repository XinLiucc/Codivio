# Codivio å¼€å‘è§„èŒƒæ‰‹å†Œ

## ğŸ¯ ç¼–ç è§„èŒƒæ€»åˆ™

éµå¾ª**clean code**åŸåˆ™ï¼Œç¡®ä¿ä»£ç å¯è¯»æ€§ã€å¯ç»´æŠ¤æ€§å’Œä¸€è‡´æ€§ï¼Œä¸ºå›¢é˜Ÿåä½œå’Œé¡¹ç›®é•¿æœŸå‘å±•å¥ å®šåŸºç¡€ã€‚

### æ ¸å¿ƒåŸåˆ™
- ğŸ” **å¯è¯»æ€§ä¼˜å…ˆ** - ä»£ç æ˜¯å†™ç»™äººçœ‹çš„ï¼Œå…¶æ¬¡æ‰æ˜¯æœºå™¨
- ğŸ“ **ä¸€è‡´æ€§åŸåˆ™** - ç»Ÿä¸€çš„ç¼–ç é£æ ¼å’Œå‘½åè§„èŒƒ
- ğŸ§© **æ¨¡å—åŒ–è®¾è®¡** - é«˜å†…èšä½è€¦åˆçš„ä»£ç ç»“æ„
- ğŸ›¡ï¸ **å®‰å…¨æ„è¯†** - é˜²èŒƒå¸¸è§å®‰å…¨æ¼æ´
- âš¡ **æ€§èƒ½è€ƒè™‘** - ç¼–å†™é«˜æ•ˆçš„ä»£ç 

---

## ğŸŒ å‰ç«¯å¼€å‘è§„èŒƒ

### 1. Vue.js ç¼–ç è§„èŒƒ

#### ç»„ä»¶ç»“æ„è§„èŒƒ
```vue
<!-- âœ… æ¨èçš„ç»„ä»¶ç»“æ„ -->
<template>
  <div class="user-profile">
    <!-- æ¨¡æ¿å†…å®¹ -->
    <div class="user-avatar">
      <img :src="user.avatar" :alt="user.name" />
    </div>
    
    <div class="user-info">
      <h3 class="user-name">{{ user.name }}</h3>
      <p class="user-email">{{ user.email }}</p>
    </div>
    
    <div class="user-actions">
      <el-button @click="handleEdit" type="primary">ç¼–è¾‘</el-button>
      <el-button @click="handleDelete" type="danger">åˆ é™¤</el-button>
    </div>
  </div>
</template>

<script setup lang="ts">
// 1. å¯¼å…¥ä¾èµ–
import { ref, computed, onMounted } from 'vue'
import { ElMessage } from 'element-plus'
import { useUserStore } from '@/stores/user'
import type { User } from '@/types/user'

// 2. å®šä¹‰Props
interface Props {
  userId: string
  editable?: boolean
}

const props = withDefaults(defineProps<Props>(), {
  editable: true
})

// 3. å®šä¹‰Emits
interface Emits {
  (e: 'edit', user: User): void
  (e: 'delete', userId: string): void
}

const emit = defineEmits<Emits>()

// 4. å“åº”å¼æ•°æ®
const userStore = useUserStore()
const loading = ref(false)
const user = ref<User | null>(null)

// 5. è®¡ç®—å±æ€§
const displayName = computed(() => {
  return user.value?.nickname || user.value?.name || 'æœªçŸ¥ç”¨æˆ·'
})

// 6. æ–¹æ³•å®šä¹‰
const handleEdit = () => {
  if (!user.value) return
  emit('edit', user.value)
}

const handleDelete = async () => {
  if (!user.value) return
  
  try {
    await ElMessageBox.confirm('ç¡®å®šåˆ é™¤æ­¤ç”¨æˆ·å—ï¼Ÿ', 'åˆ é™¤ç¡®è®¤')
    emit('delete', user.value.id)
    ElMessage.success('åˆ é™¤æˆåŠŸ')
  } catch {
    // ç”¨æˆ·å–æ¶ˆ
  }
}

const fetchUser = async () => {
  loading.value = true
  try {
    user.value = await userStore.fetchUser(props.userId)
  } catch (error) {
    ElMessage.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥')
  } finally {
    loading.value = false
  }
}

// 7. ç”Ÿå‘½å‘¨æœŸ
onMounted(() => {
  fetchUser()
})
</script>

<style scoped>
.user-profile {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px;
  border: 1px solid var(--el-border-color);
  border-radius: 8px;
}

.user-avatar img {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  object-fit: cover;
}

.user-info {
  flex: 1;
}

.user-name {
  margin: 0 0 4px 0;
  font-size: 16px;
  font-weight: 600;
}

.user-email {
  margin: 0;
  color: var(--el-text-color-secondary);
  font-size: 14px;
}

.user-actions {
  display: flex;
  gap: 8px;
}
</style>
```

#### å‘½åè§„èŒƒ
```yaml
ç»„ä»¶å‘½å:
  - æ–‡ä»¶å: PascalCase (UserProfile.vue)
  - ç»„ä»¶å: PascalCase (UserProfile)
  - å®ä¾‹å: camelCase (userProfile)

Propså‘½å:
  - å®šä¹‰: camelCase (userId, isVisible)
  - æ¨¡æ¿: kebab-case (user-id, is-visible)

äº‹ä»¶å‘½å:
  - å®šä¹‰: camelCase (updateUser, deleteItem)
  - æ¨¡æ¿: kebab-case (update-user, delete-item)

CSSç±»å:
  - BEMè§„èŒƒ: block__element--modifier
  - ç¤ºä¾‹: user-card__title--highlighted

å¸¸é‡å‘½å:
  - UPPER_SNAKE_CASE (MAX_RETRY_COUNT)
```

#### ç»„ä»¶è®¾è®¡åŸåˆ™
```typescript
// âœ… å•ä¸€èŒè´£åŸåˆ™
// æ¯ä¸ªç»„ä»¶åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½
const UserCard = defineComponent({ /* åªè´Ÿè´£å±•ç¤ºç”¨æˆ·å¡ç‰‡ */ })
const UserEditor = defineComponent({ /* åªè´Ÿè´£ç¼–è¾‘ç”¨æˆ· */ })

// âœ… Propsè®¾è®¡åŸåˆ™
interface Props {
  // å¿…éœ€çš„propsåœ¨å‰
  userId: string
  
  // å¯é€‰çš„propsåœ¨åï¼Œæä¾›é»˜è®¤å€¼
  editable?: boolean
  showActions?: boolean
  
  // å¤æ‚ç±»å‹æ˜ç¡®å®šä¹‰
  user?: User | null
  
  // å›è°ƒå‡½æ•°æ˜ç¡®å‚æ•°ç±»å‹
  onUpdate?: (user: User) => void
}

// âœ… äº‹ä»¶è®¾è®¡åŸåˆ™
interface Emits {
  // ä½¿ç”¨åŠ¨è¯+åè¯çš„å½¢å¼
  (e: 'update:user', user: User): void
  (e: 'delete:user', userId: string): void
  
  // æºå¸¦æ˜ç¡®çš„å‚æ•°ç±»å‹
  (e: 'status:change', status: 'loading' | 'success' | 'error'): void
}

// âŒ é¿å…çš„åšæ³•
interface BadProps {
  data: any  // ç±»å‹ä¸æ˜ç¡®
  config: object  // ç»“æ„ä¸æ¸…æ™°
}
```

### 2. TypeScript è§„èŒƒ

#### ç±»å‹å®šä¹‰è§„èŒƒ
```typescript
// âœ… APIå“åº”ç±»å‹å®šä¹‰
interface ApiResponse<T = any> {
  code: number
  message: string
  data: T
  timestamp: number
}

// âœ… ä¸šåŠ¡å®ä½“ç±»å‹
interface User {
  readonly id: string
  username: string
  email: string
  nickname?: string
  avatar?: string
  status: UserStatus
  permissions: Permission[]
  createdAt: Date
  updatedAt: Date
}

// âœ… æšä¸¾å®šä¹‰
enum UserStatus {
  ACTIVE = 'active',
  INACTIVE = 'inactive',
  SUSPENDED = 'suspended'
}

// âœ… è”åˆç±»å‹
type Theme = 'light' | 'dark' | 'auto'
type ResponseStatus = 'idle' | 'loading' | 'success' | 'error'

// âœ… æ³›å‹å·¥å…·ç±»å‹
type Partial<T> = {
  [P in keyof T]?: T[P]
}

type ApiEndpoint<T> = {
  url: string
  method: 'GET' | 'POST' | 'PUT' | 'DELETE'
  params?: Record<string, any>
  data?: T
}

// âœ… æ¡ä»¶ç±»å‹
type NonNullable<T> = T extends null | undefined ? never : T

// âœ… æ˜ å°„ç±»å‹
type UserUpdatePayload = Pick<User, 'username' | 'email' | 'nickname'>
type UserCreatePayload = Omit<User, 'id' | 'createdAt' | 'updatedAt'>
```

#### å‡½æ•°ç­¾åè§„èŒƒ
```typescript
// âœ… æ˜ç¡®çš„å‡½æ•°ç­¾å
async function fetchUserById(
  userId: string,
  options?: {
    includePermissions?: boolean
    includeProjects?: boolean
  }
): Promise<User> {
  // å®ç°
}

// âœ… æ³›å‹å‡½æ•°
function createApiClient<T>(baseURL: string): ApiClient<T> {
  // å®ç°
}

// âœ… å‡½æ•°é‡è½½
function formatDate(date: Date): string
function formatDate(date: string): string
function formatDate(date: number): string
function formatDate(date: Date | string | number): string {
  // å®ç°
}

// âœ… é«˜é˜¶å‡½æ•°ç±»å‹
type EventHandler<T = any> = (event: T) => void | Promise<void>
type ApiCall<TParams, TResponse> = (params: TParams) => Promise<TResponse>

// âœ… è£…é¥°å™¨ç±»å‹
function debounce<T extends (...args: any[]) => any>(
  func: T,
  wait: number
): T {
  // å®ç°
}
```

### 3. æ ·å¼è§„èŒƒ

#### CSS/SCSS è§„èŒƒ
```scss
// âœ… å˜é‡å®šä¹‰
:root {
  // é¢œè‰²ç³»ç»Ÿ
  --color-primary: #007bff;
  --color-success: #28a745;
  --color-warning: #ffc107;
  --color-danger: #dc3545;
  
  // é—´è·ç³»ç»Ÿ
  --spacing-xs: 4px;
  --spacing-sm: 8px;
  --spacing-md: 16px;
  --spacing-lg: 24px;
  --spacing-xl: 32px;
  
  // å­—ä½“ç³»ç»Ÿ
  --font-size-xs: 12px;
  --font-size-sm: 14px;
  --font-size-md: 16px;
  --font-size-lg: 18px;
  --font-size-xl: 20px;
  
  // è¾¹æ¡†åœ†è§’
  --border-radius-sm: 4px;
  --border-radius-md: 8px;
  --border-radius-lg: 12px;
  
  // é˜´å½±
  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
  --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
  --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.1);
}

// âœ… BEMå‘½åè§„èŒƒ
.user-card {
  display: flex;
  padding: var(--spacing-md);
  border-radius: var(--border-radius-md);
  box-shadow: var(--shadow-sm);
  
  &__avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    margin-right: var(--spacing-md);
    
    &--large {
      width: 64px;
      height: 64px;
    }
  }
  
  &__content {
    flex: 1;
  }
  
  &__title {
    font-size: var(--font-size-lg);
    font-weight: 600;
    margin-bottom: var(--spacing-xs);
    
    &--highlighted {
      color: var(--color-primary);
    }
  }
  
  &__description {
    font-size: var(--font-size-sm);
    color: var(--text-color-secondary);
    line-height: 1.4;
  }
  
  &__actions {
    display: flex;
    gap: var(--spacing-sm);
    margin-left: var(--spacing-md);
  }
  
  // çŠ¶æ€ä¿®é¥°ç¬¦
  &--loading {
    opacity: 0.6;
    pointer-events: none;
  }
  
  &--disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }
}

// âœ… å“åº”å¼è®¾è®¡
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 var(--spacing-md);
  
  @media (max-width: 768px) {
    padding: 0 var(--spacing-sm);
  }
}

// âœ… åŠ¨ç”»æ•ˆæœ
.fade-enter-active,
.fade-leave-active {
  transition: opacity 0.3s ease;
}

.fade-enter-from,
.fade-leave-to {
  opacity: 0;
}

// âœ… å·¥å…·ç±»
.text-center { text-align: center; }
.text-right { text-align: right; }
.text-truncate { 
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.sr-only {
  position: absolute !important;
  width: 1px !important;
  height: 1px !important;
  padding: 0 !important;
  margin: -1px !important;
  overflow: hidden !important;
  clip: rect(0, 0, 0, 0) !important;
  white-space: nowrap !important;
  border: 0 !important;
}
```

#### æ€§èƒ½ä¼˜åŒ–è§„èŒƒ
```scss
// âœ… é¿å…æ·±å±‚åµŒå¥—ï¼ˆæœ€å¤š3å±‚ï¼‰
.navigation {
  .menu {
    .item {
      // æœ€å¤šåˆ°è¿™ä¸€å±‚
    }
  }
}

// âœ… ä½¿ç”¨é«˜æ•ˆé€‰æ‹©å™¨
.user-list-item { /* ç±»é€‰æ‹©å™¨æ€§èƒ½å¥½ */ }
#user-profile { /* IDé€‰æ‹©å™¨æ€§èƒ½æœ€å¥½ */ }

// âŒ é¿å…ä½æ•ˆé€‰æ‹©å™¨
* { /* é€šé…ç¬¦é€‰æ‹©å™¨æ€§èƒ½å·® */ }
div > div > div { /* å¤šå±‚æ ‡ç­¾é€‰æ‹©å™¨æ€§èƒ½å·® */ }
[data-id="123"] { /* å±æ€§é€‰æ‹©å™¨æ€§èƒ½ä¸€èˆ¬ */ }

// âœ… åˆç†ä½¿ç”¨CSSå˜é‡
.theme-dark {
  --text-color: #ffffff;
  --bg-color: #1a1a1a;
}

.theme-light {
  --text-color: #333333;
  --bg-color: #ffffff;
}
```

---

## âš™ï¸ åç«¯å¼€å‘è§„èŒƒ

### 1. Java/Spring Boot è§„èŒƒ

#### é¡¹ç›®ç»“æ„è§„èŒƒ
```
src/main/java/com/codivio/userservice/
â”œâ”€â”€ UserServiceApplication.java          # å¯åŠ¨ç±»
â”œâ”€â”€ config/                              # é…ç½®ç±»
â”‚   â”œâ”€â”€ DatabaseConfig.java
â”‚   â”œâ”€â”€ RedisConfig.java
â”‚   â””â”€â”€ SecurityConfig.java
â”œâ”€â”€ controller/                          # æ§åˆ¶å™¨å±‚
â”‚   â”œâ”€â”€ UserController.java
â”‚   â””â”€â”€ AuthController.java
â”œâ”€â”€ service/                             # æœåŠ¡å±‚
â”‚   â”œâ”€â”€ UserService.java
â”‚   â”œâ”€â”€ UserServiceImpl.java
â”‚   â””â”€â”€ AuthService.java
â”œâ”€â”€ repository/                          # æ•°æ®è®¿é—®å±‚
â”‚   â”œâ”€â”€ UserRepository.java
â”‚   â””â”€â”€ UserMapper.java
â”œâ”€â”€ domain/                              # å®ä½“ç±»
â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â””â”€â”€ User.java
â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”œâ”€â”€ UserDTO.java
â”‚   â”‚   â””â”€â”€ CreateUserRequest.java
â”‚   â””â”€â”€ vo/
â”‚       â””â”€â”€ UserProfileVO.java
â”œâ”€â”€ exception/                           # å¼‚å¸¸å¤„ç†
â”‚   â”œâ”€â”€ GlobalExceptionHandler.java
â”‚   â”œâ”€â”€ BusinessException.java
â”‚   â””â”€â”€ ErrorCode.java
â”œâ”€â”€ util/                                # å·¥å…·ç±»
â”‚   â”œâ”€â”€ JwtUtil.java
â”‚   â””â”€â”€ PasswordUtil.java
â””â”€â”€ constant/                            # å¸¸é‡å®šä¹‰
    â””â”€â”€ UserConstants.java
```

#### æ§åˆ¶å™¨è§„èŒƒ
```java
/**
 * ç”¨æˆ·ç®¡ç†æ§åˆ¶å™¨
 * 
 * @author å¼€å‘è€…å§“å
 * @since 1.0.0
 */
@RestController
@RequestMapping("/api/v1/users")
@Validated
@Slf4j
@Tag(name = "ç”¨æˆ·ç®¡ç†", description = "ç”¨æˆ·ç›¸å…³API")
public class UserController {

    private final UserService userService;

    public UserController(UserService userService) {
        this.userService = userService;
    }

    /**
     * è·å–ç”¨æˆ·åˆ—è¡¨
     *
     * @param params æŸ¥è¯¢å‚æ•°
     * @return ç”¨æˆ·åˆ—è¡¨
     */
    @GetMapping
    @Operation(summary = "è·å–ç”¨æˆ·åˆ—è¡¨", description = "æ”¯æŒåˆ†é¡µå’Œæ¡ä»¶æŸ¥è¯¢")
    @ApiResponse(responseCode = "200", description = "è·å–æˆåŠŸ")
    public ResponseEntity<PageResult<UserDTO>> getUsers(
            @Valid @ModelAttribute UserQueryParams params) {
        
        log.info("è·å–ç”¨æˆ·åˆ—è¡¨ï¼Œå‚æ•°: {}", params);
        
        PageResult<UserDTO> result = userService.getUsers(params);
        return ResponseEntity.ok(result);
    }

    /**
     * æ ¹æ®IDè·å–ç”¨æˆ·
     *
     * @param userId ç”¨æˆ·ID
     * @return ç”¨æˆ·ä¿¡æ¯
     */
    @GetMapping("/{userId}")
    @Operation(summary = "è·å–ç”¨æˆ·è¯¦æƒ…")
    public ResponseEntity<UserDTO> getUserById(
            @PathVariable @NotBlank(message = "ç”¨æˆ·IDä¸èƒ½ä¸ºç©º") String userId) {
        
        log.info("è·å–ç”¨æˆ·è¯¦æƒ…ï¼ŒID: {}", userId);
        
        UserDTO user = userService.getUserById(userId);
        return ResponseEntity.ok(user);
    }

    /**
     * åˆ›å»ºç”¨æˆ·
     *
     * @param request åˆ›å»ºç”¨æˆ·è¯·æ±‚
     * @return åˆ›å»ºçš„ç”¨æˆ·ä¿¡æ¯
     */
    @PostMapping
    @Operation(summary = "åˆ›å»ºç”¨æˆ·")
    public ResponseEntity<UserDTO> createUser(
            @Valid @RequestBody CreateUserRequest request) {
        
        log.info("åˆ›å»ºç”¨æˆ·ï¼Œè¯·æ±‚: {}", request);
        
        UserDTO user = userService.createUser(request);
        return ResponseEntity.status(HttpStatus.CREATED).body(user);
    }

    /**
     * æ›´æ–°ç”¨æˆ·
     *
     * @param userId ç”¨æˆ·ID
     * @param request æ›´æ–°è¯·æ±‚
     * @return æ›´æ–°åçš„ç”¨æˆ·ä¿¡æ¯
     */
    @PutMapping("/{userId}")
    @Operation(summary = "æ›´æ–°ç”¨æˆ·")
    public ResponseEntity<UserDTO> updateUser(
            @PathVariable @NotBlank String userId,
            @Valid @RequestBody UpdateUserRequest request) {
        
        log.info("æ›´æ–°ç”¨æˆ·ï¼ŒID: {}, è¯·æ±‚: {}", userId, request);
        
        UserDTO user = userService.updateUser(userId, request);
        return ResponseEntity.ok(user);
    }

    /**
     * åˆ é™¤ç”¨æˆ·
     *
     * @param userId ç”¨æˆ·ID
     * @return æ— å†…å®¹å“åº”
     */
    @DeleteMapping("/{userId}")
    @Operation(summary = "åˆ é™¤ç”¨æˆ·")
    public ResponseEntity<Void> deleteUser(
            @PathVariable @NotBlank String userId) {
        
        log.info("åˆ é™¤ç”¨æˆ·ï¼ŒID: {}", userId);
        
        userService.deleteUser(userId);
        return ResponseEntity.noContent().build();
    }
}
```

#### æœåŠ¡å±‚è§„èŒƒ
```java
/**
 * ç”¨æˆ·æœåŠ¡å®ç°ç±»
 */
@Service
@Transactional(readOnly = true)
@Slf4j
public class UserServiceImpl implements UserService {

    private final UserRepository userRepository;
    private final PasswordEncoder passwordEncoder;
    private final UserMapper userMapper;
    private final RedisTemplate<String, Object> redisTemplate;

    public UserServiceImpl(
            UserRepository userRepository,
            PasswordEncoder passwordEncoder,
            UserMapper userMapper,
            RedisTemplate<String, Object> redisTemplate) {
        this.userRepository = userRepository;
        this.passwordEncoder = passwordEncoder;
        this.userMapper = userMapper;
        this.redisTemplate = redisTemplate;
    }

    @Override
    public PageResult<UserDTO> getUsers(UserQueryParams params) {
        // å‚æ•°éªŒè¯
        Assert.notNull(params, "æŸ¥è¯¢å‚æ•°ä¸èƒ½ä¸ºç©º");
        
        // æ„å»ºæŸ¥è¯¢æ¡ä»¶
        Page<User> page = userRepository.findByConditions(
            params.getKeyword(),
            params.getStatus(),
            PageRequest.of(params.getPage() - 1, params.getSize())
        );
        
        // è½¬æ¢DTO
        List<UserDTO> userDTOs = page.getContent()
            .stream()
            .map(userMapper::toDTO)
            .collect(Collectors.toList());
        
        return PageResult.<UserDTO>builder()
            .data(userDTOs)
            .total(page.getTotalElements())
            .page(params.getPage())
            .size(params.getSize())
            .build();
    }

    @Override
    public UserDTO getUserById(String userId) {
        // å‚æ•°éªŒè¯
        Assert.hasText(userId, "ç”¨æˆ·IDä¸èƒ½ä¸ºç©º");
        
        // å…ˆä»ç¼“å­˜è·å–
        String cacheKey = CacheConstants.USER_INFO_KEY + userId;
        UserDTO cachedUser = (UserDTO) redisTemplate.opsForValue().get(cacheKey);
        if (cachedUser != null) {
            log.debug("ä»ç¼“å­˜è·å–ç”¨æˆ·ä¿¡æ¯: {}", userId);
            return cachedUser;
        }
        
        // ä»æ•°æ®åº“è·å–
        User user = userRepository.findById(userId)
            .orElseThrow(() -> new ResourceNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨: " + userId));
        
        UserDTO userDTO = userMapper.toDTO(user);
        
        // ç¼“å­˜ç”¨æˆ·ä¿¡æ¯
        redisTemplate.opsForValue().set(cacheKey, userDTO, Duration.ofHours(1));
        
        return userDTO;
    }

    @Override
    @Transactional
    public UserDTO createUser(CreateUserRequest request) {
        // å‚æ•°éªŒè¯
        Assert.notNull(request, "åˆ›å»ºç”¨æˆ·è¯·æ±‚ä¸èƒ½ä¸ºç©º");
        validateCreateUserRequest(request);
        
        // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
        if (userRepository.existsByUsername(request.getUsername())) {
            throw new BusinessException(ErrorCode.USERNAME_ALREADY_EXISTS);
        }
        
        // æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
        if (userRepository.existsByEmail(request.getEmail())) {
            throw new BusinessException(ErrorCode.EMAIL_ALREADY_EXISTS);
        }
        
        // æ„å»ºç”¨æˆ·å®ä½“
        User user = User.builder()
            .id(IdGenerator.nextId())
            .username(request.getUsername())
            .email(request.getEmail())
            .passwordHash(passwordEncoder.encode(request.getPassword()))
            .nickname(request.getNickname())
            .status(UserStatus.ACTIVE)
            .createdAt(LocalDateTime.now())
            .updatedAt(LocalDateTime.now())
            .build();
        
        // ä¿å­˜ç”¨æˆ·
        User savedUser = userRepository.save(user);
        
        // å‘å¸ƒç”¨æˆ·åˆ›å»ºäº‹ä»¶
        eventPublisher.publishEvent(new UserCreatedEvent(savedUser.getId()));
        
        log.info("ç”¨æˆ·åˆ›å»ºæˆåŠŸ: {}", savedUser.getId());
        
        return userMapper.toDTO(savedUser);
    }

    /**
     * éªŒè¯åˆ›å»ºç”¨æˆ·è¯·æ±‚
     */
    private void validateCreateUserRequest(CreateUserRequest request) {
        // ç”¨æˆ·åæ ¼å¼éªŒè¯
        if (!request.getUsername().matches("^[a-zA-Z0-9_]{3,20}$")) {
            throw new BusinessException(ErrorCode.INVALID_USERNAME_FORMAT);
        }
        
        // å¯†ç å¼ºåº¦éªŒè¯
        if (!isPasswordStrong(request.getPassword())) {
            throw new BusinessException(ErrorCode.WEAK_PASSWORD);
        }
        
        // é‚®ç®±æ ¼å¼éªŒè¯
        if (!EmailValidator.getInstance().isValid(request.getEmail())) {
            throw new BusinessException(ErrorCode.INVALID_EMAIL_FORMAT);
        }
    }

    /**
     * æ£€æŸ¥å¯†ç å¼ºåº¦
     */
    private boolean isPasswordStrong(String password) {
        // è‡³å°‘8ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦
        return password.length() >= 8 &&
               password.matches(".*[a-z].*") &&
               password.matches(".*[A-Z].*") &&
               password.matches(".*[0-9].*") &&
               password.matches(".*[!@#$%^&*()_+\\-=\\[\\]{};':\"\\\\|,.<>\\/?].*");
    }
}
```

#### å®ä½“ç±»è§„èŒƒ
```java
/**
 * ç”¨æˆ·å®ä½“
 */
@Entity
@Table(name = "users")
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@EqualsAndHashCode(callSuper = false)
public class User extends BaseEntity {

    /**
     * ç”¨æˆ·ID
     */
    @Id
    @Column(name = "id", length = 32)
    private String id;

    /**
     * ç”¨æˆ·å
     */
    @Column(name = "username", length = 50, nullable = false, unique = true)
    @NotBlank(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    @Size(min = 3, max = 20, message = "ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-20ä¸ªå­—ç¬¦ä¹‹é—´")
    @Pattern(regexp = "^[a-zA-Z0-9_]+$", message = "ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿")
    private String username;

    /**
     * é‚®ç®±
     */
    @Column(name = "email", length = 100, nullable = false, unique = true)
    @NotBlank(message = "é‚®ç®±ä¸èƒ½ä¸ºç©º")
    @Email(message = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    private String email;

    /**
     * å¯†ç å“ˆå¸Œ
     */
    @Column(name = "password_hash", nullable = false)
    @NotBlank(message = "å¯†ç ä¸èƒ½ä¸ºç©º")
    @JsonIgnore
    private String passwordHash;

    /**
     * æ˜µç§°
     */
    @Column(name = "nickname", length = 100)
    @Size(max = 50, message = "æ˜µç§°ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦")
    private String nickname;

    /**
     * å¤´åƒURL
     */
    @Column(name = "avatar_url")
    @URL(message = "å¤´åƒURLæ ¼å¼ä¸æ­£ç¡®")
    private String avatarUrl;

    /**
     * ç”¨æˆ·çŠ¶æ€
     */
    @Enumerated(EnumType.STRING)
    @Column(name = "status", nullable = false)
    @NotNull(message = "ç”¨æˆ·çŠ¶æ€ä¸èƒ½ä¸ºç©º")
    private UserStatus status;

    /**
     * æœ€åç™»å½•æ—¶é—´
     */
    @Column(name = "last_login_at")
    private LocalDateTime lastLoginAt;

    // å®ä½“æ–¹æ³•
    
    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ¿€æ´»
     */
    public boolean isActive() {
        return status == UserStatus.ACTIVE;
    }

    /**
     * æ›´æ–°æœ€åç™»å½•æ—¶é—´
     */
    public void updateLastLoginTime() {
        this.lastLoginAt = LocalDateTime.now();
        this.setUpdatedAt(LocalDateTime.now());
    }

    /**
     * ç¦ç”¨ç”¨æˆ·
     */
    public void disable() {
        this.status = UserStatus.INACTIVE;
        this.setUpdatedAt(LocalDateTime.now());
    }
}

/**
 * ç”¨æˆ·çŠ¶æ€æšä¸¾
 */
public enum UserStatus {
    /**
     * æ¿€æ´»çŠ¶æ€
     */
    ACTIVE("active", "æ¿€æ´»"),
    
    /**
     * éæ¿€æ´»çŠ¶æ€
     */
    INACTIVE("inactive", "éæ¿€æ´»"),
    
    /**
     * æš‚åœçŠ¶æ€
     */
    SUSPENDED("suspended", "æš‚åœ");

    private final String code;
    private final String description;

    UserStatus(String code, String description) {
        this.code = code;
        this.description = description;
    }

    public String getCode() {
        return code;
    }

    public String getDescription() {
        return description;
    }
}
```

### 2. å¼‚å¸¸å¤„ç†è§„èŒƒ

#### å…¨å±€å¼‚å¸¸å¤„ç†å™¨
```java
/**
 * å…¨å±€å¼‚å¸¸å¤„ç†å™¨
 */
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {

    /**
     * ä¸šåŠ¡å¼‚å¸¸å¤„ç†
     */
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<ErrorResponse> handleBusinessException(BusinessException e) {
        log.warn("ä¸šåŠ¡å¼‚å¸¸: {}", e.getMessage());
        
        ErrorResponse response = ErrorResponse.builder()
            .code(e.getErrorCode().getCode())
            .message(e.getMessage())
            .timestamp(System.currentTimeMillis())
            .build();
            
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
    }

    /**
     * èµ„æºä¸å­˜åœ¨å¼‚å¸¸å¤„ç†
     */
    @ExceptionHandler(ResourceNotFoundException.class)
    public ResponseEntity<ErrorResponse> handleResourceNotFoundException(ResourceNotFoundException e) {
        log.warn("èµ„æºä¸å­˜åœ¨: {}", e.getMessage());
        
        ErrorResponse response = ErrorResponse.builder()
            .code(ErrorCode.RESOURCE_NOT_FOUND.getCode())
            .message(e.getMessage())
            .timestamp(System.currentTimeMillis())
            .build();
            
        return ResponseEntity.status(HttpStatus.NOT_FOUND).body(response);
    }

    /**
     * å‚æ•°éªŒè¯å¼‚å¸¸å¤„ç†
     */
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ErrorResponse> handleValidationException(MethodArgumentNotValidException e) {
        log.warn("å‚æ•°éªŒè¯å¤±è´¥: {}", e.getMessage());
        
        List<String> errors = e.getBindingResult()
            .getFieldErrors()
            .stream()
            .map(FieldError::getDefaultMessage)
            .collect(Collectors.toList());
            
        ErrorResponse response = ErrorResponse.builder()
            .code(ErrorCode.VALIDATION_FAILED.getCode())
            .message("å‚æ•°éªŒè¯å¤±è´¥")
            .details(errors)
            .timestamp(System.currentTimeMillis())
            .build();
            
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
    }

    /**
     * ç³»ç»Ÿå¼‚å¸¸å¤„ç†
     */
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ErrorResponse> handleSystemException(Exception e) {
        log.error("ç³»ç»Ÿå¼‚å¸¸", e);
        
        ErrorResponse response = ErrorResponse.builder()
            .code(ErrorCode.SYSTEM_ERROR.getCode())
            .message("ç³»ç»Ÿå†…éƒ¨é”™è¯¯")
            .timestamp(System.currentTimeMillis())
            .build();
            
        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(response);
    }
}

/**
 * ä¸šåŠ¡å¼‚å¸¸
 */
public class BusinessException extends RuntimeException {
    
    private final ErrorCode errorCode;
    
    public BusinessException(ErrorCode errorCode) {
        super(errorCode.getMessage());
        this.errorCode = errorCode;
    }
    
    public BusinessException(ErrorCode errorCode, String message) {
        super(message);
        this.errorCode = errorCode;
    }
    
    public ErrorCode getErrorCode() {
        return errorCode;
    }
}

/**
 * é”™è¯¯ç æšä¸¾
 */
@Getter
public enum ErrorCode {
    
    // é€šç”¨é”™è¯¯
    SUCCESS(200, "æ“ä½œæˆåŠŸ"),
    SYSTEM_ERROR(500, "ç³»ç»Ÿå†…éƒ¨é”™è¯¯"),
    VALIDATION_FAILED(400, "å‚æ•°éªŒè¯å¤±è´¥"),
    RESOURCE_NOT_FOUND(404, "èµ„æºä¸å­˜åœ¨"),
    UNAUTHORIZED(401, "æœªæˆæƒè®¿é—®"),
    FORBIDDEN(403, "æ— æƒé™è®¿é—®"),
    
    // ç”¨æˆ·ç›¸å…³é”™è¯¯
    USERNAME_ALREADY_EXISTS(10001, "ç”¨æˆ·åå·²å­˜åœ¨"),
    EMAIL_ALREADY_EXISTS(10002, "é‚®ç®±å·²å­˜åœ¨"),
    INVALID_USERNAME_FORMAT(10003, "ç”¨æˆ·åæ ¼å¼ä¸æ­£ç¡®"),
    INVALID_EMAIL_FORMAT(10004, "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®"),
    WEAK_PASSWORD(10005, "å¯†ç å¼ºåº¦ä¸è¶³"),
    USER_NOT_FOUND(10006, "ç”¨æˆ·ä¸å­˜åœ¨"),
    USER_DISABLED(10007, "ç”¨æˆ·å·²è¢«ç¦ç”¨"),
    
    // è®¤è¯ç›¸å…³é”™è¯¯
    INVALID_CREDENTIALS(20001, "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"),
    TOKEN_EXPIRED(20002, "ç™»å½•å·²è¿‡æœŸ"),
    TOKEN_INVALID(20003, "æ— æ•ˆçš„ç™»å½•å‡­è¯"),
    
    // é¡¹ç›®ç›¸å…³é”™è¯¯
    PROJECT_NOT_FOUND(30001, "é¡¹ç›®ä¸å­˜åœ¨"),
    PROJECT_ACCESS_DENIED(30002, "æ— é¡¹ç›®è®¿é—®æƒé™"),
    PROJECT_NAME_EXISTS(30003, "é¡¹ç›®åç§°å·²å­˜åœ¨");
    
    private final int code;
    private final String message;
    
    ErrorCode(int code, String message) {
        this.code = code;
        this.message = message;
    }
}
```

### 3. é…ç½®ç±»è§„èŒƒ

#### æ•°æ®åº“é…ç½®
```java
/**
 * æ•°æ®åº“é…ç½®
 */
@Configuration
@EnableJpaRepositories(basePackages = "com.codivio.userservice.repository")
@EnableTransactionManagement
@Slf4j
public class DatabaseConfig {

    @Value("${spring.datasource.url}")
    private String datasourceUrl;

    @Bean
    @Primary
    @ConfigurationProperties("spring.datasource.hikari")
    public HikariDataSource dataSource() {
        log.info("åˆå§‹åŒ–æ•°æ®æºï¼ŒURL: {}", datasourceUrl);
        return DataSourceBuilder.create()
            .type(HikariDataSource.class)
            .build();
    }

    @Bean
    public JpaTransactionManager transactionManager(EntityManagerFactory entityManagerFactory) {
        return new JpaTransactionManager(entityManagerFactory);
    }

    /**
     * å®¡è®¡é…ç½®
     */
    @Bean
    public AuditorAware<String> auditorProvider() {
        return () -> {
            // ä»SecurityContextè·å–å½“å‰ç”¨æˆ·
            Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
            if (authentication != null && authentication.isAuthenticated()) {
                return Optional.of(authentication.getName());
            }
            return Optional.of("system");
        };
    }
}
```

#### Redisé…ç½®
```java
/**
 * Redisé…ç½®
 */
@Configuration
@EnableCaching
@Slf4j
public class RedisConfig {

    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory connectionFactory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(connectionFactory);

        // ä½¿ç”¨Jackson2JsonRedisSerializeræ¥åºåˆ—åŒ–å’Œååºåˆ—åŒ–value
        Jackson2JsonRedisSerializer<Object> serializer = new Jackson2JsonRedisSerializer<>(Object.class);
        ObjectMapper mapper = new ObjectMapper();
        mapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);
        mapper.activateDefaultTyping(LaissezFaireSubTypeValidator.instance, ObjectMapper.DefaultTyping.NON_FINAL);
        serializer.setObjectMapper(mapper);

        // è®¾ç½®åºåˆ—åŒ–å™¨
        template.setValueSerializer(serializer);
        template.setHashValueSerializer(serializer);
        template.setKeySerializer(new StringRedisSerializer());
        template.setHashKeySerializer(new StringRedisSerializer());

        template.afterPropertiesSet();
        
        log.info("Redisæ¨¡æ¿é…ç½®å®Œæˆ");
        return template;
    }

    /**
     * ç¼“å­˜ç®¡ç†å™¨
     */
    @Bean
    public CacheManager cacheManager(RedisConnectionFactory connectionFactory) {
        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofHours(1))
            .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(new StringRedisSerializer()))
            .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(new GenericJackson2JsonRedisSerializer()));

        return RedisCacheManager.builder(connectionFactory)
            .cacheDefaults(config)
            .build();
    }
}
```

---

## ğŸ“Š æ•°æ®åº“è§„èŒƒ

### 1. è¡¨è®¾è®¡è§„èŒƒ

#### å‘½åè§„èŒƒ
```sql
-- âœ… è¡¨å‘½åï¼šå°å†™å­—æ¯+ä¸‹åˆ’çº¿
CREATE TABLE users (
    id VARCHAR(32) PRIMARY KEY COMMENT 'ç”¨æˆ·ID',
    username VARCHAR(50) NOT NULL UNIQUE COMMENT 'ç”¨æˆ·å',
    email VARCHAR(100) NOT NULL UNIQUE COMMENT 'é‚®ç®±',
    password_hash VARCHAR(255) NOT NULL COMMENT 'å¯†ç å“ˆå¸Œ',
    nickname VARCHAR(100) COMMENT 'æ˜µç§°',
    avatar_url VARCHAR(255) COMMENT 'å¤´åƒåœ°å€',
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€: 0-ç¦ç”¨, 1-æ­£å¸¸',
    last_login_at TIMESTAMP NULL COMMENT 'æœ€åç™»å½•æ—¶é—´',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
) COMMENT 'ç”¨æˆ·è¡¨';

-- âœ… å¤–é”®å…³ç³»è¡¨
CREATE TABLE project_members (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    project_id VARCHAR(32) NOT NULL COMMENT 'é¡¹ç›®ID',
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    role ENUM('owner', 'editor', 'viewer') DEFAULT 'editor' COMMENT 'è§’è‰²',
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åŠ å…¥æ—¶é—´',
    
    UNIQUE KEY uk_project_user (project_id, user_id),
    INDEX idx_project_id (project_id),
    INDEX idx_user_id (user_id),
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) COMMENT 'é¡¹ç›®æˆå‘˜è¡¨';
```

#### å­—æ®µè®¾è®¡è§„èŒƒ
```sql
-- âœ… å­—æ®µç±»å‹é€‰æ‹©è§„èŒƒ
CREATE TABLE example_table (
    -- ä¸»é”®ï¼šå­—ç¬¦ä¸²IDä½¿ç”¨VARCHAR(32)ï¼Œæ•°å­—IDä½¿ç”¨BIGINT
    id VARCHAR(32) PRIMARY KEY,
    
    -- çŠ¶æ€å­—æ®µï¼šä½¿ç”¨TINYINTï¼Œæ˜ç¡®æ³¨é‡Šæ¯ä¸ªå€¼çš„å«ä¹‰
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€: 0-åˆ é™¤, 1-æ­£å¸¸, 2-ç¦ç”¨',
    
    -- æšä¸¾å­—æ®µï¼šä½¿ç”¨ENUMæˆ–VARCHARï¼Œæ˜ç¡®å¯é€‰å€¼
    priority ENUM('low', 'medium', 'high') DEFAULT 'medium',
    
    -- æ—¶é—´å­—æ®µï¼šç»Ÿä¸€ä½¿ç”¨TIMESTAMPï¼Œè®¾ç½®é»˜è®¤å€¼å’Œæ›´æ–°ç­–ç•¥
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    -- æ–‡æœ¬å­—æ®µï¼šæ ¹æ®é•¿åº¦é€‰æ‹©åˆé€‚ç±»å‹
    title VARCHAR(255) NOT NULL COMMENT 'æ ‡é¢˜ï¼ˆæœ€å¤š255å­—ç¬¦ï¼‰',
    description TEXT COMMENT 'æè¿°ï¼ˆé•¿æ–‡æœ¬ï¼‰',
    content LONGTEXT COMMENT 'å†…å®¹ï¼ˆè¶…é•¿æ–‡æœ¬ï¼‰',
    
    -- æ•°å€¼å­—æ®µï¼šæ˜ç¡®ç²¾åº¦å’ŒèŒƒå›´
    amount DECIMAL(10,2) COMMENT 'é‡‘é¢ï¼ˆç²¾ç¡®åˆ°åˆ†ï¼‰',
    count INT UNSIGNED DEFAULT 0 COMMENT 'è®¡æ•°ï¼ˆéè´Ÿæ•´æ•°ï¼‰',
    
    -- JSONå­—æ®µï¼šå­˜å‚¨ç»“æ„åŒ–æ•°æ®
    metadata JSON COMMENT 'å…ƒæ•°æ®',
    
    -- ç‰ˆæœ¬å­—æ®µï¼šç”¨äºä¹è§‚é”
    version INT DEFAULT 1 COMMENT 'ç‰ˆæœ¬å·'
) COMMENT 'ç¤ºä¾‹è¡¨';
```

### 2. ç´¢å¼•è®¾è®¡è§„èŒƒ

#### ç´¢å¼•ç­–ç•¥
```sql
-- âœ… å•åˆ—ç´¢å¼•
CREATE INDEX idx_user_email ON users(email);
CREATE INDEX idx_user_status ON users(status);
CREATE INDEX idx_created_at ON users(created_at);

-- âœ… å¤åˆç´¢å¼•ï¼ˆæ³¨æ„å­—æ®µé¡ºåºï¼‰
-- æœ€å¸¸ç”¨çš„æŸ¥è¯¢æ¡ä»¶åœ¨å‰
CREATE INDEX idx_project_status_created ON projects(status, created_at);
CREATE INDEX idx_user_status_type ON users(status, user_type, created_at);

-- âœ… å”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX uk_user_username ON users(username);
CREATE UNIQUE INDEX uk_project_name_owner ON projects(name, owner_id);

-- âœ… å‰ç¼€ç´¢å¼•ï¼ˆç”¨äºé•¿å­—ç¬¦ä¸²å­—æ®µï¼‰
CREATE INDEX idx_file_path_prefix ON project_files(file_path(100));

-- âœ… å‡½æ•°ç´¢å¼•ï¼ˆMySQL 8.0+ï¼‰
CREATE INDEX idx_user_email_lower ON users((LOWER(email)));

-- âŒ é¿å…çš„ç´¢å¼•è®¾è®¡
-- é¿å…åœ¨å°è¡¨ä¸Šåˆ›å»ºè¿‡å¤šç´¢å¼•
-- é¿å…åœ¨ç»å¸¸æ›´æ–°çš„å­—æ®µä¸Šåˆ›å»ºç´¢å¼•
-- é¿å…åœ¨é€‰æ‹©æ€§å·®çš„å­—æ®µä¸Šåˆ›å»ºç´¢å¼•ï¼ˆå¦‚æ€§åˆ«å­—æ®µï¼‰
```

### 3. SQLç¼–å†™è§„èŒƒ

#### æŸ¥è¯¢ä¼˜åŒ–è§„èŒƒ
```sql
-- âœ… æ¨èçš„æŸ¥è¯¢å†™æ³•
-- ä½¿ç”¨æ˜ç¡®çš„å­—æ®µåˆ—è¡¨ï¼Œé¿å…SELECT *
SELECT u.id, u.username, u.email, u.created_at
FROM users u
WHERE u.status = 1
  AND u.created_at >= '2024-01-01'
ORDER BY u.created_at DESC
LIMIT 10;

-- âœ… ä½¿ç”¨é€‚å½“çš„JOIN
SELECT 
    p.id,
    p.name,
    u.username AS owner_name,
    COUNT(pm.user_id) AS member_count
FROM projects p
INNER JOIN users u ON p.owner_id = u.id
LEFT JOIN project_members pm ON p.id = pm.project_id
WHERE p.status = 1
GROUP BY p.id, p.name, u.username
HAVING member_count > 0
ORDER BY p.created_at DESC;

-- âœ… ä½¿ç”¨EXISTSè€Œä¸æ˜¯INï¼ˆå½“å­æŸ¥è¯¢è¿”å›å¤§é‡æ•°æ®æ—¶ï¼‰
SELECT u.id, u.username
FROM users u
WHERE EXISTS (
    SELECT 1 
    FROM project_members pm 
    WHERE pm.user_id = u.id
);

-- âœ… ä½¿ç”¨UNION ALLè€Œä¸æ˜¯UNIONï¼ˆå½“ä¸éœ€è¦å»é‡æ—¶ï¼‰
SELECT 'user' AS type, id, username AS name FROM users
UNION ALL
SELECT 'project' AS type, id, name FROM projects;

-- âŒ é¿å…çš„æŸ¥è¯¢å†™æ³•
-- é¿å…SELECT *
SELECT * FROM users;

-- é¿å…ä¸å¿…è¦çš„å­æŸ¥è¯¢
SELECT u.* FROM users u
WHERE u.id IN (
    SELECT DISTINCT pm.user_id 
    FROM project_members pm
);

-- é¿å…åœ¨WHEREå­å¥ä¸­ä½¿ç”¨å‡½æ•°
SELECT * FROM users 
WHERE YEAR(created_at) = 2024;  -- åº”è¯¥ä½¿ç”¨èŒƒå›´æŸ¥è¯¢

-- æ­£ç¡®å†™æ³•
SELECT * FROM users 
WHERE created_at >= '2024-01-01' 
  AND created_at < '2025-01-01';
```

---

## ğŸ”’ å®‰å…¨è§„èŒƒ

### 1. è®¤è¯æˆæƒè§„èŒƒ

#### JWTå®ç°è§„èŒƒ
```java
/**
 * JWTå·¥å…·ç±»
 */
@Component
@Slf4j
public class JwtUtil {

    @Value("${jwt.secret}")
    private String secret;

    @Value("${jwt.expiration:86400}")
    private Long expiration;

    /**
     * ç”ŸæˆJWT Token
     */
    public String generateToken(UserDetails userDetails) {
        Map<String, Object> claims = new HashMap<>();
        claims.put("userId", userDetails.getUserId());
        claims.put("username", userDetails.getUsername());
        claims.put("authorities", userDetails.getAuthorities());
        
        return createToken(claims, userDetails.getUsername());
    }

    /**
     * åˆ›å»ºToken
     */
    private String createToken(Map<String, Object> claims, String subject) {
        Date now = new Date();
        Date expiryDate = new Date(now.getTime() + expiration * 1000);

        return Jwts.builder()
            .setClaims(claims)
            .setSubject(subject)
            .setIssuedAt(now)
            .setExpiration(expiryDate)
            .signWith(SignatureAlgorithm.HS256, secret)
            .compact();
    }

    /**
     * éªŒè¯Token
     */
    public boolean validateToken(String token) {
        try {
            // æ£€æŸ¥æ˜¯å¦åœ¨é»‘åå•ä¸­
            if (isTokenBlacklisted(token)) {
                return false;
            }
            
            Jwts.parser().setSigningKey(secret).parseClaimsJws(token);
            return true;
        } catch (JwtException | IllegalArgumentException e) {
            log.warn("JWTéªŒè¯å¤±è´¥: {}", e.getMessage());
            return false;
        }
    }

    /**
     * æ£€æŸ¥Tokenæ˜¯å¦åœ¨é»‘åå•ä¸­
     */
    private boolean isTokenBlacklisted(String token) {
        String tokenId = getTokenId(token);
        return redisTemplate.hasKey("jwt:blacklist:" + tokenId);
    }

    /**
     * å°†TokenåŠ å…¥é»‘åå•
     */
    public void blacklistToken(String token) {
        String tokenId = getTokenId(token);
        Date expiration = getExpirationDateFromToken(token);
        
        if (expiration.after(new Date())) {
            Duration ttl = Duration.between(Instant.now(), expiration.toInstant());
            redisTemplate.opsForValue().set("jwt:blacklist:" + tokenId, true, ttl);
        }
    }
}
```

#### æƒé™æ§åˆ¶è§„èŒƒ
```java
/**
 * å®‰å…¨é…ç½®
 */
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class SecurityConfig {

    private final JwtAuthenticationEntryPoint jwtAuthenticationEntryPoint;
    private final JwtRequestFilter jwtRequestFilter;

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder(12);
    }

    @Bean
    public AuthenticationManager authenticationManager(
            AuthenticationConfiguration authConfig) throws Exception {
        return authConfig.getAuthenticationManager();
    }

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.csrf().disable()
            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            .and()
            .authorizeHttpRequests(authz -> authz
                // å…¬å¼€ç«¯ç‚¹
                .requestMatchers("/api/v1/auth/**").permitAll()
                .requestMatchers("/actuator/health").permitAll()
                .requestMatchers("/swagger-ui/**", "/v3/api-docs/**").permitAll()
                
                // éœ€è¦è®¤è¯çš„ç«¯ç‚¹
                .requestMatchers(HttpMethod.GET, "/api/v1/users/me").authenticated()
                .requestMatchers(HttpMethod.PUT, "/api/v1/users/me").authenticated()
                
                // éœ€è¦ç‰¹å®šæƒé™çš„ç«¯ç‚¹
                .requestMatchers(HttpMethod.POST, "/api/v1/users").hasRole("ADMIN")
                .requestMatchers(HttpMethod.DELETE, "/api/v1/users/**").hasRole("ADMIN")
                
                // å…¶ä»–è¯·æ±‚éƒ½éœ€è¦è®¤è¯
                .anyRequest().authenticated()
            )
            .exceptionHandling()
                .authenticationEntryPoint(jwtAuthenticationEntryPoint)
            .and()
            .addFilterBefore(jwtRequestFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }
}

/**
 * æƒé™æ³¨è§£ä½¿ç”¨ç¤ºä¾‹
 */
@Service
public class ProjectService {

    @PreAuthorize("hasRole('ADMIN') or @projectService.isOwner(#projectId, authentication.name)")
    public void deleteProject(String projectId) {
        // åˆ é™¤é¡¹ç›®é€»è¾‘
    }

    @PreAuthorize("@projectService.hasAccess(#projectId, authentication.name, 'READ')")
    public Project getProject(String projectId) {
        // è·å–é¡¹ç›®é€»è¾‘
    }

    @PostAuthorize("@projectService.filterSensitiveData(returnObject, authentication.name)")
    public Project getProjectWithSensitiveData(String projectId) {
        // è·å–åŒ…å«æ•æ„Ÿæ•°æ®çš„é¡¹ç›®ä¿¡æ¯
    }

    public boolean isOwner(String projectId, String username) {
        // æ£€æŸ¥æ˜¯å¦ä¸ºé¡¹ç›®æ‰€æœ‰è€…
    }

    public boolean hasAccess(String projectId, String username, String permission) {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ç‰¹å®šæƒé™
    }
}
```

### 2. è¾“å…¥éªŒè¯è§„èŒƒ

#### å‚æ•°éªŒè¯
```java
/**
 * è¯·æ±‚å‚æ•°éªŒè¯
 */
@Data
@Valid
public class CreateUserRequest {

    @NotBlank(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    @Size(min = 3, max = 20, message = "ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-20ä¸ªå­—ç¬¦ä¹‹é—´")
    @Pattern(regexp = "^[a-zA-Z0-9_]+$", message = "ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿")
    private String username;

    @NotBlank(message = "é‚®ç®±ä¸èƒ½ä¸ºç©º")
    @Email(message = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    @Size(max = 100, message = "é‚®ç®±é•¿åº¦ä¸èƒ½è¶…è¿‡100ä¸ªå­—ç¬¦")
    private String email;

    @NotBlank(message = "å¯†ç ä¸èƒ½ä¸ºç©º")
    @Size(min = 8, max = 50, message = "å¯†ç é•¿åº¦å¿…é¡»åœ¨8-50ä¸ªå­—ç¬¦ä¹‹é—´")
    @Pattern(
        regexp = "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&])[A-Za-z\\d@$!%*?&]+$",
        message = "å¯†ç å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªå¤§å†™å­—æ¯ã€ä¸€ä¸ªå°å†™å­—æ¯ã€ä¸€ä¸ªæ•°å­—å’Œä¸€ä¸ªç‰¹æ®Šå­—ç¬¦"
    )
    private String password;

    @Size(max = 50, message = "æ˜µç§°ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦")
    @Pattern(regexp = "^[\\u4e00-\\u9fa5a-zA-Z0-9_\\s]*$", message = "æ˜µç§°åªèƒ½åŒ…å«ä¸­æ–‡ã€å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œç©ºæ ¼")
    private String nickname;

    @URL(message = "å¤´åƒURLæ ¼å¼ä¸æ­£ç¡®")
    private String avatarUrl;

    /**
     * è‡ªå®šä¹‰éªŒè¯æ–¹æ³•
     */
    @AssertTrue(message = "ç”¨æˆ·åä¸èƒ½ä¸æ˜µç§°ç›¸åŒ")
    public boolean isUsernameAndNicknameDifferent() {
        if (nickname == null || nickname.trim().isEmpty()) {
            return true;
        }
        return !username.equals(nickname.trim());
    }
}

/**
 * è‡ªå®šä¹‰éªŒè¯æ³¨è§£
 */
@Target({ElementType.FIELD})
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = StrongPasswordValidator.class)
@Documented
public @interface StrongPassword {
    String message() default "å¯†ç å¼ºåº¦ä¸è¶³";
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};
}

/**
 * å¯†ç å¼ºåº¦éªŒè¯å™¨
 */
public class StrongPasswordValidator implements ConstraintValidator<StrongPassword, String> {

    @Override
    public boolean isValid(String password, ConstraintValidatorContext context) {
        if (password == null) {
            return false;
        }

        // æ£€æŸ¥å¯†ç é•¿åº¦
        if (password.length() < 8) {
            return false;
        }

        // æ£€æŸ¥æ˜¯å¦åŒ…å«å¤§å†™å­—æ¯
        if (!password.matches(".*[A-Z].*")) {
            return false;
        }

        // æ£€æŸ¥æ˜¯å¦åŒ…å«å°å†™å­—æ¯
        if (!password.matches(".*[a-z].*")) {
            return false;
        }

        // æ£€æŸ¥æ˜¯å¦åŒ…å«æ•°å­—
        if (!password.matches(".*[0-9].*")) {
            return false;
        }

        // æ£€æŸ¥æ˜¯å¦åŒ…å«ç‰¹æ®Šå­—ç¬¦
        if (!password.matches(".*[!@#$%^&*()_+\\-=\\[\\]{};':\"\\\\|,.<>\\/?].*")) {
            return false;
        }

        // æ£€æŸ¥æ˜¯å¦åŒ…å«å¸¸è§å¼±å¯†ç 
        String[] weakPasswords = {"password", "123456", "qwerty", "admin"};
        String lowerPassword = password.toLowerCase();
        for (String weak : weakPasswords) {
            if (lowerPassword.contains(weak)) {
                return false;
            }
        }

        return true;
    }
}
```

### 3. SQLæ³¨å…¥é˜²æŠ¤

#### MyBatiså®‰å…¨ä½¿ç”¨
```xml
<!-- âœ… æ¨èï¼šä½¿ç”¨#{}å‚æ•°ç»‘å®šé˜²æ­¢SQLæ³¨å…¥ -->
<select id="findUsersByCondition" resultType="User">
    SELECT id, username, email, created_at
    FROM users
    WHERE status = #{status}
    <if test="keyword != null and keyword != ''">
        AND (username LIKE CONCAT('%', #{keyword}, '%') 
             OR email LIKE CONCAT('%', #{keyword}, '%'))
    </if>
    <if test="startDate != null">
        AND created_at >= #{startDate}
    </if>
    <if test="endDate != null">
        AND created_at &lt;= #{endDate}
    </if>
    ORDER BY 
    <choose>
        <when test="sortField == 'username'">username</when>
        <when test="sortField == 'email'">email</when>
        <when test="sortField == 'created_at'">created_at</when>
        <otherwise>id</otherwise>
    </choose>
    <if test="sortOrder == 'desc'">DESC</if>
    LIMIT #{offset}, #{limit}
</select>

<!-- âŒ å±é™©ï¼šä½¿ç”¨${}å®¹æ˜“å¯¼è‡´SQLæ³¨å…¥ -->
<select id="badExample" resultType="User">
    SELECT * FROM users 
    WHERE username = '${username}'  <!-- å±é™©ï¼ -->
    ORDER BY ${sortField}           <!-- å±é™©ï¼ -->
</select>

<!-- âœ… å¦‚æœå¿…é¡»ä½¿ç”¨${}ï¼Œç¡®ä¿å‚æ•°ç»è¿‡ä¸¥æ ¼éªŒè¯ -->
<select id="dynamicOrderBy" resultType="User">
    SELECT id, username, email 
    FROM users 
    WHERE status = #{status}
    ORDER BY 
    <choose>
        <when test="sortField == 'username'">username</when>
        <when test="sortField == 'email'">email</when>
        <when test="sortField == 'created_at'">created_at</when>
        <otherwise>id</otherwise>
    </choose>
    ${sortOrder}  <!-- ä»…åœ¨ä¸¥æ ¼éªŒè¯åä½¿ç”¨ -->
</select>
```

---

## ğŸ“‹ æ—¥å¿—è§„èŒƒ

### 1. æ—¥å¿—çº§åˆ«ä½¿ç”¨

#### æ—¥å¿—çº§åˆ«å®šä¹‰
```java
/**
 * æ—¥å¿—ä½¿ç”¨ç¤ºä¾‹
 */
@Service
@Slf4j
public class UserService {

    /**
     * ERRORï¼šè®°å½•é”™è¯¯ä¿¡æ¯ï¼Œéœ€è¦ç«‹å³å…³æ³¨
     */
    public User createUser(CreateUserRequest request) {
        try {
            // ä¸šåŠ¡é€»è¾‘
            return userRepository.save(user);
        } catch (DataIntegrityViolationException e) {
            log.error("åˆ›å»ºç”¨æˆ·å¤±è´¥ï¼Œæ•°æ®å®Œæ•´æ€§é”™è¯¯: {}, è¯·æ±‚: {}", e.getMessage(), request, e);
            throw new BusinessException(ErrorCode.USER_CREATION_FAILED);
        } catch (Exception e) {
            log.error("åˆ›å»ºç”¨æˆ·æ—¶å‘ç”ŸæœªçŸ¥é”™è¯¯: {}", e.getMessage(), e);
            throw new SystemException("ç”¨æˆ·åˆ›å»ºå¤±è´¥");
        }
    }

    /**
     * WARNï¼šè®°å½•è­¦å‘Šä¿¡æ¯ï¼Œå¯èƒ½çš„é—®é¢˜
     */
    public void updateUserLastLogin(String userId) {
        try {
            User user = userRepository.findById(userId).orElse(null);
            if (user == null) {
                log.warn("æ›´æ–°æœ€åç™»å½•æ—¶é—´å¤±è´¥ï¼Œç”¨æˆ·ä¸å­˜åœ¨: {}", userId);
                return;
            }
            
            if (user.getStatus() == UserStatus.INACTIVE) {
                log.warn("éæ´»è·ƒç”¨æˆ·å°è¯•ç™»å½•: {}", userId);
            }
            
            user.updateLastLoginTime();
            userRepository.save(user);
        } catch (Exception e) {
            log.warn("æ›´æ–°ç”¨æˆ·æœ€åç™»å½•æ—¶é—´å¤±è´¥: {}, é”™è¯¯: {}", userId, e.getMessage());
        }
    }

    /**
     * INFOï¼šè®°å½•é‡è¦çš„ä¸šåŠ¡æµç¨‹ä¿¡æ¯
     */
    public void deleteUser(String userId) {
        log.info("å¼€å§‹åˆ é™¤ç”¨æˆ·: {}", userId);
        
        User user = getUserById(userId);
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰å…³è”æ•°æ®
        long projectCount = projectRepository.countByOwnerId(userId);
        if (projectCount > 0) {
            log.info("ç”¨æˆ·{}æ‹¥æœ‰{}ä¸ªé¡¹ç›®ï¼Œéœ€è¦å…ˆå¤„ç†å…³è”æ•°æ®", userId, projectCount);
            throw new BusinessException(ErrorCode.USER_HAS_ASSOCIATED_DATA);
        }
        
        userRepository.delete(user);
        
        // æ¸…é™¤ç¼“å­˜
        cacheManager.evict("users", userId);
        
        log.info("ç”¨æˆ·åˆ é™¤æˆåŠŸ: {}", userId);
    }

    /**
     * DEBUGï¼šè®°å½•è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
     */
    public List<User> searchUsers(UserSearchCriteria criteria) {
        log.debug("æœç´¢ç”¨æˆ·ï¼Œæ¡ä»¶: {}", criteria);
        
        Specification<User> spec = UserSpecifications.build(criteria);
        log.debug("æ„å»ºçš„æŸ¥è¯¢è§„æ ¼: {}", spec);
        
        List<User> users = userRepository.findAll(spec);
        log.debug("æœç´¢ç»“æœæ•°é‡: {}", users.size());
        
        return users;
    }

    /**
     * TRACEï¼šè®°å½•æœ€è¯¦ç»†çš„æ‰§è¡Œè½¨è¿¹
     */
    @Cacheable(value = "users", key = "#userId")
    public User getUserById(String userId) {
        log.trace("è¿›å…¥getUserByIdæ–¹æ³•ï¼Œå‚æ•°: {}", userId);
        
        if (userId == null || userId.trim().isEmpty()) {
            log.trace("ç”¨æˆ·IDä¸ºç©ºï¼ŒæŠ›å‡ºå‚æ•°å¼‚å¸¸");
            throw new IllegalArgumentException("ç”¨æˆ·IDä¸èƒ½ä¸ºç©º");
        }
        
        log.trace("ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·: {}", userId);
        Optional<User> userOpt = userRepository.findById(userId);
        
        if (userOpt.isPresent()) {
            User user = userOpt.get();
            log.trace("ç”¨æˆ·æŸ¥è¯¢æˆåŠŸ: {}", user.getUsername());
            return user;
        } else {
            log.trace("ç”¨æˆ·ä¸å­˜åœ¨: {}", userId);
            throw new ResourceNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨: " + userId);
        }
    }
}
```

### 2. ç»“æ„åŒ–æ—¥å¿—

#### Logbacké…ç½®
```xml
<!-- logback-spring.xml -->
<configuration>
    <!-- å¼€å‘ç¯å¢ƒé…ç½® -->
    <springProfile name="dev">
        <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
            <encoder>
                <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%logger{36}:%line] - %msg%n</pattern>
            </encoder>
        </appender>
        
        <root level="DEBUG">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>

    <!-- ç”Ÿäº§ç¯å¢ƒé…ç½® -->
    <springProfile name="prod">
        <!-- JSONæ ¼å¼æ—¥å¿— -->
        <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
            <file>logs/application.log</file>
            <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
                <providers>
                    <timestamp/>
                    <logLevel/>
                    <loggerName/>
                    <message/>
                    <mdc/>
                    <pattern>
                        <pattern>
                            {
                                "service": "user-service",
                                "version": "@project.version@",
                                "environment": "${spring.profiles.active}",
                                "hostname": "${HOSTNAME:-unknown}",
                                "trace_id": "%X{traceId:-}",
                                "span_id": "%X{spanId:-}",
                                "user_id": "%X{userId:-}",
                                "request_id": "%X{requestId:-}"
                            }
                        </pattern>
                    </pattern>
                </providers>
            </encoder>
            
            <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
                <fileNamePattern>logs/application.%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
                <maxFileSize>100MB</maxFileSize>
                <maxHistory>30</maxHistory>
                <totalSizeCap>10GB</totalSizeCap>
            </rollingPolicy>
        </appender>

        <!-- é”™è¯¯æ—¥å¿—å•ç‹¬æ–‡ä»¶ -->
        <appender name="ERROR_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
            <file>logs/error.log</file>
            <filter class="ch.qos.logback.classic.filter.LevelFilter">
                <level>ERROR</level>
                <onMatch>ACCEPT</onMatch>
                <onMismatch>DENY</onMismatch>
            </filter>
            
            <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
                <providers>
                    <timestamp/>
                    <logLevel/>
                    <loggerName/>
                    <message/>
                    <stackTrace/>
                    <mdc/>
                </providers>
            </encoder>
            
            <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
                <fileNamePattern>logs/error.%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
                <maxFileSize>50MB</maxFileSize>
                <maxHistory>90</maxHistory>
            </rollingPolicy>
        </appender>

        <root level="INFO">
            <appender-ref ref="FILE"/>
            <appender-ref ref="ERROR_FILE"/>
        </root>
    </springProfile>

    <!-- ç‰¹å®šåŒ…çš„æ—¥å¿—çº§åˆ« -->
    <logger name="com.codivio" level="DEBUG" additivity="false">
        <appender-ref ref="FILE"/>
    </logger>
    
    <logger name="org.springframework.security" level="DEBUG"/>
    <logger name="org.springframework.web" level="DEBUG"/>
    <logger name="org.hibernate.SQL" level="DEBUG"/>
    <logger name="org.hibernate.type" level="TRACE"/>
</configuration>
```

### 3. æ“ä½œå®¡è®¡æ—¥å¿—

#### å®¡è®¡æ—¥å¿—å®ç°
```java
/**
 * æ“ä½œå®¡è®¡æ³¨è§£
 */
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface AuditLog {
    
    /**
     * æ“ä½œç±»å‹
     */
    String operation();
    
    /**
     * èµ„æºç±»å‹
     */
    String resourceType() default "";
    
    /**
     * æ˜¯å¦è®°å½•è¯·æ±‚å‚æ•°
     */
    boolean logParams() default true;
    
    /**
     * æ˜¯å¦è®°å½•å“åº”ç»“æœ
     */
    boolean logResult() default false;
    
    /**
     * æ•æ„Ÿå­—æ®µï¼ˆéœ€è¦è„±æ•ï¼‰
     */
    String[] sensitiveFields() default {"password", "token", "secret"};
}

/**
 * å®¡è®¡æ—¥å¿—åˆ‡é¢
 */
@Aspect
@Component
@Slf4j
public class AuditLogAspect {

    private final AuditLogService auditLogService;
    private final ObjectMapper objectMapper;

    @Around("@annotation(auditLog)")
    public Object around(ProceedingJoinPoint point, AuditLog auditLog) throws Throwable {
        String requestId = UUID.randomUUID().toString();
        String userId = getCurrentUserId();
        String username = getCurrentUsername();
        String ipAddress = getClientIpAddress();
        String userAgent = getCurrentUserAgent();
        
        // æ–¹æ³•ä¿¡æ¯
        String className = point.getTarget().getClass().getSimpleName();
        String methodName = point.getSignature().getName();
        String fullMethodName = className + "." + methodName;
        
        // è¯·æ±‚å‚æ•°
        Object[] args = point.getArgs();
        String requestParams = auditLog.logParams() ? 
            maskSensitiveData(objectMapper.writeValueAsString(args), auditLog.sensitiveFields()) : 
            null;
        
        Instant startTime = Instant.now();
        Object result = null;
        String errorMessage = null;
        boolean success = true;
        
        try {
            log.info("å¼€å§‹æ‰§è¡Œæ“ä½œ: {}, ç”¨æˆ·: {}, è¯·æ±‚ID: {}", auditLog.operation(), username, requestId);
            
            result = point.proceed();
            
            log.info("æ“ä½œæ‰§è¡ŒæˆåŠŸ: {}, ç”¨æˆ·: {}, è€—æ—¶: {}ms", 
                auditLog.operation(), username, 
                Duration.between(startTime, Instant.now()).toMillis());
            
            return result;
            
        } catch (Exception e) {
            success = false;
            errorMessage = e.getMessage();
            
            log.error("æ“ä½œæ‰§è¡Œå¤±è´¥: {}, ç”¨æˆ·: {}, é”™è¯¯: {}", 
                auditLog.operation(), username, e.getMessage(), e);
            
            throw e;
            
        } finally {
            // è®°å½•å®¡è®¡æ—¥å¿—
            try {
                AuditLogEntry entry = AuditLogEntry.builder()
                    .requestId(requestId)
                    .userId(userId)
                    .username(username)
                    .operation(auditLog.operation())
                    .resourceType(auditLog.resourceType())
                    .methodName(fullMethodName)
                    .requestParams(requestParams)
                    .responseData(auditLog.logResult() && success ? 
                        maskSensitiveData(objectMapper.writeValueAsString(result), auditLog.sensitiveFields()) : 
                        null)
                    .success(success)
                    .errorMessage(errorMessage)
                    .ipAddress(ipAddress)
                    .userAgent(userAgent)
                    .executionTime(Duration.between(startTime, Instant.now()).toMillis())
                    .timestamp(Instant.now())
                    .build();
                
                auditLogService.saveAuditLog(entry);
                
            } catch (Exception e) {
                log.error("ä¿å­˜å®¡è®¡æ—¥å¿—å¤±è´¥: {}", e.getMessage(), e);
            }
        }
    }

    /**
     * è„±æ•æ•æ„Ÿæ•°æ®
     */
    private String maskSensitiveData(String data, String[] sensitiveFields) {
        if (data == null || sensitiveFields.length == 0) {
            return data;
        }
        
        try {
            JsonNode jsonNode = objectMapper.readTree(data);
            maskJsonNode(jsonNode, sensitiveFields);
            return objectMapper.writeValueAsString(jsonNode);
        } catch (Exception e) {
            log.warn("æ•°æ®è„±æ•å¤±è´¥: {}", e.getMessage());
            return data;
        }
    }

    private void maskJsonNode(JsonNode node, String[] sensitiveFields) {
        if (node.isObject()) {
            ObjectNode objectNode = (ObjectNode) node;
            for (String field : sensitiveFields) {
                if (objectNode.has(field)) {
                    objectNode.put(field, "***");
                }
            }
            
            objectNode.fields().forEachRemaining(entry -> 
                maskJsonNode(entry.getValue(), sensitiveFields));
        } else if (node.isArray()) {
            for (JsonNode item : node) {
                maskJsonNode(item, sensitiveFields);
            }
        }
    }
}

/**
 * ä½¿ç”¨ç¤ºä¾‹
 */
@Service
public class UserService {

    @AuditLog(
        operation = "CREATE_USER",
        resourceType = "USER",
        logParams = true,
        logResult = true,
        sensitiveFields = {"password", "passwordHash"}
    )
    public UserDTO createUser(CreateUserRequest request) {
        // ä¸šåŠ¡é€»è¾‘
    }

    @AuditLog(
        operation = "DELETE_USER",
        resourceType = "USER",
        logParams = true
    )
    public void deleteUser(String userId) {
        // ä¸šåŠ¡é€»è¾‘
    }

    @AuditLog(
        operation = "LOGIN",
        resourceType = "AUTH",
        logParams = true,
        sensitiveFields = {"password"}
    )
    public LoginResponse login(LoginRequest request) {
        // ä¸šåŠ¡é€»è¾‘
    }
}
```

---

## ğŸ¯ æ€§èƒ½è§„èŒƒ

### 1. æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–

#### æŸ¥è¯¢ä¼˜åŒ–è§„èŒƒ
```java
/**
 * Repositoryæ€§èƒ½ä¼˜åŒ–ç¤ºä¾‹
 */
@Repository
public interface UserRepository extends JpaRepository<User, String> {

    // âœ… ä½¿ç”¨ç´¢å¼•å­—æ®µæŸ¥è¯¢
    @Query("SELECT u FROM User u WHERE u.username = :username AND u.status = :status")
    Optional<User> findByUsernameAndStatus(@Param("username") String username, 
                                          @Param("status") UserStatus status);

    // âœ… åˆ†é¡µæŸ¥è¯¢ï¼Œé¿å…æŸ¥è¯¢å¤§é‡æ•°æ®
    @Query("SELECT u FROM User u WHERE u.createdAt >= :startDate ORDER BY u.createdAt DESC")
    Page<User> findRecentUsers(@Param("startDate") LocalDateTime startDate, Pageable pageable);

    // âœ… åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
    @Query("SELECT new com.codivio.dto.UserSummaryDTO(u.id, u.username, u.email) " +
           "FROM User u WHERE u.status = :status")
    List<UserSummaryDTO> findUserSummaries(@Param("status") UserStatus status);

    // âœ… ä½¿ç”¨æ‰¹é‡æ“ä½œ
    @Modifying
    @Query("UPDATE User u SET u.lastLoginAt = :loginTime WHERE u.id IN :userIds")
    int updateLastLoginBatch(@Param("userIds") List<String> userIds, 
                            @Param("loginTime") LocalDateTime loginTime);

    // âœ… ä½¿ç”¨EXISTSè€Œä¸æ˜¯COUNT
    @Query("SELECT CASE WHEN COUNT(u) > 0 THEN true ELSE false END " +
           "FROM User u WHERE u.email = :email")
    boolean existsByEmail(@Param("email") String email);

    // âŒ é¿å…N+1æŸ¥è¯¢é—®é¢˜
    // é”™è¯¯ï¼šä¼šå¯¼è‡´N+1æŸ¥è¯¢
    // List<User> findByStatus(UserStatus status);  // ç„¶ååœ¨ä¸šåŠ¡ä»£ç ä¸­è®¿é—®user.getProjects()

    // âœ… æ­£ç¡®ï¼šä½¿ç”¨JOIN FETCH
    @Query("SELECT DISTINCT u FROM User u LEFT JOIN FETCH u.projects WHERE u.status = :status")
    List<User> findByStatusWithProjects(@Param("status") UserStatus status);
}

/**
 * ç¼“å­˜ä¼˜åŒ–
 */
@Service
@CacheConfig(cacheNames = "users")
public class UserService {

    // âœ… ç¼“å­˜å•ä¸ªå®ä½“
    @Cacheable(key = "#userId")
    public UserDTO getUserById(String userId) {
        // å®ç°
    }

    // âœ… ç¼“å­˜æŸ¥è¯¢ç»“æœ
    @Cacheable(key = "#status.name() + '_' + #pageable.pageNumber + '_' + #pageable.pageSize")
    public Page<UserDTO> getUsersByStatus(UserStatus status, Pageable pageable) {
        // å®ç°
    }

    // âœ… æ›´æ–°æ—¶æ¸…é™¤ç¼“å­˜
    @CacheEvict(key = "#userId")
    public UserDTO updateUser(String userId, UpdateUserRequest request) {
        // å®ç°
    }

    // âœ… åˆ é™¤æ—¶æ¸…é™¤ç›¸å…³ç¼“å­˜
    @CacheEvict(allEntries = true)
    public void deleteUser(String userId) {
        // å®ç°
    }

    // âœ… æ¡ä»¶ç¼“å­˜
    @Cacheable(key = "#userId", condition = "#userId != null", unless = "#result == null")
    public UserDTO getUserIfExists(String userId) {
        // å®ç°
    }
}
```

### 2. æ¥å£æ€§èƒ½ä¼˜åŒ–

#### å“åº”æ—¶é—´ä¼˜åŒ–
```java
/**
 * å¼‚æ­¥å¤„ç†ä¼˜åŒ–
 */
@RestController
@RequestMapping("/api/v1/users")
public class UserController {

    // âœ… å¼‚æ­¥å¤„ç†è€—æ—¶æ“ä½œ
    @PostMapping("/{userId}/export")
    public ResponseEntity<AsyncTaskResponse> exportUserData(@PathVariable String userId) {
        String taskId = UUID.randomUUID().toString();
        
        // å¼‚æ­¥æ‰§è¡Œå¯¼å‡ºä»»åŠ¡
        CompletableFuture.runAsync(() -> {
            try {
                userExportService.exportUserData(userId, taskId);
            } catch (Exception e) {
                log.error("ç”¨æˆ·æ•°æ®å¯¼å‡ºå¤±è´¥: {}", e.getMessage(), e);
                taskService.markTaskFailed(taskId, e.getMessage());
            }
        });
        
        return ResponseEntity.accepted()
            .body(new AsyncTaskResponse(taskId, "æ•°æ®å¯¼å‡ºä»»åŠ¡å·²å¯åŠ¨"));
    }

    // âœ… æ‰¹é‡æ“ä½œä¼˜åŒ–
    @PostMapping("/batch")
    public ResponseEntity<BatchOperationResponse> batchCreateUsers(
            @RequestBody @Valid List<CreateUserRequest> requests) {
        
        if (requests.size() > 100) {
            throw new BusinessException(ErrorCode.BATCH_SIZE_EXCEEDED);
        }
        
        BatchOperationResponse response = userService.batchCreateUsers(requests);
        return ResponseEntity.ok(response);
    }

    // âœ… æµå¼å“åº”å¤§é‡æ•°æ®
    @GetMapping("/export/stream")
    public ResponseEntity<StreamingResponseBody> streamUsers(
            @RequestParam(defaultValue = "active") String status) {
        
        StreamingResponseBody stream = output -> {
            try (JsonGenerator generator = objectMapper.getFactory().createGenerator(output)) {
                generator.writeStartArray();
                
                userService.streamUsersByStatus(UserStatus.valueOf(status.toUpperCase()), user -> {
                    try {
                        generator.writeObject(user);
                        generator.flush();
                    } catch (IOException e) {
                        throw new RuntimeException(e);
                    }
                });
                
                generator.writeEndArray();
            }
        };
        
        return ResponseEntity.ok()
            .header(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE)
            .body(stream);
    }
}

/**
 * è¿æ¥æ± ä¼˜åŒ–
 */
@Configuration
public class PerformanceConfig {

    @Bean
    @Primary
    @ConfigurationProperties("spring.datasource.hikari")
    public HikariDataSource dataSource() {
        HikariConfig config = new HikariConfig();
        
        // è¿æ¥æ± å¤§å°ä¼˜åŒ–
        config.setMaximumPoolSize(20);  // æœ€å¤§è¿æ¥æ•°
        config.setMinimumIdle(5);       // æœ€å°ç©ºé—²è¿æ¥æ•°
        config.setConnectionTimeout(30000);      // è¿æ¥è¶…æ—¶30ç§’
        config.setIdleTimeout(600000);           // ç©ºé—²è¶…æ—¶10åˆ†é’Ÿ
        config.setMaxLifetime(1800000);          // è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ30åˆ†é’Ÿ
        config.setLeakDetectionThreshold(60000); // è¿æ¥æ³„æ¼æ£€æµ‹1åˆ†é’Ÿ
        
        // æ€§èƒ½ä¼˜åŒ–å‚æ•°
        config.setReadOnly(false);
        config.setAutoCommit(true);
        config.setTransactionIsolation("TRANSACTION_READ_COMMITTED");
        
        return new HikariDataSource(config);
    }

    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory factory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(factory);
        
        // ä½¿ç”¨é«˜æ•ˆçš„åºåˆ—åŒ–å™¨
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(new GenericJackson2JsonRedisSerializer());
        template.setHashKeySerializer(new StringRedisSerializer());
        template.setHashValueSerializer(new GenericJackson2JsonRedisSerializer());
        
        // å¯ç”¨äº‹åŠ¡æ”¯æŒ
        template.setEnableTransactionSupport(true);
        
        return template;
    }

    @Bean
    public TaskExecutor taskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(10);
        executor.setMaxPoolSize(50);
        executor.setQueueCapacity(100);
        executor.setThreadNamePrefix("async-task-");
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        executor.initialize();
        return executor;
    }
}
```

---

## ğŸ¯ é¢è¯•å‡†å¤‡è¦ç‚¹

### ğŸ’¡ å¼€å‘è§„èŒƒäº®ç‚¹

1. **ä»£ç è´¨é‡ä¿è¯** - å®Œæ•´çš„ç¼–ç è§„èŒƒå’Œæœ€ä½³å®è·µ
2. **å®‰å…¨æ€§è€ƒè™‘** - å…¨é¢çš„å®‰å…¨é˜²æŠ¤æªæ–½
3. **æ€§èƒ½ä¼˜åŒ–** - æ•°æ®åº“ã€ç¼“å­˜ã€æ¥å£å¤šå±‚æ¬¡ä¼˜åŒ–
4. **å¯ç»´æŠ¤æ€§** - æ¸…æ™°çš„ä»£ç ç»“æ„å’Œæ–‡æ¡£è§„èŒƒ
5. **å›¢é˜Ÿåä½œ** - ç»Ÿä¸€çš„å¼€å‘æµç¨‹å’Œè´¨é‡æ ‡å‡†

### ğŸ¯ å¸¸è§é¢è¯•é—®é¢˜

#### 1. "å¦‚ä½•ä¿è¯ä»£ç è´¨é‡ï¼Ÿ"
```yaml
å›ç­”è¦ç‚¹:
  - ç¼–ç è§„èŒƒå’Œæœ€ä½³å®è·µ
  - ä»£ç å®¡æŸ¥æœºåˆ¶
  - å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
  - é™æ€ä»£ç åˆ†æå·¥å…·
  - æŒç»­é›†æˆå’Œè‡ªåŠ¨åŒ–æ£€æŸ¥
```

#### 2. "å¦‚ä½•å¤„ç†ç³»ç»Ÿå®‰å…¨é—®é¢˜ï¼Ÿ"
```yaml
å›ç­”è¦ç‚¹:
  - è¾“å…¥éªŒè¯å’Œå‚æ•°æ£€æŸ¥
  - SQLæ³¨å…¥é˜²æŠ¤
  - XSSå’ŒCSRFé˜²æŠ¤
  - è®¤è¯æˆæƒæœºåˆ¶
  - æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
```

#### 3. "å¦‚ä½•ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½ï¼Ÿ"
```yaml
å›ç­”è¦ç‚¹:
  - æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
  - ç¼“å­˜ç­–ç•¥è®¾è®¡
  - å¼‚æ­¥å¤„ç†æœºåˆ¶
  - è¿æ¥æ± ä¼˜åŒ–é…ç½®
  - æ‰¹é‡æ“ä½œå‡å°‘IO
```

#### 4. "å¦‚ä½•ä¿è¯ç³»ç»Ÿå¯ç»´æŠ¤æ€§ï¼Ÿ"
```yaml
å›ç­”è¦ç‚¹:
  - æ¸…æ™°çš„ä»£ç ç»“æ„å’Œå‘½å
  - å®Œå–„çš„æ–‡æ¡£å’Œæ³¨é‡Š
  - ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
  - ç»“æ„åŒ–çš„æ—¥å¿—è®°å½•
  - æ¨¡å—åŒ–çš„ç³»ç»Ÿè®¾è®¡
```