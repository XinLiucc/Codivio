# 异常处理与项目服务开发笔记

> 📚 记录全局异常处理、业务异常体系设计以及项目服务开发的技术笔记和工作进展

---

## 📅 2025-08-22 - 全局异常处理系统设计与实现

### 🎯 开发目标

#### 1. 全局异常处理器(@ControllerAdvice)
- 统一处理所有Controller层抛出的异常
- 标准化错误响应格式，与ResultVO保持一致
- 分类处理不同类型异常：参数验证、业务异常、系统异常
- 提供友好的错误信息和调试支持

#### 2. 业务异常类体系设计
- 定义基础业务异常类 (BaseBusinessException)
- 创建具体业务异常：用户相关、认证相关、数据相关
- 设计错误码体系：统一的错误码管理和国际化支持
- 异常链追踪：完整的异常堆栈信息记录

#### 3. 项目服务数据模型实现
- 设计Project实体类：项目基础信息管理
- 设计ProjectMember实体类：项目成员权限管理
- 实现ProjectRepository和ProjectMemberRepository
- 配置项目服务的数据库连接和JPA设置

### 📋 技术学习重点

#### Spring异常处理机制
- @ControllerAdvice全局异常拦截原理
- @ExceptionHandler方法级异常处理
- HandlerExceptionResolver异常解析器
- ResponseEntity vs @ResponseBody的使用场景

#### 企业级异常体系设计
- 异常分层：系统异常 vs 业务异常 vs 参数异常
- 错误码设计原则：可读性、唯一性、分类清晰
- 异常信息国际化：MessageSource国际化支持
- 日志记录策略：什么异常需要记录ERROR日志

---

## 📅 2025-08-26 - 全局异常处理系统实现完成

### ✅ 已完成的工作

#### 1. 错误码体系设计与实现
- **ErrorCode.java**: 创建了5位数字分层错误码体系
  - 系统级错误 (1xxxx): 10001-10199
  - 业务级错误 (2xxxx): 20001-20999
  - 用户服务错误 (202xx): 包含注册、登录、更新相关错误
  - 项目服务错误 (203xx): 为项目服务预留错误码空间

#### 2. 基础业务异常类实现
- **BaseBusinessException.java**: 继承RuntimeException的自定义异常
  - 集成ErrorCode枚举，自动获取错误码和消息
  - 提供三种构造函数：仅ErrorCode、ErrorCode+自定义消息、ErrorCode+消息+原因
  - 支持异常链追踪和错误码快速定位

#### 3. 全局异常处理器实现
- **GlobalExceptionHandler.java**: @ControllerAdvice统一异常处理
  - 业务异常处理: BaseBusinessException → ResultVO错误响应
  - 参数验证异常: MethodArgumentNotValidException → 详细验证错误
  - 运行时异常: RuntimeException → 系统错误响应  
  - 通用异常: Exception → 兜底错误处理
  - 分层日志记录: warn级别业务异常，error级别系统异常

#### 4. 现有代码重构
- **UserServiceImpl.java**: 替换所有RuntimeException为BaseBusinessException
  - 用户注册相关: USERNAME_ALREADY_EXISTS, EMAIL_ALREADY_EXISTS, PASSWORD_MISMATCH
  - 用户登录相关: USER_NOT_FOUND, INVALID_CREDENTIALS  
  - 用户更新相关: EMAIL_ALREADY_USED
- **Controller层**: 移除所有try-catch块，依赖全局异常处理
- **ResultVO.java**: 添加error(Integer, String, T)方法支持验证错误返回

### 🧪 测试验证结果

#### 参数验证异常测试
```json
{
  "code": 20001,
  "message": "参数验证失败",
  "data": {"password": "密码长度必须在6-20个字符之间"}
}
```

#### 业务异常测试
- ✅ 用户名重复: 20211 "用户名已存在"
- ✅ 邮箱重复: 20212 "邮箱地址已存在"  
- ✅ 用户不存在: 20221 "用户不存在"
- ✅ 密码错误: 20222 "用户名或密码错误"

#### JWT认证测试
- ✅ 有效token正常访问用户信息
- ✅ 无效token被Spring Security拦截
- ✅ 未提供token被拦截

### 💡 关键技术理解

#### 异常冒泡机制
1. Service层抛出BaseBusinessException
2. Controller层没有try-catch，异常向上冒泡  
3. Spring MVC检测到未处理异常，交给@ControllerAdvice
4. GlobalExceptionHandler统一处理并返回ResultVO格式

#### Spring异常处理优势
- **代码简洁**: Controller专注业务逻辑，无需重复try-catch
- **格式统一**: 所有异常返回相同的ResultVO结构
- **维护性强**: 异常处理逻辑集中管理
- **可追踪性**: 统一的错误码体系便于问题定位

### 🔍 测试账号记录
- 用户名: `testuser` / 密码: `password123` (已存在)
- 用户名: `newuser` / 邮箱: `test@example.com` (测试时创建)

---

*开发开始时间: 2025-08-22*  
*完成时间: 2025-08-26*  
*当前进度: ✅ 全局异常处理系统100%完成，可开始项目服务开发*