# 异常处理与项目服务开发笔记

> 📚 记录全局异常处理、业务异常体系设计以及项目服务开发的技术笔记和工作进展

---

## 📅 2025-08-22 - 全局异常处理系统设计与实现

### 🎯 开发目标

#### 1. 全局异常处理器(@ControllerAdvice)
- 统一处理所有Controller层抛出的异常
- 标准化错误响应格式，与ResultVO保持一致
- 分类处理不同类型异常：参数验证、业务异常、系统异常
- 提供友好的错误信息和调试支持

#### 2. 业务异常类体系设计
- 定义基础业务异常类 (BaseBusinessException)
- 创建具体业务异常：用户相关、认证相关、数据相关
- 设计错误码体系：统一的错误码管理和国际化支持
- 异常链追踪：完整的异常堆栈信息记录

#### 3. 项目服务数据模型实现
- 设计Project实体类：项目基础信息管理
- 设计ProjectMember实体类：项目成员权限管理
- 实现ProjectRepository和ProjectMemberRepository
- 配置项目服务的数据库连接和JPA设置

### 📋 技术学习重点

#### Spring异常处理机制
- @ControllerAdvice全局异常拦截原理
- @ExceptionHandler方法级异常处理
- HandlerExceptionResolver异常解析器
- ResponseEntity vs @ResponseBody的使用场景

#### 企业级异常体系设计
- 异常分层：系统异常 vs 业务异常 vs 参数异常
- 错误码设计原则：可读性、唯一性、分类清晰
- 异常信息国际化：MessageSource国际化支持
- 日志记录策略：什么异常需要记录ERROR日志

---

## 📅 2025-08-26 - 全局异常处理系统实现完成

### ✅ 已完成的工作

#### 1. 错误码体系设计与实现
- **ErrorCode.java**: 创建了5位数字分层错误码体系
  - 系统级错误 (1xxxx): 10001-10199
  - 业务级错误 (2xxxx): 20001-20999
  - 用户服务错误 (202xx): 包含注册、登录、更新相关错误
  - 项目服务错误 (203xx): 为项目服务预留错误码空间

#### 2. 基础业务异常类实现
- **BaseBusinessException.java**: 继承RuntimeException的自定义异常
  - 集成ErrorCode枚举，自动获取错误码和消息
  - 提供三种构造函数：仅ErrorCode、ErrorCode+自定义消息、ErrorCode+消息+原因
  - 支持异常链追踪和错误码快速定位

#### 3. 全局异常处理器实现
- **GlobalExceptionHandler.java**: @ControllerAdvice统一异常处理
  - 业务异常处理: BaseBusinessException → ResultVO错误响应
  - 参数验证异常: MethodArgumentNotValidException → 详细验证错误
  - 运行时异常: RuntimeException → 系统错误响应  
  - 通用异常: Exception → 兜底错误处理
  - 分层日志记录: warn级别业务异常，error级别系统异常

#### 4. 现有代码重构
- **UserServiceImpl.java**: 替换所有RuntimeException为BaseBusinessException
  - 用户注册相关: USERNAME_ALREADY_EXISTS, EMAIL_ALREADY_EXISTS, PASSWORD_MISMATCH
  - 用户登录相关: USER_NOT_FOUND, INVALID_CREDENTIALS  
  - 用户更新相关: EMAIL_ALREADY_USED
- **Controller层**: 移除所有try-catch块，依赖全局异常处理
- **ResultVO.java**: 添加error(Integer, String, T)方法支持验证错误返回

### 🧪 测试验证结果

#### 参数验证异常测试
```json
{
  "code": 20001,
  "message": "参数验证失败",
  "data": {"password": "密码长度必须在6-20个字符之间"}
}
```

#### 业务异常测试
- ✅ 用户名重复: 20211 "用户名已存在"
- ✅ 邮箱重复: 20212 "邮箱地址已存在"  
- ✅ 用户不存在: 20221 "用户不存在"
- ✅ 密码错误: 20222 "用户名或密码错误"

#### JWT认证测试
- ✅ 有效token正常访问用户信息
- ✅ 无效token被Spring Security拦截
- ✅ 未提供token被拦截

### 💡 关键技术理解

#### 异常冒泡机制
1. Service层抛出BaseBusinessException
2. Controller层没有try-catch，异常向上冒泡  
3. Spring MVC检测到未处理异常，交给@ControllerAdvice
4. GlobalExceptionHandler统一处理并返回ResultVO格式

#### Spring异常处理优势
- **代码简洁**: Controller专注业务逻辑，无需重复try-catch
- **格式统一**: 所有异常返回相同的ResultVO结构
- **维护性强**: 异常处理逻辑集中管理
- **可追踪性**: 统一的错误码体系便于问题定位

### 🔍 测试账号记录
- 用户名: `testuser` / 密码: `password123` (已存在)
- 用户名: `newuser` / 邮箱: `test@example.com` (测试时创建)

---

## 📅 2025-08-27 - 项目服务CRUD功能实现完成

### ✅ 今日完成的工作

#### 1. 项目服务数据模型设计与实现
- **Project.java**: 项目实体类，支持JPA持久化
  - 基础字段: id、name、description、ownerId、language、status
  - 时间戳管理: createdAt、updatedAt (自动管理)
  - JPA注解配置: @Entity、@Table、@PrePersist、@PreUpdate
  - 对标用户服务的实体类设计规范

- **ProjectMember.java**: 项目成员权限实体类
  - 基础字段: id、projectId、userId、role、joinedAt
  - ProjectRole枚举: OWNER、EDITOR、VIEWER三级权限
  - 数据库关联设计，支持复杂权限查询

#### 2. 数据传输对象(DTO)设计
- **ProjectCreateDTO**: 项目创建数据传输，集成Bean Validation
- **ProjectUpdateDTO**: 项目更新数据传输，支持部分字段更新
- **ProjectResponseDTO**: 项目响应数据传输，统一返回格式
- **ResultVO**: 通用响应包装类，复用用户服务的响应格式

#### 3. 数据访问层实现
- **ProjectRepository**: 继承JpaRepository，自定义查询方法
  - findByOwnerId: 按所有者查询项目列表
  - existsByOwnerIdAndName: 检查项目名重复
  - existsByOwnerIdAndNameAndIdNot: 更新时检查重名(排除自身)
  
- **ProjectMemberRepository**: 成员管理和权限查询
  - existsByProjectIdAndUserId: 检查用户是否为项目成员
  - existsByProjectIdAndUserIdAndRoleIn: 检查用户角色权限

#### 4. 业务服务层完整实现
- **ProjectServiceImpl**: 完整的项目业务逻辑
  - createProject: 创建项目 + 自动添加所有者成员
  - getProjectById: 权限验证 + 项目详情查询
  - getProjectsByOwner: 用户项目列表查询
  - updateProject: 部分更新 + 重名检查 + 权限验证
  - deleteProject: 所有者权限检查 + 级联删除
  - 权限辅助方法: isProjectMember、isProjectOwner、canUserEditProject

#### 5. RESTful API控制器实现
- **ProjectController**: 完整的CRUD接口
  - POST /api/v1/projects - 创建项目 (201状态码)
  - GET /api/v1/projects - 获取项目列表
  - GET /api/v1/projects/{id} - 获取项目详情
  - PUT /api/v1/projects/{id} - 更新项目信息
  - DELETE /api/v1/projects/{id} - 删除项目
  - 集成参数验证和统一响应格式

#### 6. 异常处理集成
- 复用全局异常处理体系，添加项目服务专属错误码
- PROJECT_NOT_FOUND (20301): 项目不存在
- PROJECT_ACCESS_DENIED (20302): 无项目访问权限
- PROJECT_NAME_ALREADY_EXISTS (20303): 项目名称已存在

#### 7. 数据库配置修复
- 修复application.yml配置，使用正确的codivio_project数据库
- 解决服务间数据隔离问题，确保项目服务独立运行

### 🧪 功能测试验证

#### CRUD操作测试
- ✅ 创建项目: 成功创建并返回项目信息
- ✅ 查询项目: 根据ID和所有者查询正常
- ✅ 更新项目: 部分字段更新功能正常
- ✅ 删除项目: 权限验证和删除操作正常

#### 权限控制测试
- ✅ 非项目成员无法查看项目详情
- ✅ 非所有者/编辑者无法更新项目
- ✅ 非所有者无法删除项目
- ✅ 项目名重名检查正常工作

#### 异常处理测试
- ✅ 参数验证错误正确返回20001错误码
- ✅ 业务异常正确返回对应错误码和消息
- ✅ 全局异常处理器统一处理所有异常

### 💡 关键技术理解

#### JPA生命周期回调
- @PrePersist: 实体持久化前自动设置创建时间
- @PreUpdate: 实体更新前自动设置更新时间
- 避免手动管理时间戳，确保数据一致性

#### 部分更新设计模式
- ProjectUpdateDTO只包含可选字段，避免@NotBlank验证
- hasUpdates()方法检查是否有实际更新内容
- 只更新非空字段，保持其他字段不变

#### 权限验证设计
- 多层权限验证: 成员验证 + 角色权限验证
- canUserEditProject()支持OWNER和EDITOR两种编辑权限
- 删除操作只允许OWNER执行

### 📊 Git提交记录
按照小颗粒度提交原则，共完成7个独立提交:
1. fix(project-service): 修复数据库配置使用正确的项目数据库
2. feat(project-service): 添加项目数据模型和DTO类
3. feat(project-service): 集成全局异常处理体系
4. feat(project-service): 实现数据访问层Repository
5. feat(project-service): 实现项目业务服务层
6. feat(project-service): 实现RESTful API控制器
7. build(project-service): 添加项目服务所需依赖

### 🎯 下一步开发计划
- 项目成员管理功能 (ProjectMemberService + 成员管理API)
- API网关集成和统一认证
- 服务间通信实现 (OpenFeign)

---

*开发开始时间: 2025-08-22*  
*异常处理完成: 2025-08-26*  
*项目CRUD完成: 2025-08-27*  
*当前进度: ✅ 项目服务基础CRUD功能100%完成，可开始成员管理功能开发*