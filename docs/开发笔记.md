# Codivio 开发笔记

> 记录项目开发过程中的技术笔记、工作内容和问题解答

## 2025-08-18 - 数据库架构修正与完善

### ✅ 完成的工作

#### 1. 深度熟悉项目文档体系
- **全面阅读设计文档**
  - 系统架构设计文档（微服务拆分、技术选型）
  - 数据库设计文档（表结构、索引设计、服务职责分离）
  - 技术决策记录（ADR格式记录所有重要决策）
  - GitFlow工作流规范（分支管理、提交规范）
  - 接口设计文档（RESTful API、WebSocket规范）

- **理解项目核心理念**
  - 文档驱动开发模式
  - 企业级微服务架构学习
  - 分布式系统设计实践

#### 2. 发现并修正数据库初始化问题
- **问题识别**
  - 发现Docker MySQL初始化脚本与设计文档不符
  - 缺少 `codivio_file` 数据库
  - 项目服务表名错误（`project_files` vs `project_file_tree`）
  - 表结构字段缺失（`parent_path`, `file_id`, `file_extension`, `metadata`等）

- **系统性修正**
  - 补全数据库创建脚本，添加文件服务数据库
  - 修正项目服务表结构以符合设计文档
  - 新增完整的文件服务数据库表结构
  - 优化Docker容器配置

#### 3. 数据库架构完全重建
- **重置现有数据**
  - 使用 `docker compose down -v` 清理错误数据
  - 重新初始化所有服务和数据卷
  - 确保按正确脚本重新创建数据库

- **验证数据库结构**
  - ✅ 三个业务数据库全部正确创建
  - ✅ 所有表结构完全符合设计文档
  - ✅ 索引配置完整且合理
  - ✅ 用户权限配置正确
  - ✅ 服务职责分离清晰

#### 4. 规范化Git提交管理
- **颗粒度提交**
  - `fix(database): 补全数据库创建脚本，添加文件服务数据库`
  - `fix(database): 修正项目服务表结构以符合设计文档`
  - `feat(database): 新增文件服务数据库表结构`
  - `config(docker): 优化MySQL容器配置`

- **提交规范**
  - 遵循Conventional Commits规范
  - 每个提交职责单一
  - 详细的提交信息和变更说明

### 🎯 核心成果

#### 1. 数据库架构完全符合设计文档
```yaml
codivio_user:
  - users (用户基础信息) 
  - user_preferences (用户偏好设置)

codivio_project:
  - projects (项目信息)
  - project_members (项目成员) 
  - project_file_tree (文件树结构) # 修正

codivio_file:
  - files (文件存储) # 完善
  - file_versions (文件版本历史)
  - file_access_logs (文件访问日志) # 新增
```

#### 2. 服务职责分离明确
- **项目服务**: 专注文件树**逻辑结构**管理
- **文件服务**: 专注文件**物理存储**和版本管理

#### 3. 技术架构理解深化
- 微服务数据库独立原则
- 分布式系统数据一致性设计
- 容器化部署和初始化流程
- 文档驱动开发的价值

### 🤔 技术问题与解答

#### Q: Docker初始化脚本什么时候执行？
A: MySQL的初始化脚本只在**首次创建容器且数据目录为空时**才会执行。如果需要重新执行，必须删除数据卷 (`docker compose down -v`)。

#### Q: 如何在开发过程中修改数据库字段？
A: 有两种方式：
1. **直接修改**: 使用ALTER TABLE语句直接修改现有表
2. **重建方式**: `docker compose down -v` 后重新启动（开发阶段推荐）

#### Q: 为什么要严格按照设计文档实现？
A: 确保架构一致性、可维护性、文档价值和完整的学习体验。

### 📋 下一步计划

1. **微服务代码实现**
   - 基于正确的表结构开发业务逻辑
   - 实现数据访问层（DAO/Repository）

2. **服务间通信**
   - OpenFeign同步通信
   - RabbitMQ异步消息

3. **接口开发**
   - 按照接口设计文档实现RESTful API
   - WebSocket实时通信功能

---

## 2025-08-14 - 项目启动与基础架构搭建

### ✅ 完成的工作

#### 1. 项目基础架构搭建
- **Docker环境配置**
  - 创建 `docker-compose.yml` 统一编排服务
  - 配置 MySQL 8.0 数据库服务
  - 配置 Redis 7 缓存服务  
  - 配置 RabbitMQ 3 消息队列服务
  - 设置 Nginx 反向代理和负载均衡

- **数据库设计**
  - 创建用户服务数据库 `codivio_user`
  - 创建项目服务数据库 `codivio_project`
  - 设计用户表、项目表、文件表等基础表结构
  - 配置数据库初始化脚本

- **开发环境配置**
  - 添加 `.env` 环境变量配置
  - 更新 `.gitignore` 忽略不必要文件
  - 创建 `README-SETUP.md` 开发指南

#### 2. 用户服务基础框架
- **技术栈选择**
  - Spring Boot 3.2.0 + Java 17
  - Maven 项目管理
  - Logback 日志系统
  - Spring Actuator 监控

- **服务搭建**
  - 创建 Spring Boot 主启动类
  - 配置 `application.yml` 基础配置
  - 添加健康检查接口 `/api/v1/users/health`
  - 配置 Spring Actuator 端点
  - 创建 Dockerfile 支持容器化

- **验证测试**
  - ✅ Maven 编译成功
  - ✅ 应用启动成功（8081端口）
  - ✅ 健康检查接口正常响应
  - ✅ Spring Actuator 监控正常

### 🤔 技术问题与解答

#### Q: Nginx在架构中的作用是什么？
**A: Nginx 作为反向代理和统一入口**
- **统一入口**: 所有外部请求通过 Nginx(80端口) 进入系统
- **路由分发**: 
  - `/api/v1/*` → Gateway服务 (8080端口)
  - `/ws/*` → 协作服务WebSocket (8083端口)  
  - `/` → 前端静态资源 (3000端口)
- **负载均衡**: 支持服务多实例部署
- **静态资源服务**: 直接服务前端文件

#### Q: 服务间通信方式？
**A: 分层通信架构**
```
Frontend → Nginx(80) → Gateway(8080) → Services(808x)
                                     ↓
                               MySQL + Redis + RabbitMQ
```

- **当前阶段**: Frontend → Nginx → User-Service(8081)
- **完整架构**: Frontend → Nginx → Gateway → 各微服务

#### Q: 如何测试 User-Service？
**A: 三种测试方式**
1. **直接测试**: `curl http://localhost:8081/api/v1/users/health`
2. **Docker测试**: `docker-compose up -d user-service`
3. **完整链路**: `curl http://localhost/api/v1/users/health` (需要网关)

### 🎯 代码提交记录
- `feat: 搭建项目基础架构和Docker环境`
- `feat: 创建用户服务基础框架`

### 📝 开发心得
- 采用**渐进式开发**策略，先搭建基础框架再逐步完善功能
- **Docker化优先**，保证开发环境一致性  
- **健康检查**是微服务的基础，便于监控和调试
- **分离关注点**，基础设施和业务服务分别提交

## 2025-08-17 - Gateway服务基础框架搭建

### ✅ 完成的工作

#### 1. Gateway服务基础架构
- **Spring Cloud Gateway框架**
  - Spring Boot 3.2.0 + Spring Cloud 2023.0.0
  - 配置响应式Web框架（WebFlux + Netty）
  - 添加Actuator监控和健康检查

- **路由配置**
  - 用户服务路由：`/api/v1/auth/**,/api/v1/users/**` → `user-service:8081`
  - 项目服务路由：`/api/v1/projects/**` → `project-service:8082` (预留)
  - 协作服务路由：`/api/v1/collaboration/**` → `collaboration-service:8083` (预留)
  - 文件服务路由：`/api/v1/files/**` → `file-service:8084` (预留)

- **服务集成**
  - 创建Dockerfile支持容器化
  - 更新docker-compose.yml添加Gateway服务
  - Gateway健康检查接口：`/api/v1/gateway/health`

- **验证测试**
  - ✅ Maven编译成功
  - ✅ 应用启动成功（8080端口）
  - ✅ 健康检查接口正常响应
  - ✅ 路由规则加载成功（4个服务）

#### 2. Project服务基础架构
- **Spring Boot Web框架**
  - Spring Boot 3.2.0 + Java 17
  - 传统Servlet容器（Tomcat）架构
  - 添加Actuator监控和健康检查

- **服务配置**
  - 服务端口：8082
  - 健康检查接口：`/api/v1/projects/health`
  - Actuator监控端点：`/actuator/health`, `/actuator/info`

- **容器化集成**
  - 创建Dockerfile支持容器化
  - 更新docker-compose.yml添加project-service配置
  - 配置依赖关系：依赖MySQL和Redis

- **验证测试**
  - ✅ Maven编译成功
  - ✅ 应用启动成功（8082端口）
  - ✅ 健康检查接口正常响应
  - ✅ Actuator监控端点可访问

#### 3. Collaboration服务基础架构
- **Spring Boot Web + WebSocket框架**
  - Spring Boot 3.2.0 + Java 17
  - 添加WebSocket支持，为实时协作功能做准备
  - 传统Servlet容器（Tomcat）架构
  - 添加Actuator监控和健康检查

- **服务配置**
  - 服务端口：8083
  - 健康检查接口：`/api/v1/collaboration/health`
  - Actuator监控端点：`/actuator/health`, `/actuator/info`

- **容器化集成**
  - 创建Dockerfile支持容器化
  - 更新docker-compose.yml添加collaboration-service配置
  - 配置依赖关系：依赖MySQL、Redis和RabbitMQ（为消息传递做准备）

- **验证测试**
  - ✅ Maven编译成功
  - ✅ 应用启动成功（8083端口）
  - ✅ 健康检查接口正常响应
  - ✅ WebSocket依赖加载正常

#### 4. File服务基础架构
- **Spring Boot Web框架**
  - Spring Boot 3.2.0 + Java 17
  - 配置文件上传支持（最大文件10MB，最大请求50MB）
  - 传统Servlet容器（Tomcat）架构
  - 添加Actuator监控和健康检查

- **服务配置**
  - 服务端口：8084
  - 健康检查接口：`/api/v1/files/health`
  - Actuator监控端点：`/actuator/health`, `/actuator/info`
  - 文件上传配置：支持多文件上传

- **容器化集成**
  - 创建Dockerfile支持容器化
  - 更新docker-compose.yml添加file-service配置
  - 配置依赖关系：依赖MySQL和Redis
  - 添加文件存储卷映射：`./data/files:/app/files`

- **验证测试**
  - ✅ Maven编译成功
  - ✅ 应用启动成功（8084端口）
  - ✅ 健康检查接口正常响应
  - ✅ 文件上传配置加载正常

### 🎯 代码提交记录
- `feat: 创建Gateway服务基础框架`
- `feat: 创建Project服务基础框架`
- `feat: 创建Collaboration服务基础框架`
- `feat: 创建File服务基础框架`

### 🏗️ 微服务架构完成总结
**已完成的完整微服务架构骨架：**
- ✅ **Gateway服务**（8080）- Spring Cloud Gateway，统一入口和路由
- ✅ **User服务**（8081）- 用户管理服务
- ✅ **Project服务**（8082）- 项目管理服务  
- ✅ **Collaboration服务**（8083）- 实时协作服务（WebSocket）
- ✅ **File服务**（8084）- 文件管理服务

**基础设施完整配置：**
- ✅ MySQL 8.0 数据库
- ✅ Redis 7 缓存服务
- ✅ RabbitMQ 3 消息队列
- ✅ Nginx 反向代理和负载均衡

**完整的容器化部署：**
- ✅ 所有服务都有独立的Dockerfile
- ✅ docker-compose.yml统一编排
- ✅ 服务依赖关系正确配置
- ✅ 网络和数据卷完整设置

### 📝 开发心得
- **架构优先**：先建立完整的微服务架构骨架，为后续开发提供清晰的服务边界
- **路由预留**：提前配置所有服务的路由规则，便于后续服务快速接入
- **渐进式验证**：每个服务都提供独立的健康检查，确保服务可用性
- **服务模板化**：基于成功经验，快速复制服务架构
- **端口规划**：按照规律分配端口，便于管理和记忆（8080→8081→8082→8083）
- **依赖分层**：不同服务依赖不同的基础设施，Collaboration服务增加了RabbitMQ依赖
- **技术选型**：针对不同服务特点选择合适技术栈，如Collaboration服务加入WebSocket支持

### 🐳 Docker环境调试与完善

#### 1. Docker构建问题排查与修复
- **问题发现**
  - 在执行`docker compose up -d`时发现构建失败
  - 错误信息：`"/.mvn": not found` 和 `"mvnw": not found`
  - 原因：Dockerfile中尝试复制不存在的Maven Wrapper文件

- **解决方案**
  - 移除所有后端服务Dockerfile中的Maven Wrapper复制命令
  - 删除`COPY mvnw .`和`COPY .mvn ./.mvn`指令
  - 保留使用系统Maven进行构建的方式：`RUN apt-get update && apt-get install -y maven`

- **修复范围**
  - ✅ user-service/Dockerfile
  - ✅ gateway-service/Dockerfile  
  - ✅ project-service/Dockerfile
  - ✅ collaboration-service/Dockerfile
  - ✅ file-service/Dockerfile

#### 2. Docker容器配置优化
- **端口映射调整**
  - 将前端服务端口从80改为8090，避免与系统端口冲突
  - `docker-compose.yml`: `ports: ["8090:80"]`
  - 便于本地开发和测试时区分不同服务

- **Spring Boot配置调整（后撤销）**
  - 初步尝试禁用系统指标收集解决Docker兼容性问题
  - 在`application.yml`中添加`management.metrics.enable.system: false`
  - 经测试发现不需要此修改，Docker可正常运行
  - 最终撤销了此配置修改，保持原始配置

#### 3. 完整Docker环境验证
- **成功启动验证**
  - ✅ 所有基础设施服务正常启动：MySQL、Redis、RabbitMQ、Nginx
  - ✅ 所有微服务正常启动：user-service、gateway-service、project-service、collaboration-service、file-service
  - ✅ 前端服务正常启动并可访问：http://localhost:8090

- **服务状态检查**
  ```bash
  # 所有容器运行状态良好
  docker compose ps
  
  NAME                            STATUS
  codivio-collaboration-service   Up 12 seconds   
  codivio-file-service           Up 12 seconds   
  codivio-frontend               Up 9 seconds    
  codivio-gateway-service        Up 10 seconds   
  codivio-mysql                  Up 13 seconds   
  codivio-nginx                  Up 9 seconds    
  codivio-project-service        Up 12 seconds   
  codivio-rabbitmq               Up 13 seconds   
  codivio-redis                  Up 13 seconds   
  codivio-user-service           Up 12 seconds   
  ```

#### 4. 项目文档完善
- **开发待办清单**
  - 创建`docs/TODO.md`详细的开发任务清单
  - 按4个优先级分类：立即处理、本周内、下周、后续优化
  - 包含数据层建设、认证系统、API开发等74个具体任务
  - 提供里程碑目标和进度跟踪机制

- **前端基础文件**
  - 添加`frontend/index.html`前端入口文件
  - 配置中文语言、视窗设置和Vue应用挂载点

#### 5. 今日提交记录
- `fix: 移除Dockerfile中不存在的Maven Wrapper文件复制`
- `config: 调整前端服务端口映射`  
- `docs: 添加开发待办清单和任务优先级规划`
- `feat: 添加前端入口HTML文件`

#### 6. 技术问题解答

**Q: 为什么Docker构建会失败？**
**A: Maven Wrapper文件缺失问题**
- **问题**: Dockerfile尝试复制项目中不存在的`mvnw`和`.mvn`文件
- **原因**: 项目没有使用Maven Wrapper，而是直接使用系统Maven
- **解决**: 删除Dockerfile中的Wrapper相关复制命令，保留系统Maven安装

**Q: 如何进行本地开发？**
**A: 混合开发模式推荐**
```bash
# 方式1: 启动基础设施 + 本地运行微服务（推荐）
docker compose up -d mysql redis rabbitmq
cd backend/user-service && mvn spring-boot:run

# 方式2: 完全Docker开发
docker compose up -d
```

### 🏆 今日成果总结
**Docker环境完全可用！**
- ✅ **一键启动**: `docker compose up -d`即可启动所有服务
- ✅ **服务完整**: 5个微服务 + 4个基础设施 + 前端 + Nginx全部正常
- ✅ **端口规划**: 8080(网关) → 8081(用户) → 8082(项目) → 8083(协作) → 8084(文件) → 8090(前端)
- ✅ **开发就绪**: 可以开始具体功能开发，框架基础已完备
- ✅ **文档完善**: 有清晰的开发路线图和任务优先级

### 🔄 下一步计划
- 📋 **开发阶段**: 按照`docs/TODO.md`中的优先级1任务开始具体开发
- 🎯 **首要任务**: 数据层基础建设 - 配置数据库连接和JPA
- 🎯 **第一个里程碑**: 完成用户服务基础功能(注册/登录/JWT)
- 📝 **开发模式**: 文档驱动开发，严格按照待办清单执行