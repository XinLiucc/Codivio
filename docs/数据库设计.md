# Codivio æ•°æ®åº“è®¾è®¡æ–‡æ¡£

## ğŸ¯ è®¾è®¡åŸåˆ™

éµå¾ª**å¾®æœåŠ¡æ•°æ®åº“ç‹¬ç«‹åŸåˆ™**ï¼Œæ¯ä¸ªæœåŠ¡æ‹¥æœ‰ç‹¬ç«‹çš„æ•°æ®åº“ï¼Œé€šè¿‡æ˜ç¡®çš„æ•°æ®è¾¹ç•Œä¿è¯ç³»ç»Ÿçš„æ¾è€¦åˆå’Œé«˜å†…èšã€‚

### æ ¸å¿ƒåŸåˆ™
- ğŸ¯ **æ•°æ®ç‹¬ç«‹** - æ¯ä¸ªå¾®æœåŠ¡æ‹¥æœ‰ç‹¬ç«‹æ•°æ®åº“
- ğŸ”— **æ¾è€¦åˆ** - æœåŠ¡é—´é€šè¿‡APIè€Œéç›´æ¥æ•°æ®åº“è®¿é—®
- ğŸ“Š **æ•°æ®ä¸€è‡´æ€§** - é€šè¿‡äº‹ä»¶é©±åŠ¨ä¿è¯æœ€ç»ˆä¸€è‡´æ€§
- âš¡ **æ€§èƒ½ä¼˜åŒ–** - åˆç†ä½¿ç”¨ç¼“å­˜å’Œç´¢å¼•ç­–ç•¥
- ğŸ“ˆ **å¯æ‰©å±•æ€§** - æ”¯æŒæ°´å¹³æ‰©å±•å’Œåˆ†åº“åˆ†è¡¨

## ğŸ“Š æ•°æ®æ¶æ„å…¨æ™¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åº”ç”¨æœåŠ¡å±‚                            â”‚
â”‚   User Service    Project Service    Collaboration Service  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ•°æ®å­˜å‚¨å±‚                             â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   MySQL     â”‚  â”‚    Redis    â”‚  â”‚  RabbitMQ   â”‚          â”‚
â”‚  â”‚  æŒä¹…åŒ–æ•°æ®   â”‚  â”‚   ç¼“å­˜çŠ¶æ€   â”‚  â”‚   æ¶ˆæ¯é˜Ÿåˆ—   â”‚          â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚          â”‚
â”‚  â”‚ - ç”¨æˆ·æ•°æ®   â”‚  â”‚ - ä¼šè¯ç¼“å­˜   â”‚  â”‚ - äº‹ä»¶é€šçŸ¥   â”‚          â”‚
â”‚  â”‚ - é¡¹ç›®æ•°æ®   â”‚  â”‚ - å®æ—¶çŠ¶æ€   â”‚  â”‚ - å¼‚æ­¥å¤„ç†   â”‚          â”‚
â”‚  â”‚ - æ–‡ä»¶æ•°æ®   â”‚  â”‚ - æ“ä½œé˜Ÿåˆ—   â”‚  â”‚             â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ MySQL å…³ç³»æ•°æ®åº“è®¾è®¡

### æ•°æ®åº“åˆ†ç¦»ç­–ç•¥

æŒ‰ç…§å¾®æœåŠ¡è¾¹ç•Œè¿›è¡Œæ•°æ®åº“åˆ†ç¦»ï¼Œç¡®ä¿æœåŠ¡ç‹¬ç«‹æ€§ï¼š

```sql
-- ç”¨æˆ·æœåŠ¡æ•°æ®åº“
CREATE DATABASE codivio_user 
CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;

-- é¡¹ç›®æœåŠ¡æ•°æ®åº“  
CREATE DATABASE codivio_project
CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;
```

---

## ğŸ‘¤ ç”¨æˆ·æœåŠ¡æ•°æ®åº“ (codivio_user)

### users - ç”¨æˆ·åŸºç¡€ä¿¡æ¯è¡¨
```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ç”¨æˆ·ID',
    username VARCHAR(50) UNIQUE NOT NULL COMMENT 'ç”¨æˆ·å',
    email VARCHAR(100) UNIQUE NOT NULL COMMENT 'é‚®ç®±',
    password_hash VARCHAR(255) NOT NULL COMMENT 'å¯†ç å“ˆå¸Œ',
    
    -- åŸºç¡€ä¿¡æ¯
    nickname VARCHAR(100) COMMENT 'æ˜µç§°',
    avatar_url VARCHAR(255) COMMENT 'å¤´åƒé“¾æ¥',
    
    -- çŠ¶æ€ä¿¡æ¯
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€: 0-ç¦ç”¨, 1-æ­£å¸¸',
    last_login_at TIMESTAMP NULL COMMENT 'æœ€åç™»å½•æ—¶é—´',
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    
    -- ç´¢å¼•
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
) COMMENT 'ç”¨æˆ·åŸºç¡€ä¿¡æ¯è¡¨';
```

### user_preferences - ç”¨æˆ·åå¥½è®¾ç½®è¡¨
```sql
CREATE TABLE user_preferences (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    
    -- ç•Œé¢è®¾ç½®
    theme ENUM('light', 'dark') DEFAULT 'dark' COMMENT 'ä¸»é¢˜è®¾ç½®',
    language VARCHAR(10) DEFAULT 'zh-CN' COMMENT 'ç•Œé¢è¯­è¨€',
    
    -- ç¼–è¾‘å™¨è®¾ç½®
    editor_font_size TINYINT DEFAULT 14 COMMENT 'ç¼–è¾‘å™¨å­—ä½“å¤§å°',
    editor_theme VARCHAR(20) DEFAULT 'vs-dark' COMMENT 'ç¼–è¾‘å™¨ä¸»é¢˜',
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY unique_user_preference (user_id)
) COMMENT 'ç”¨æˆ·åå¥½è®¾ç½®è¡¨';
```

---

## ğŸ“ é¡¹ç›®æœåŠ¡æ•°æ®åº“ (codivio_project)

### projects - é¡¹ç›®åŸºç¡€ä¿¡æ¯è¡¨
```sql
CREATE TABLE projects (
    id VARCHAR(32) PRIMARY KEY COMMENT 'é¡¹ç›®ID (é›ªèŠ±ç®—æ³•ç”Ÿæˆ)',
    name VARCHAR(100) NOT NULL COMMENT 'é¡¹ç›®åç§°',
    description TEXT COMMENT 'é¡¹ç›®æè¿°',
    
    -- æ‰€æœ‰è€…ä¿¡æ¯
    owner_id BIGINT NOT NULL COMMENT 'æ‰€æœ‰è€…ID',
    
    -- é¡¹ç›®é…ç½®
    language VARCHAR(20) DEFAULT 'javascript' COMMENT 'ä¸»è¦ç¼–ç¨‹è¯­è¨€',
    
    -- ç»Ÿè®¡ä¿¡æ¯
    member_count INT DEFAULT 1 COMMENT 'æˆå‘˜æ•°é‡',
    file_count INT DEFAULT 0 COMMENT 'æ–‡ä»¶æ•°é‡',
    
    -- çŠ¶æ€ä¿¡æ¯
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€: 0-åˆ é™¤, 1-æ­£å¸¸',
    last_activity_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'æœ€åæ´»åŠ¨æ—¶é—´',
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_owner_id (owner_id),
    INDEX idx_language (language),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at),
    INDEX idx_last_activity (last_activity_at)
) COMMENT 'é¡¹ç›®åŸºç¡€ä¿¡æ¯è¡¨';
```

### project_members - é¡¹ç›®æˆå‘˜è¡¨
```sql
CREATE TABLE project_members (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    project_id VARCHAR(32) NOT NULL COMMENT 'é¡¹ç›®ID',
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    
    -- æƒé™ä¿¡æ¯
    role ENUM('owner', 'editor', 'viewer') DEFAULT 'editor' COMMENT 'è§’è‰²',
    
    -- æ—¶é—´ä¿¡æ¯
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åŠ å…¥æ—¶é—´',
    last_accessed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'æœ€åè®¿é—®æ—¶é—´',
    
    UNIQUE KEY unique_member (project_id, user_id),
    INDEX idx_project_id (project_id),
    INDEX idx_user_id (user_id),
    INDEX idx_role (role),
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
) COMMENT 'é¡¹ç›®æˆå‘˜è¡¨';
```

### project_files - é¡¹ç›®æ–‡ä»¶è¡¨
```sql
CREATE TABLE project_files (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    project_id VARCHAR(32) NOT NULL COMMENT 'é¡¹ç›®ID',
    
    -- æ–‡ä»¶ä¿¡æ¯
    file_path VARCHAR(500) NOT NULL COMMENT 'æ–‡ä»¶è·¯å¾„',
    file_name VARCHAR(255) NOT NULL COMMENT 'æ–‡ä»¶å',
    content LONGTEXT COMMENT 'æ–‡ä»¶å†…å®¹',
    size INT DEFAULT 0 COMMENT 'æ–‡ä»¶å¤§å°(å­—èŠ‚)',
    
    -- æ–‡ä»¶ç±»å‹
    type ENUM('file', 'directory') DEFAULT 'file' COMMENT 'ç±»å‹',
    
    -- ç¼–è¾‘ä¿¡æ¯
    last_editor_id BIGINT COMMENT 'æœ€åç¼–è¾‘è€…ID',
    last_edited_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'æœ€åç¼–è¾‘æ—¶é—´',
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    UNIQUE KEY unique_file (project_id, file_path),
    INDEX idx_project_id (project_id),
    INDEX idx_type (type),
    INDEX idx_updated_at (updated_at),
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
) COMMENT 'é¡¹ç›®æ–‡ä»¶è¡¨';
```

---

## ğŸš€ Redis ç¼“å­˜è®¾è®¡

### ç¼“å­˜åˆ†å±‚ç­–ç•¥

Redisä½œä¸ºé«˜æ€§èƒ½ç¼“å­˜å±‚ï¼ŒæŒ‰æ•°æ®ç±»å‹å’Œç”Ÿå‘½å‘¨æœŸè¿›è¡Œåˆ†åº“ç®¡ç†ï¼š

```yaml
# Redisæ•°æ®åº“åˆ†é…
databases:
  0: # ç”¨æˆ·ä¼šè¯å’Œè®¤è¯
    description: "ç”¨æˆ·è®¤è¯å’Œä¼šè¯ç®¡ç†"
    ttl: 7200  # 2å°æ—¶
    keys:
      - "user:session:{userId}"       # ç”¨æˆ·ä¼šè¯ä¿¡æ¯
      - "user:token:blacklist:{token}" # JWTé»‘åå•
      - "user:online:{userId}"        # ç”¨æˆ·åœ¨çº¿çŠ¶æ€
      
  1: # å®æ—¶åä½œçŠ¶æ€
    description: "å®æ—¶ç¼–è¾‘å’Œåä½œæ•°æ®"
    ttl: 1800  # 30åˆ†é’Ÿ
    keys:
      - "document:content:{fileId}"        # æ–‡æ¡£å½“å‰å†…å®¹
      - "document:version:{fileId}"        # æ–‡æ¡£ç‰ˆæœ¬å·
      - "document:users:{fileId}"          # æ–‡æ¡£åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
      - "operation:queue:{fileId}"         # æ“ä½œè½¬æ¢é˜Ÿåˆ—
      - "cursor:position:{fileId}:{userId}" # ç”¨æˆ·å…‰æ ‡ä½ç½®
      
  2: # ç³»ç»Ÿç¼“å­˜
    description: "ç³»ç»Ÿé…ç½®å’Œç»Ÿè®¡æ•°æ®"
    ttl: 3600  # 1å°æ—¶
    keys:
      - "project:info:{projectId}"         # é¡¹ç›®ä¿¡æ¯ç¼“å­˜
      - "project:members:{projectId}"      # é¡¹ç›®æˆå‘˜ç¼“å­˜
      - "rate:limit:{userId}:{endpoint}"   # ç”¨æˆ·é™æµè®¡æ•°
```

### å…³é”®æ•°æ®ç»“æ„

#### 1. ç”¨æˆ·ä¼šè¯ç¼“å­˜
```json
// Key: user:session:{userId}
// Type: Hash
{
  "userId": "12345",
  "username": "john_doe",
  "nickname": "John",
  "email": "john@example.com",
  "avatar": "https://avatar.codivio.dev/john.png",
  "roles": ["user"],
  "loginTime": "1640995200000",
  "lastActiveTime": "1640995200000"
}
```

#### 2. å®æ—¶æ–‡æ¡£çŠ¶æ€
```json
// Key: document:content:{fileId}
// Type: Hash
{
  "projectId": "proj_abc123",
  "filePath": "/src/App.js",
  "content": "import React from 'react';...",
  "version": "42",
  "lastModified": "1640995200000"
}
```

#### 3. åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
```json
// Key: document:users:{fileId}
// Type: Set
[
  "user_12345",
  "user_67890"
]
```

#### 4. æ“ä½œè½¬æ¢é˜Ÿåˆ—
```json
// Key: operation:queue:{fileId}
// Type: List
[
  {
    "id": "op_123",
    "type": "insert",
    "position": 100,
    "text": "Hello, World!",
    "userId": "12345",
    "timestamp": 1640995200000
  }
]
```

#### 5. ç”¨æˆ·å…‰æ ‡ä½ç½®
```json
// Key: cursor:position:{fileId}:{userId}
// Type: Hash
{
  "line": "10",
  "column": "25",
  "selection_start": "150",
  "selection_end": "165",
  "timestamp": "1640995200000"
}
```

---

## ğŸ”„ æ•°æ®ä¸€è‡´æ€§è®¾è®¡

### å¾®æœåŠ¡é—´æ•°æ®åŒæ­¥

é‡‡ç”¨**äº‹ä»¶é©±åŠ¨æ¶æ„**ä¿è¯æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ï¼š

#### äº‹ä»¶å‘å¸ƒç¤ºä¾‹
```java
// ç”¨æˆ·æœåŠ¡ - å‘å¸ƒç”¨æˆ·åˆ›å»ºäº‹ä»¶
@Service
public class UserEventPublisher {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    public void publishUserCreatedEvent(User user) {
        UserCreatedEvent event = UserCreatedEvent.builder()
            .userId(user.getId())
            .username(user.getUsername())
            .email(user.getEmail())
            .nickname(user.getNickname())
            .timestamp(System.currentTimeMillis())
            .build();
            
        rabbitTemplate.convertAndSend(
            "user.exchange", 
            "user.created", 
            event
        );
    }
}
```

#### äº‹ä»¶æ¶ˆè´¹ç¤ºä¾‹
```java
// é¡¹ç›®æœåŠ¡ - æ¶ˆè´¹ç”¨æˆ·åˆ›å»ºäº‹ä»¶
@Component
public class UserEventListener {
    
    @RabbitListener(queues = "project.user.created")
    public void handleUserCreated(UserCreatedEvent event) {
        // åˆ›å»ºç”¨æˆ·åœ¨é¡¹ç›®æœåŠ¡ä¸­çš„åŸºç¡€æ•°æ®
        UserProjectProfile profile = UserProjectProfile.builder()
            .userId(event.getUserId())
            .username(event.getUsername())
            .nickname(event.getNickname())
            .build();
            
        userProjectProfileService.createProfile(profile);
    }
}
```

### ç¼“å­˜æ›´æ–°ç­–ç•¥

#### å†™é€šç­–ç•¥ (Write-Through)
```java
@Service
public class ProjectCacheService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private ProjectService projectService;
    
    public void updateProject(String projectId, Project project) {
        // 1. æ›´æ–°æ•°æ®åº“
        projectService.updateProject(projectId, project);
        
        // 2. æ›´æ–°ç¼“å­˜
        String cacheKey = "project:info:" + projectId;
        redisTemplate.opsForValue().set(
            cacheKey, 
            JSON.toJSONString(project),
            Duration.ofHours(1)
        );
        
        // 3. å‘å¸ƒæ›´æ–°äº‹ä»¶
        publishProjectUpdatedEvent(project);
    }
}
```

#### ç¼“å­˜å¤±æ•ˆç­–ç•¥
```java
@Service
public class CacheInvalidationService {
    
    public void invalidateProjectCache(String projectId) {
        // åˆ é™¤é¡¹ç›®ä¿¡æ¯ç¼“å­˜
        redisTemplate.delete("project:info:" + projectId);
        
        // åˆ é™¤é¡¹ç›®æˆå‘˜ç¼“å­˜
        redisTemplate.delete("project:members:" + projectId);
        
        // å‘å¸ƒç¼“å­˜å¤±æ•ˆäº‹ä»¶
        publishCacheInvalidationEvent(projectId);
    }
}
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### MySQL æŸ¥è¯¢ä¼˜åŒ–

#### å¸¸ç”¨æŸ¥è¯¢è¯­å¥
```sql
-- 1. è·å–ç”¨æˆ·é¡¹ç›®åˆ—è¡¨ï¼ˆåˆ†é¡µæŸ¥è¯¢ï¼‰
SELECT 
    p.id,
    p.name,
    p.description,
    p.language,
    p.last_activity_at,
    pm.role,
    pm.joined_at
FROM projects p
INNER JOIN project_members pm ON p.id = pm.project_id
WHERE pm.user_id = ? 
  AND p.status = 1
ORDER BY p.last_activity_at DESC
LIMIT ?, ?;

-- 2. è·å–é¡¹ç›®æ–‡ä»¶æ ‘
SELECT 
    file_path,
    file_name,
    type,
    size,
    last_edited_at
FROM project_files
WHERE project_id = ?
  AND file_path LIKE CONCAT(?, '%')
ORDER BY type DESC, file_name ASC;

-- 3. æ£€æŸ¥ç”¨æˆ·é¡¹ç›®æƒé™
SELECT pm.role
FROM project_members pm
WHERE pm.project_id = ? 
  AND pm.user_id = ?
LIMIT 1;
```

#### ç´¢å¼•ä¼˜åŒ–å»ºè®®
```sql
-- å¤åˆç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_project_members_user_project ON project_members(user_id, project_id);
CREATE INDEX idx_project_files_project_path ON project_files(project_id, file_path);
CREATE INDEX idx_projects_owner_status ON projects(owner_id, status);

-- æŸ¥è¯¢æ€§èƒ½åˆ†æ
EXPLAIN SELECT p.*, pm.role 
FROM projects p 
INNER JOIN project_members pm ON p.id = pm.project_id 
WHERE pm.user_id = 12345;
```

### Redis æ€§èƒ½ä¼˜åŒ–

#### è¿æ¥æ± é…ç½®
```yaml
# application.yml
spring:
  redis:
    host: localhost
    port: 6379
    password: your_password
    database: 0
    timeout: 2000ms
    lettuce:
      pool:
        max-active: 20
        max-idle: 8
        min-idle: 2
        max-wait: 2000ms
```

#### æ‰¹é‡æ“ä½œä¼˜åŒ–
```java
@Service
public class RedisBatchService {
    
    public void batchUpdateUserSessions(Map<String, UserSession> sessions) {
        // ä½¿ç”¨Pipelineæ‰¹é‡æ“ä½œ
        redisTemplate.executePipelined(new RedisCallback<Object>() {
            @Override
            public Object doInRedis(RedisConnection connection) {
                sessions.forEach((userId, session) -> {
                    String key = "user:session:" + userId;
                    String value = JSON.toJSONString(session);
                    connection.setEx(key.getBytes(), 7200, value.getBytes());
                });
                return null;
            }
        });
    }
}
```

---

## ğŸ¯ æ•°æ®åº“ç›‘æ§å’Œç»´æŠ¤

### ç›‘æ§æŒ‡æ ‡

#### MySQL å…³é”®æŒ‡æ ‡
```sql
-- æŸ¥è¯¢æ€§èƒ½ç›‘æ§
SELECT 
    schema_name,
    digest_text,
    avg_timer_wait/1000000000 as avg_exec_time_sec,
    exec_count,
    sum_timer_wait/1000000000 as total_exec_time_sec
FROM performance_schema.events_statements_summary_by_digest 
WHERE schema_name = 'codivio_project'
ORDER BY avg_timer_wait DESC 
LIMIT 10;

-- è¿æ¥æ•°ç›‘æ§
SHOW GLOBAL STATUS LIKE 'Threads_connected';
SHOW GLOBAL STATUS LIKE 'Max_used_connections';

-- ç¼“å†²æ± å‘½ä¸­ç‡
SHOW GLOBAL STATUS LIKE 'Innodb_buffer_pool_reads';
SHOW GLOBAL STATUS LIKE 'Innodb_buffer_pool_read_requests';
```

#### Redis ç›‘æ§æŒ‡æ ‡
```bash
# Redisæ€§èƒ½ç›‘æ§å‘½ä»¤
redis-cli INFO stats
redis-cli INFO memory
redis-cli INFO clients
redis-cli SLOWLOG GET 10

# é”®ç©ºé—´åˆ†æ
redis-cli --bigkeys
redis-cli --memkeys
```

### å¤‡ä»½å’Œæ¢å¤

#### MySQL å¤‡ä»½ç­–ç•¥
```bash
#!/bin/bash
# æ¯æ—¥å¤‡ä»½è„šæœ¬

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/var/backups/mysql"

# å¤‡ä»½ç”¨æˆ·æ•°æ®åº“
mysqldump -u backup_user -p codivio_user \
  --single-transaction \
  --routines \
  --triggers \
  > $BACKUP_DIR/codivio_user_$DATE.sql

# å¤‡ä»½é¡¹ç›®æ•°æ®åº“
mysqldump -u backup_user -p codivio_project \
  --single-transaction \
  --routines \
  --triggers \
  > $BACKUP_DIR/codivio_project_$DATE.sql

# å‹ç¼©å¤‡ä»½æ–‡ä»¶
gzip $BACKUP_DIR/codivio_*_$DATE.sql

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete
```

#### Redis å¤‡ä»½ç­–ç•¥
```bash
#!/bin/bash
# Rediså¤‡ä»½è„šæœ¬

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/var/backups/redis"

# æ‰§è¡ŒBGSAVE
redis-cli BGSAVE

# ç­‰å¾…å¤‡ä»½å®Œæˆ
while [ $(redis-cli LASTSAVE) -eq $LASTSAVE ]; do
  sleep 1
done

# å¤åˆ¶RDBæ–‡ä»¶
cp /var/lib/redis/dump.rdb $BACKUP_DIR/dump_$DATE.rdb
gzip $BACKUP_DIR/dump_$DATE.rdb

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "dump_*.rdb.gz" -mtime +7 -delete
```

---

## ğŸ¯ é¢è¯•å‡†å¤‡è¦ç‚¹

### ğŸ’¡ æŠ€æœ¯äº®ç‚¹

1. **å¾®æœåŠ¡æ•°æ®åº“éš”ç¦»** - æ¯ä¸ªæœåŠ¡ç‹¬ç«‹æ•°æ®åº“ï¼Œé¿å…æ•°æ®è€¦åˆ
2. **å¤šæ•°æ®æºæ¶æ„** - MySQL + Redis + RabbitMQ ç»„åˆä½¿ç”¨  
3. **ç¼“å­˜åˆ†å±‚è®¾è®¡** - æŒ‰ä¸šåŠ¡ç‰¹æ€§åˆç†é…ç½®ç¼“å­˜ç­–ç•¥
4. **äº‹ä»¶é©±åŠ¨ä¸€è‡´æ€§** - é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—ä¿è¯æ•°æ®æœ€ç»ˆä¸€è‡´æ€§
5. **æ€§èƒ½ä¼˜åŒ–å®è·µ** - ç´¢å¼•è®¾è®¡ã€æŸ¥è¯¢ä¼˜åŒ–ã€è¿æ¥æ± é…ç½®

### ğŸ¯ å¸¸è§é¢è¯•é—®é¢˜

#### 1. "ä¸ºä»€ä¹ˆä¸ä½¿ç”¨å•ä¸€æ•°æ®åº“è€Œè¦åˆ†åº“ï¼Ÿ"
```yaml
å›ç­”è¦ç‚¹:
  - å¾®æœåŠ¡æ¶æ„åŸåˆ™ï¼Œæ•°æ®ç‹¬ç«‹æ€§
  - æœåŠ¡è¾¹ç•Œæ¸…æ™°ï¼Œé¿å…æ•°æ®è€¦åˆ
  - æ”¯æŒç‹¬ç«‹æ‰©å±•å’ŒæŠ€æœ¯é€‰å‹
  - æ•…éšœéš”ç¦»ï¼Œå•ä¸ªæœåŠ¡æ•…éšœä¸å½±å“å…¨å±€
  - ç¬¦åˆDDDé¢†åŸŸé©±åŠ¨è®¾è®¡æ€æƒ³
```

#### 2. "å¦‚ä½•ä¿è¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ•°æ®ä¸€è‡´æ€§ï¼Ÿ"
```yaml
å›ç­”è¦ç‚¹:
  - é‡‡ç”¨æœ€ç»ˆä¸€è‡´æ€§è€Œéå¼ºä¸€è‡´æ€§
  - äº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—åŒæ­¥
  - è¡¥å¿æœºåˆ¶å¤„ç†å¤±è´¥åœºæ™¯
  - å¹‚ç­‰æ€§è®¾è®¡é¿å…é‡å¤å¤„ç†
  - ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶åŠæ—¶å‘ç°é—®é¢˜
```

#### 3. "Redisåœ¨ç³»ç»Ÿä¸­çš„ä½œç”¨å’Œä»·å€¼ï¼Ÿ"
```yaml
å›ç­”è¦ç‚¹:
  - é«˜æ€§èƒ½ç¼“å­˜ï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›
  - ä¼šè¯å­˜å‚¨ï¼Œæ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²
  - å®æ—¶æ•°æ®å­˜å‚¨ï¼Œæ”¯æŒåä½œåŠŸèƒ½
  - åˆ†å¸ƒå¼é”ï¼Œä¿è¯å¹¶å‘å®‰å…¨
  - æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè§£è€¦æœåŠ¡é€šä¿¡
```

#### 4. "å¦‚ä½•è®¾è®¡æ•°æ®åº“ç´¢å¼•ï¼Ÿ"
```yaml
å›ç­”è¦ç‚¹:
  - åˆ†ææŸ¥è¯¢åœºæ™¯ï¼Œåˆ›å»ºåˆé€‚ç´¢å¼•
  - å¤åˆç´¢å¼•è€ƒè™‘å­—æ®µé¡ºåº
  - é¿å…è¿‡å¤šç´¢å¼•å½±å“å†™æ€§èƒ½
  - å®šæœŸåˆ†ææ…¢æŸ¥è¯¢ä¼˜åŒ–ç´¢å¼•
  - è€ƒè™‘è¦†ç›–ç´¢å¼•å‡å°‘å›è¡¨
```

### ğŸš€ æ‰©å±•è®¾è®¡æ€è€ƒ

å½“é¢è¯•å®˜é—®"å¦‚æœæ•°æ®é‡å¢é•¿1000å€æ€ä¹ˆåŠï¼Ÿ"

```yaml
æ•°æ®åº“å±‚é¢:
  - åˆ†åº“åˆ†è¡¨ï¼ŒæŒ‰ä¸šåŠ¡ç»´åº¦æ°´å¹³æ‹†åˆ†
  - è¯»å†™åˆ†ç¦»ï¼Œä¸»ä»å¤åˆ¶åˆ†æ‹…è¯»å‹åŠ›
  - æ•°æ®å½’æ¡£ï¼Œå†å²æ•°æ®è¿ç§»åˆ°å½’æ¡£åº“

ç¼“å­˜å±‚é¢:
  - Redisé›†ç¾¤ï¼Œæ”¯æŒæ›´å¤§å†…å­˜å®¹é‡
  - å¤šçº§ç¼“å­˜ï¼Œæœ¬åœ°ç¼“å­˜ + åˆ†å¸ƒå¼ç¼“å­˜
  - ç¼“å­˜é¢„çƒ­ï¼Œçƒ­ç‚¹æ•°æ®æå‰åŠ è½½

å­˜å‚¨å±‚é¢:
  - åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨å¤§æ–‡ä»¶
  - å¯¹è±¡å­˜å‚¨æœåŠ¡æ›¿ä»£æœ¬åœ°å­˜å‚¨
  - CDNåŠ é€Ÿé™æ€èµ„æºè®¿é—®
```