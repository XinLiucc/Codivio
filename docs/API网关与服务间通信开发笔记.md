# API网关与服务间通信开发笔记

> 📚 记录API网关集成、统一认证、服务间通信以及微服务架构实现的技术笔记和开发进展

---

## 📅 2025-08-28 - 网关服务开发计划制定

### 🎯 开发目标

#### 1. API网关核心功能实现
- 统一入口点: 所有外部请求通过网关路由到具体服务
- 路由配置: 用户服务(8081)和项目服务(8082)的智能路由
- 负载均衡: 支持服务多实例部署的请求分发
- 请求转发: 保持原始请求头和参数的完整传递

#### 2. 统一认证中心设计
- JWT Token统一验证: 在网关层验证所有需要认证的请求
- 白名单管理: 登录、注册等公开接口无需认证
- 用户信息传递: 验证成功后传递userId到下游服务
- 认证失败处理: 统一的401/403错误响应格式

#### 3. 微服务架构集成
- 服务发现: 通过服务名而非IP地址进行服务间通信
- 健康检查: 各服务的健康状态监控和故障转移
- 链路追踪: 请求在微服务间的完整调用链路记录
- 配置管理: 统一的配置文件管理和环境变量注入

### 📋 技术学习重点

#### Spring Cloud Gateway核心概念
- Route(路由): 网关的基本构建块，定义请求匹配和转发规则
- Predicate(断言): 匹配请求的条件，如路径、方法、头信息等
- Filter(过滤器): 请求和响应的处理逻辑，支持前置和后置处理
- Gateway Handler Mapping: 路由解析和请求分发机制

#### 认证授权架构设计
- 无状态认证: JWT Token机制避免session共享问题
- 认证流程: 网关验证 → 用户信息提取 → 下游服务传递
- 权限控制: 基于角色的访问控制(RBAC)集成
- 安全策略: CORS、CSRF、XSS等安全防护

#### 微服务通信模式
- 同步通信: HTTP/HTTPS RESTful API调用
- 服务注册与发现: 动态服务实例管理
- 容错机制: 超时、重试、熔断、降级策略
- 分布式追踪: 请求ID传递和调用链监控

---

## 📋 开发任务分解

### 阶段1: 网关基础配置 (预计1天)

#### 1.1 Gateway依赖配置
- [ ] 添加Spring Cloud Gateway Starter依赖
- [ ] 配置Gateway应用主类和端口(8080)
- [ ] 验证Gateway服务独立启动成功

#### 1.2 基础路由配置
- [ ] 配置用户服务路由: `/api/v1/auth/**` → `http://user-service:8081`
- [ ] 配置项目服务路由: `/api/v1/projects/**` → `http://project-service:8082`
- [ ] 测试路由转发功能: 通过网关访问各服务接口

#### 1.3 服务发现集成
- [ ] Docker网络配置: 确保服务间可通过服务名访问
- [ ] 健康检查配置: `/actuator/health`端点
- [ ] 服务状态监控: 各服务的可用性检测

### 阶段2: 统一认证实现 (预计2天)

#### 2.1 JWT验证过滤器
- [ ] 创建JwtAuthenticationFilter全局过滤器
- [ ] JWT Token解析和验证逻辑
- [ ] 用户信息提取: userId、username、roles
- [ ] 请求头注入: 传递用户信息到下游服务

#### 2.2 认证路径管理
- [ ] 白名单配置: 登录、注册、健康检查等公开接口
- [ ] 认证规则: 需要JWT验证的接口路径
- [ ] 权限分级: 不同接口的权限要求

#### 2.3 错误处理集成
- [ ] 认证失败响应: 401 Unauthorized统一格式
- [ ] 权限不足响应: 403 Forbidden统一格式
- [ ] 异常处理器: 与现有全局异常处理体系集成

### 阶段3: 服务间通信优化 (预计1天)

#### 3.1 请求转发优化
- [ ] 请求头保持: Authorization、Content-Type等
- [ ] 响应格式统一: ResultVO格式在网关层处理
- [ ] 超时配置: 各服务的响应超时设置
- [ ] 重试机制: 网络异常的自动重试策略

#### 3.2 负载均衡配置
- [ ] 轮询策略: 多服务实例的请求分发
- [ ] 健康检查: 不可用实例的自动排除
- [ ] 故障转移: 服务实例故障的请求重定向

#### 3.3 监控和日志
- [ ] 访问日志: 记录所有通过网关的请求
- [ ] 性能监控: 响应时间、吞吐量统计
- [ ] 错误追踪: 异常请求的详细日志记录

### 阶段4: 集成测试验证 (预计1天)

#### 4.1 端到端测试
- [ ] 用户注册登录流程: 通过网关的完整认证测试
- [ ] 项目管理操作: 创建、查询、更新、删除项目
- [ ] 成员管理操作: 添加、移除、角色变更测试
- [ ] 权限验证: 不同用户角色的访问控制测试

#### 4.2 异常场景测试
- [ ] 服务不可用: 后端服务停止时的网关响应
- [ ] 认证失败: 无效JWT Token的处理
- [ ] 网络异常: 超时、连接失败的处理
- [ ] 并发测试: 高并发请求的处理能力

---

## 📊 技术架构图

### 当前系统架构
```
                    外部请求
                       ↓
                   API网关:8080
                  ┌─────────────┐
                  │   Gateway   │
                  │  统一认证   │
                  │  路由转发   │
                  └─────────────┘
                       ↓
          ┌─────────────┼─────────────┐
          ↓                           ↓
   用户服务:8081                项目服务:8082
  ┌─────────────┐              ┌─────────────┐
  │User Service │              │Project      │
  │- 用户CRUD   │              │Service      │
  │- JWT认证    │              │- 项目管理   │
  │- 权限管理   │              │- 成员管理   │
  └─────────────┘              └─────────────┘
          ↓                           ↓
    codivio_user                codivio_project
      数据库                         数据库
```

### 目标微服务架构
```
                     客户端请求
                        ↓
                   API网关:8080
              ┌──────────────────────┐
              │    Gateway Service    │
              │  - 统一认证 (JWT)    │
              │  - 路由转发          │
              │  - 负载均衡          │
              │  - 限流熔断          │
              └──────────────────────┘
                        ↓
        ┌───────────────┼───────────────┐
        ↓               ↓               ↓
   用户服务:8081   项目服务:8082   协作服务:8083
  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
  │User Service │ │Project      │ │Collaboration│
  │             │ │Service      │ │Service      │
  └─────────────┘ └─────────────┘ └─────────────┘
        ↓               ↓               ↓
  codivio_user   codivio_project  Redis缓存
     数据库           数据库        实时状态
```

---

## 💡 关键技术决策记录

### 认证策略选择
- **决策**: 采用网关统一认证 + JWT Token传递模式
- **原因**: 
  1. 避免各服务重复认证逻辑
  2. 便于统一的安全策略管理
  3. 支持无状态的水平扩展
- **实现**: JWT在网关验证，userId通过请求头传递

### 路由配置原则
- **路径前缀匹配**: `/api/v1/auth/**` → 用户服务
- **服务名解析**: 使用Docker服务名而非IP地址
- **版本控制**: API版本号统一管理和路由

### 异常处理统一
- **网关层**: 认证、路由异常处理
- **服务层**: 业务异常通过网关透传
- **响应格式**: 保持ResultVO统一响应格式

---

## 🔍 学习资源和参考文档

### Spring Cloud Gateway官方文档
- [Spring Cloud Gateway Reference](https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/)
- Gateway Filter、Predicate配置详解
- 认证和授权集成指南

### JWT认证最佳实践
- JWT Token结构和安全注意事项
- 无状态认证架构设计
- Token刷新和过期处理机制

### 微服务架构模式
- API网关模式(Gateway Pattern)
- 服务发现模式(Service Discovery)
- 统一认证模式(Unified Authentication)

---

## 📝 开发规范要求

### 代码质量标准
- 遵循现有的代码规范和命名约定
- 完整的异常处理和日志记录
- 详细的配置注释和文档说明

### Git提交规范
- `feat(gateway): 功能描述` - 新功能开发
- `fix(gateway): 问题描述` - 问题修复
- `config(gateway): 配置说明` - 配置修改

### 测试要求
- 每个功能点的单元测试
- 集成测试覆盖主要业务场景
- 异常场景的测试用例

---

## 🎯 开发里程碑

### 第1周目标 (本周)
- ✅ 网关服务开发笔记创建
- 🎯 基础路由配置完成
- 🎯 统一认证中心实现
- 🎯 与现有服务的集成测试

### 第2周目标 (下周)
- 🎯 服务间通信优化 (OpenFeign集成)
- 🎯 负载均衡和容错机制
- 🎯 Docker Compose整体部署验证
- 🎯 性能监控和日志系统

---

*创建时间: 2025-08-28*  
*基于: 用户服务和项目服务100%完成*  
*下一步: API网关路由配置实现*