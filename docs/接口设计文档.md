# Codivio RESTful API 设计文档

## 🎯 设计理念

本API设计遵循RESTful架构原则，专注于**MVP核心功能**，提供清晰的接口规范和良好的开发体验。

### 核心特性
- 🔗 **RESTful设计** - 资源导向，语义清晰
- 🔐 **JWT认证** - 无状态认证，安全可靠  
- 🚀 **统一响应** - 标准化数据格式
- ⚡ **实时通信** - WebSocket支持协作编辑
- 📊 **版本管理** - API版本控制策略

## 📋 接口概览

### 基础信息
```yaml
生产环境: https://api.codivio.dev/v1
开发环境: http://localhost:8080/api/v1
认证方式: JWT Bearer Token
请求格式: application/json
响应格式: application/json
字符编码: UTF-8
```

### 统一响应格式
```json
{
  "code": 200,
  "message": "success", 
  "data": {},
  "timestamp": 1640995200000
}
```

### HTTP状态码规范
| 状态码 | 含义 | 使用场景 |
|--------|------|----------|
| 200 | 成功 | 请求成功处理 |
| 201 | 已创建 | 资源创建成功 |
| 400 | 请求错误 | 参数验证失败 |
| 401 | 未认证 | Token无效或缺失 |
| 403 | 无权限 | 权限验证失败 |
| 404 | 未找到 | 资源不存在 |
| 429 | 限流 | 请求频率超限 |
| 500 | 服务器错误 | 系统内部异常 |

---

## 👤 用户服务 API (User Service)

### 1. 用户注册
```http
POST /api/v1/auth/register
Content-Type: application/json

{
  "username": "john_doe",
  "email": "john@example.com", 
  "password": "SecurePass123!",
  "nickname": "John"
}
```

**成功响应** (201):
```json
{
  "code": 201,
  "message": "注册成功",
  "data": {
    "userId": 12345,
    "username": "john_doe",
    "email": "john@example.com",
    "nickname": "John",
    "avatar": "https://avatar.codivio.dev/default.png",
    "createdAt": "2024-01-15T10:30:00Z"
  }
}
```

### 2. 用户登录
```http
POST /api/v1/auth/login
Content-Type: application/json

{
  "username": "john_doe",
  "password": "SecurePass123!"
}
```

**成功响应** (200):
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "tokenType": "Bearer",
    "expiresIn": 3600,
    "user": {
      "userId": 12345,
      "username": "john_doe",
      "email": "john@example.com",
      "nickname": "John",
      "avatar": "https://avatar.codivio.dev/john.png"
    }
  }
}
```

### 3. 获取当前用户信息
```http
GET /api/v1/users/me
Authorization: Bearer <access_token>
```

**成功响应** (200):
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "userId": 12345,
    "username": "john_doe",
    "email": "john@example.com",
    "nickname": "John", 
    "avatar": "https://avatar.codivio.dev/john.png",
    "createdAt": "2024-01-01T00:00:00Z",
    "lastLoginAt": "2024-01-15T10:30:00Z"
  }
}
```

### 4. 用户登出
```http
POST /api/v1/auth/logout
Authorization: Bearer <access_token>
```

**成功响应** (200):
```json
{
  "code": 200,
  "message": "登出成功"
}
```

---

## 📁 项目服务 API (Project Service)

### 1. 创建项目
```http
POST /api/v1/projects
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "name": "My React Project",
  "description": "一个学习React的协作项目",
  "language": "javascript"
}
```

**成功响应** (201):
```json
{
  "code": 201,
  "message": "项目创建成功",
  "data": {
    "projectId": "proj_abc123",
    "name": "My React Project", 
    "description": "一个学习React的协作项目",
    "language": "javascript",
    "owner": {
      "userId": 12345,
      "username": "john_doe",
      "nickname": "John"
    },
    "createdAt": "2024-01-15T10:30:00Z"
  }
}
```

### 2. 获取项目列表
```http
GET /api/v1/projects?page=1&size=20
Authorization: Bearer <access_token>
```

**成功响应** (200):
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "projects": [
      {
        "projectId": "proj_abc123",
        "name": "My React Project",
        "description": "一个学习React的协作项目", 
        "language": "javascript",
        "owner": {
          "userId": 12345,
          "username": "john_doe"
        },
        "memberCount": 2,
        "lastActivity": "2024-01-15T10:30:00Z",
        "createdAt": "2024-01-10T08:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "size": 20,
      "total": 5,
      "totalPages": 1
    }
  }
}
```

### 3. 获取项目详情
```http
GET /api/v1/projects/{projectId}
Authorization: Bearer <access_token>
```

**成功响应** (200):
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "projectId": "proj_abc123",
    "name": "My React Project",
    "description": "一个学习React的协作项目",
    "language": "javascript", 
    "owner": {
      "userId": 12345,
      "username": "john_doe",
      "nickname": "John"
    },
    "members": [
      {
        "userId": 12345,
        "username": "john_doe",
        "nickname": "John", 
        "role": "owner",
        "joinedAt": "2024-01-10T08:00:00Z"
      },
      {
        "userId": 67890,
        "username": "jane_smith",
        "nickname": "Jane",
        "role": "editor", 
        "joinedAt": "2024-01-12T14:20:00Z"
      }
    ],
    "createdAt": "2024-01-10T08:00:00Z",
    "updatedAt": "2024-01-15T10:30:00Z"
  }
}
```

### 4. 邀请项目成员
```http
POST /api/v1/projects/{projectId}/members
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "username": "jane_smith",
  "role": "editor"
}
```

**成功响应** (201):
```json
{
  "code": 201,
  "message": "成员邀请成功",
  "data": {
    "userId": 67890,
    "username": "jane_smith",
    "role": "editor",
    "joinedAt": "2024-01-15T10:30:00Z"
  }
}
```

### 5. 获取文件树
```http
GET /api/v1/projects/{projectId}/files
Authorization: Bearer <access_token>
```

**成功响应** (200):
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "tree": [
      {
        "name": "src",
        "type": "directory",
        "path": "/src",
        "children": [
          {
            "name": "App.js",
            "type": "file", 
            "path": "/src/App.js",
            "size": 1024,
            "lastModified": "2024-01-15T10:30:00Z"
          },
          {
            "name": "index.js",
            "type": "file",
            "path": "/src/index.js", 
            "size": 512,
            "lastModified": "2024-01-14T16:20:00Z"
          }
        ]
      },
      {
        "name": "package.json",
        "type": "file",
        "path": "/package.json",
        "size": 256,
        "lastModified": "2024-01-10T08:00:00Z"
      }
    ]
  }
}
```

### 6. 获取文件内容（通过文件ID）
```http
GET /api/v1/projects/{projectId}/files/{fileId}/content
Authorization: Bearer <access_token>
```

**说明**: 项目服务负责验证权限和获取文件ID，然后调用文件服务获取内容

**成功响应** (200):
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "fileId": "file_abc123",
    "path": "/src/App.js",
    "content": "import React from 'react';\n\nfunction App() {\n  return (\n    <div className=\"App\">\n      <h1>Hello, Codivio!</h1>\n    </div>\n  );\n}\n\nexport default App;",
    "size": 1024,
    "version": 1,
    "lastModified": "2024-01-15T10:30:00Z"
  }
}
```

### 7. 保存文件内容
```http
PUT /api/v1/projects/{projectId}/files/{fileId}/content
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "content": "import React from 'react';\n\nfunction App() {\n  return (\n    <div className=\"App\">\n      <h1>Hello, Codivio World!</h1>\n    </div>\n  );\n}\n\nexport default App;",
  "changeComment": "更新欢迎文本"
}
```

**成功响应** (200):
```json
{
  "code": 200,
  "message": "文件保存成功",
  "data": {
    "path": "/src/App.js",
    "size": 1056,
    "lastModified": "2024-01-15T10:35:00Z"
  }
}
```

### 8. 创建文件树节点
```http
POST /api/v1/projects/{projectId}/files/tree
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "path": "/src/components/Button.js",
  "name": "Button.js",
  "type": "file",
  "parentPath": "/src/components"
}
```

**成功响应** (201):
```json
{
  "code": 201,
  "message": "文件树节点创建成功",
  "data": {
    "path": "/src/components/Button.js",
    "name": "Button.js",
    "type": "file",
    "fileId": "file_xyz789",
    "createdAt": "2024-01-15T10:40:00Z"
  }
}
```

**说明**: 创建文件类型节点时，会自动在文件服务中创建对应的空文件

### 9. 删除文件树节点
```http
DELETE /api/v1/projects/{projectId}/files/tree?path=/src/OldComponent.js
Authorization: Bearer <access_token>
```

**成功响应** (200):
```json
{
  "code": 200,
  "message": "文件树节点删除成功"
}
```

**说明**: 删除文件类型节点时，会通知文件服务删除对应的物理文件

---

## 📎 文件服务 API (File Service)

### 1. 文件上传
```http
POST /api/v1/files/upload
Authorization: Bearer <access_token>
Content-Type: multipart/form-data

{
  "file": <file_binary>,
  "projectId": "proj_abc123",
  "path": "/assets/images/",
  "description": "项目图标文件"
}
```

**成功响应** (201):
```json
{
  "code": 201,
  "message": "文件上传成功",
  "data": {
    "fileId": "file_def456",
    "fileName": "logo.png",
    "originalName": "company-logo.png",
    "filePath": "/assets/images/logo.png",
    "size": 15360,
    "mimeType": "image/png",
    "url": "https://files.codivio.dev/proj_abc123/assets/images/logo.png",
    "uploadedAt": "2024-01-15T10:30:00Z"
  }
}
```

### 2. 文件下载
```http
GET /api/v1/files/{fileId}/download
Authorization: Bearer <access_token>
```

**成功响应** (200):
```http
HTTP/1.1 200 OK
Content-Type: image/png
Content-Disposition: attachment; filename="logo.png"
Content-Length: 15360

[文件二进制内容]
```

### 3. 获取文件信息
```http
GET /api/v1/files/{fileId}
Authorization: Bearer <access_token>
```

**成功响应** (200):
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "fileId": "file_def456",
    "fileName": "logo.png",
    "originalName": "company-logo.png",
    "filePath": "/assets/images/logo.png",
    "size": 15360,
    "mimeType": "image/png",
    "projectId": "proj_abc123",
    "uploadedBy": {
      "userId": 12345,
      "username": "john_doe"
    },
    "url": "https://files.codivio.dev/proj_abc123/assets/images/logo.png",
    "createdAt": "2024-01-15T10:30:00Z",
    "updatedAt": "2024-01-15T10:30:00Z"
  }
}
```

### 4. 批量文件上传
```http
POST /api/v1/files/batch-upload
Authorization: Bearer <access_token>
Content-Type: multipart/form-data

{
  "files": [<file1_binary>, <file2_binary>],
  "projectId": "proj_abc123",
  "path": "/documents/"
}
```

### 5. 删除文件
```http
DELETE /api/v1/files/{fileId}
Authorization: Bearer <access_token>
```

**成功响应** (200):
```json
{
  "code": 200,
  "message": "文件删除成功"
}
```

### 6. 获取项目文件列表
```http
GET /api/v1/files?projectId={projectId}&path=/assets/&page=1&size=20
Authorization: Bearer <access_token>
```

**成功响应** (200):
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "files": [
      {
        "fileId": "file_def456",
        "fileName": "logo.png",
        "filePath": "/assets/images/logo.png",
        "size": 15360,
        "mimeType": "image/png",
        "url": "https://files.codivio.dev/proj_abc123/assets/images/logo.png",
        "createdAt": "2024-01-15T10:30:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "size": 20,
      "total": 1,
      "totalPages": 1
    }
  }
}
```

### 7. 文件预览链接
```http
GET /api/v1/files/{fileId}/preview
Authorization: Bearer <access_token>
```

**成功响应** (200):
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "previewUrl": "https://files.codivio.dev/preview/proj_abc123/logo.png?token=temp_access_token",
    "thumbnailUrl": "https://files.codivio.dev/thumbnail/proj_abc123/logo.png?token=temp_access_token",
    "expiresAt": "2024-01-15T11:30:00Z"
  }
}
```

### 8. 创建空文件（内部API）
```http
POST /api/v1/files/internal/create
Authorization: Bearer <service_token>
Content-Type: application/json

{
  "projectId": "proj_abc123",
  "fileName": "Button.js",
  "mimeType": "text/javascript",
  "content": ""
}
```

**说明**: 此API供项目服务调用，创建文件树节点时使用

### 9. 获取文件内容（内部API）
```http
GET /api/v1/files/internal/{fileId}/content
Authorization: Bearer <service_token>
```

**成功响应** (200):
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "fileId": "file_abc123",
    "content": "import React from 'react';...",
    "version": 1,
    "size": 1024,
    "mimeType": "text/javascript",
    "lastModified": "2024-01-15T10:30:00Z"
  }
}
```

### 10. 更新文件内容（内部API）
```http
PUT /api/v1/files/internal/{fileId}/content
Authorization: Bearer <service_token>
Content-Type: application/json

{
  "content": "updated file content",
  "changedBy": 12345,
  "changeComment": "修改说明"
}
```

### 11. 删除文件（内部API）
```http
DELETE /api/v1/files/internal/{fileId}
Authorization: Bearer <service_token>
```

**说明**: 这些内部API供其他微服务调用，不对外开放

---

## ⚡ 协作服务 API (Collaboration Service)

### WebSocket 连接规范

#### 连接地址
```javascript
// 开发环境
const wsUrl = 'ws://localhost:8083/ws/editor';
// 生产环境  
const wsUrl = 'wss://collab.codivio.dev/ws/editor';

const socket = new WebSocket(wsUrl);
```

#### 连接认证
```javascript
// 连接建立后发送认证消息
socket.onopen = function() {
  socket.send(JSON.stringify({
    type: 'auth',
    data: {
      token: 'your_jwt_token'
    }
  }));
};
```

### WebSocket 消息格式

#### 1. 加入文档编辑
```json
{
  "type": "join-document",
  "data": {
    "projectId": "proj_abc123",
    "filePath": "/src/App.js",
    "userId": 12345
  }
}
```

**服务器响应**:
```json
{
  "type": "document-joined",
  "data": {
    "documentId": "doc_proj_abc123_src_App_js",
    "content": "import React from 'react';...",
    "version": 42,
    "activeUsers": [
      {
        "userId": 12345,
        "username": "john_doe",
        "cursorPosition": 120,
        "cursorColor": "#ff6b6b"
      }
    ]
  }
}
```

#### 2. 编辑操作 (Operation Transformation)
```json
{
  "type": "operation",
  "data": {
    "documentId": "doc_proj_abc123_src_App_js",
    "operation": {
      "type": "insert",
      "position": 100,
      "text": "Hello, World!",
      "timestamp": 1640995200000
    }
  }
}
```

**操作类型**:
- `insert`: 插入文本
- `delete`: 删除文本  
- `retain`: 保留文本

#### 3. 光标位置同步
```json
{
  "type": "cursor-update",
  "data": {
    "documentId": "doc_proj_abc123_src_App_js", 
    "position": 150,
    "selection": {
      "start": 150,
      "end": 165
    }
  }
}
```

#### 4. 离开文档
```json
{
  "type": "leave-document",
  "data": {
    "documentId": "doc_proj_abc123_src_App_js"
  }
}
```

### HTTP 接口补充

#### 获取在线用户
```http
GET /api/v1/collaboration/documents/{documentId}/users
Authorization: Bearer <access_token>
```

**成功响应** (200):
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "activeUsers": [
      {
        "userId": 12345,
        "username": "john_doe",
        "nickname": "John",
        "joinedAt": "2024-01-15T10:30:00Z",
        "cursorPosition": 120
      }
    ],
    "totalCount": 1
  }
}
```

---

## 🔐 认证和授权

### JWT Token 结构
```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "sub": "12345",
    "username": "john_doe", 
    "roles": ["user"],
    "iat": 1640995200,
    "exp": 1640998800
  }
}
```

### 权限角色定义
```yaml
项目角色:
  owner: 项目所有者
    - 项目管理（增删改）
    - 成员管理（邀请/移除）
    - 文件操作（增删改查）
    - 实时协作（读写）
    
  editor: 项目编辑者  
    - 文件操作（增删改查）
    - 实时协作（读写）
    
  viewer: 项目查看者
    - 文件查看（只读）
    - 实时协作（只读）
```

### 权限检查中间件
```http
# 请求头携带Token
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# 响应头返回用户信息
X-User-Id: 12345
X-Username: john_doe
```

---

## 🚫 错误处理规范

### 标准错误响应
```json
{
  "code": 400,
  "message": "参数验证失败",
  "data": {
    "errors": [
      {
        "field": "username",
        "message": "用户名长度必须在3-20个字符之间"
      },
      {
        "field": "email", 
        "message": "邮箱格式不正确"
      }
    ]
  },
  "timestamp": 1640995200000
}
```

### 常见错误场景

#### 1. 认证失败 (401)
```json
{
  "code": 401,
  "message": "Token无效或已过期",
  "data": {
    "errorType": "INVALID_TOKEN",
    "suggestion": "请重新登录"
  }
}
```

#### 2. 权限不足 (403)
```json
{
  "code": 403,
  "message": "没有权限访问该资源",
  "data": {
    "errorType": "ACCESS_DENIED",
    "resource": "project:proj_abc123",
    "requiredRole": "editor"
  }
}
```

#### 3. 资源不存在 (404)
```json
{
  "code": 404,
  "message": "项目不存在",
  "data": {
    "errorType": "RESOURCE_NOT_FOUND",
    "resource": "project",
    "resourceId": "proj_xyz789"
  }
}
```

#### 4. 请求限流 (429)
```json
{
  "code": 429, 
  "message": "请求过于频繁，请稍后再试",
  "data": {
    "errorType": "RATE_LIMIT_EXCEEDED",
    "retryAfter": 60,
    "limit": 100,
    "remaining": 0
  }
}
```

---

## 📊 API 限流策略

### 限流规则
| API类型 | 限制 | 时间窗口 | 范围 |
|---------|------|----------|------|
| 认证接口 | 5次/分钟 | 滑动窗口 | 每IP |
| 普通接口 | 100次/分钟 | 滑动窗口 | 每用户 |
| WebSocket消息 | 500条/分钟 | 滑动窗口 | 每连接 |

### 限流响应头
```http
HTTP/1.1 200 OK
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 1640995260
Content-Type: application/json
```

---

## 🔧 开发调试

### API调试工具
```bash
# 使用curl测试登录接口
curl -X POST http://localhost:8080/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "john_doe",
    "password": "SecurePass123!"
  }'

# 使用获取到的token访问受保护接口
curl -X GET http://localhost:8080/api/v1/users/me \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

### WebSocket调试
```javascript
// 浏览器控制台调试WebSocket
const ws = new WebSocket('ws://localhost:8083/ws/editor');

ws.onopen = () => {
  console.log('WebSocket连接建立');
  // 发送认证消息
  ws.send(JSON.stringify({
    type: 'auth',
    data: { token: 'YOUR_JWT_TOKEN' }
  }));
};

ws.onmessage = (event) => {
  console.log('收到消息:', JSON.parse(event.data));
};
```

---

## 📈 面试准备要点

### 💡 技术亮点
1. **RESTful设计原则** - 资源导向，状态码语义清晰
2. **微服务API网关** - 统一入口，服务隔离
3. **JWT无状态认证** - 分布式友好，安全可靠
4. **WebSocket实时通信** - 低延迟，双向通信
5. **API版本管理** - 向后兼容，平滑升级

### 🎯 常见面试问题

#### 1. "为什么选择RESTful而不是GraphQL？"
```yaml
回答要点:
  - RESTful简单易懂，学习成本低
  - 缓存策略成熟，HTTP缓存直接可用
  - 工具生态丰富，调试方便
  - 适合CRUD为主的业务场景
  - GraphQL更适合复杂查询场景
```

#### 2. "如何保证API的安全性？"
```yaml
回答要点:
  - JWT Token认证，无状态设计
  - HTTPS加密传输
  - 权限细粒度控制（RBAC）
  - 请求限流防止滥用
  - 参数验证防止注入攻击
```

#### 3. "如何处理API版本升级？"
```yaml
回答要点:
  - URL路径版本控制 (/v1, /v2)
  - 向后兼容原则
  - 渐进式迁移策略
  - 文档和通知机制
  - 废弃时间表规划
```

#### 4. "WebSocket相比HTTP轮询的优势？"
```yaml
回答要点:
  - 减少网络开销，双向通信
  - 降低延迟，实时性更好
  - 服务器主动推送，用户体验佳
  - 连接保持，避免频繁握手
  - 适合实时协作场景
```

### 🚀 扩展思考

当面试官问"如果系统规模扩大100倍怎么办？"时的答案：

```yaml
API网关层:
  - 网关集群部署，负载均衡
  - API缓存策略，减少后端压力
  - 限流熔断，保护后端服务

服务层:
  - 微服务水平扩容
  - 数据库读写分离
  - 缓存集群化（Redis Cluster）

协作层:
  - WebSocket连接池管理
  - 消息队列集群化
  - 操作转换算法优化
```