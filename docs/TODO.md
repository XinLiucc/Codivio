# Codivio 开发待办清单 - 第2阶段

> 基于用户服务完成后的下一阶段开发任务，专注于异常处理体系和项目服务实现

---

## 🚨 优先级1: 立即处理 (本周必须完成)

### 1.1 统一异常处理体系 ✅ 已完成
- [x] **全局异常处理器实现**
  - [x] 创建GlobalExceptionHandler类(@ControllerAdvice) 
  - [x] 处理参数验证异常(MethodArgumentNotValidException)
  - [x] 处理业务异常(BaseBusinessException)
  - [x] 处理运行时异常(RuntimeException)
  - [x] 处理通用异常(Exception)

- [x] **业务异常类体系设计**
  - [x] 创建基础业务异常类(BaseBusinessException)
  - [x] 集成ErrorCode枚举，支持错误码和消息管理
  - [x] 重构UserServiceImpl，替换所有RuntimeException
  - [x] 移除Controller层try-catch，依赖全局异常处理

- [x] **错误码管理系统**
  - [x] 设计5位数字分层错误码体系(ErrorCode.java)
  - [x] 系统级错误(1xxxx)和业务级错误(2xxxx)分类
  - [x] 用户服务错误码(202xx)和项目服务预留(203xx)
  - [x] 完成全面测试验证，所有错误码正常工作

### 1.2 项目服务基础建设 🔄 进行中

> **设计目标**: 对标用户服务的完善程度，同时快速完成以便进入微服务架构学习

#### **阶段1: 数据模型和基础配置 (2天)**
- [ ] **Project核心实体类**
  - [ ] 基础字段: id、name、description、ownerId、language、status
  - [ ] 时间戳管理: createdAt、updatedAt (JPA自动管理)
  - [ ] JPA注解配置: @Entity、@Table、索引优化
  - [ ] 参考用户服务的实体类设计规范

- [ ] **ProjectMember权限实体类**
  - [ ] 基础字段: id、projectId、userId、role、joinedAt
  - [ ] 权限枚举: ProjectRole(OWNER、EDITOR、VIEWER)
  - [ ] 唯一约束: @UniqueConstraint(projectId + userId)
  - [ ] 数据库关联设计，支持复杂查询

- [ ] **Repository层设计**
  - [ ] ProjectRepository: 继承JpaRepository，自定义查询方法
  - [ ] ProjectMemberRepository: 成员管理和权限查询
  - [ ] 分页查询、条件查询、统计查询支持
  - [ ] 对标用户服务的Repository设计水平

#### **阶段2: 业务服务层搭建 (2天)** ✅ 已完成
- [x] **ProjectService业务逻辑**
  - [x] 项目CRUD完整实现: create、findById、findByUser、update、delete
  - [x] 业务验证逻辑: 权限检查、数据验证、重复性检查
  - [x] 使用统一异常处理体系(复用已实现的ErrorCode)
  - [x] 支持分页查询和条件筛选

- [ ] **ProjectMemberService成员管理**
  - [ ] 成员管理完整功能: 添加、移除、角色变更、查询
  - [ ] 权限验证逻辑: 只有OWNER能管理成员
  - [ ] 统计功能: 成员数量、角色分布等
  - [ ] 与用户服务的数据一致性处理

#### **阶段3: Controller层和API设计 (2天)** ✅ 已完成
- [x] **ProjectController RESTful API**
  - [x] POST /api/v1/projects - 创建项目
  - [x] GET /api/v1/projects - 获取用户项目列表(分页)
  - [x] GET /api/v1/projects/{id} - 获取项目详情
  - [x] PUT /api/v1/projects/{id} - 更新项目信息
  - [x] DELETE /api/v1/projects/{id} - 删除项目

- [ ] **项目成员管理API**
  - [ ] POST /api/v1/projects/{id}/members - 添加成员
  - [ ] GET /api/v1/projects/{id}/members - 获取成员列表
  - [ ] PUT /api/v1/projects/{id}/members/{userId} - 更新成员角色
  - [ ] DELETE /api/v1/projects/{id}/members/{userId} - 移除成员

- [x] **DTO设计和参数验证**
  - [x] CreateProjectDTO、UpdateProjectDTO、ProjectResponseDTO
  - [x] Bean Validation参数验证(对标用户服务的验证水平)
  - [x] 统一ResponseVO格式，复用已有的成功/错误响应体系

#### **阶段4: 测试和文档完善 (1天)** ✅ 已完成  
- [x] **功能测试验证**
  - [x] 手动API测试: 使用curl或Postman验证所有接口
  - [x] 异常场景测试: 权限不足、参数错误、资源不存在等
  - [x] 与用户服务的集成测试: JWT认证流程验证

- [x] **文档更新**
  - [x] 更新接口设计文档: 添加项目服务的完整API规范
  - [x] 更新数据库设计文档: 反映实际实现的表结构
  - [x] 创建项目服务开发笔记: 记录实现细节和技术决策

## ⚡ 优先级2: 微服务架构集成学习 (本周内完成)

> **学习重点**: 完成单体服务开发后，立即进入微服务架构的核心学习阶段

### 2.1 API网关集成 🎯 架构核心
- [ ] **Gateway路由配置**
  - [ ] 配置用户服务路由: `/api/v1/auth/**` → `http://user-service:8081`
  - [ ] 配置项目服务路由: `/api/v1/projects/**` → `http://project-service:8082`  
  - [ ] 配置路径重写和负载均衡策略
  - [ ] 添加请求日志和监控

- [ ] **统一认证中心实现**
  - [ ] 在Gateway实现统一JWT验证过滤器
  - [ ] 配置白名单路径: `/api/v1/auth/login`, `/api/v1/auth/register`
  - [ ] 实现用户信息传递: 验证JWT后传递userId到下游服务  
  - [ ] 错误处理: 认证失败时的统一响应格式

### 2.2 服务间通信实现 🔗 微服务通信
- [ ] **项目服务调用用户服务**
  - [ ] 添加OpenFeign依赖到项目服务
  - [ ] 创建UserServiceClient: 调用用户服务验证用户存在性
  - [ ] 在添加项目成员时验证用户ID是否有效
  - [ ] 错误处理: 用户服务不可用时的降级策略

- [ ] **服务发现配置**
  - [ ] 配置各服务的服务名称和端口
  - [ ] 实现健康检查端点: `/actuator/health`
  - [ ] Docker网络配置: 服务间可以通过服务名访问
  - [ ] 负载均衡测试: 启动多个实例验证负载分发

### 2.3 分布式配置和监控 📊 运维监控
- [ ] **统一配置管理**
  - [ ] 抽取公共配置: 数据库连接、Redis配置等
  - [ ] 环境变量注入: 开发、测试、生产环境差异化配置
  - [ ] 敏感信息处理: 数据库密码、JWT密钥等

- [ ] **分布式链路追踪**
  - [ ] 添加请求ID传递: Gateway生成requestId传递给各服务
  - [ ] 日志标准化: 每个服务统一日志格式
  - [ ] 简单监控: 各服务的基础健康状态监控

### 2.4 容器化部署验证 🐳 部署实战  
- [ ] **Docker镜像优化**
  - [ ] 优化项目服务Dockerfile: 多阶段构建减小镜像体积
  - [ ] 统一基础镜像和JVM参数配置
  - [ ] 健康检查配置: HEALTHCHECK指令

- [ ] **Docker Compose整体部署**
  - [ ] 更新docker-compose.yml: 加入项目服务
  - [ ] 服务依赖关系: depends_on配置启动顺序
  - [ ] 数据持久化: 数据库数据卷挂载
  - [ ] 一键部署测试: 整个系统的端到端测试

## 📋 优先级3: 协作和文件服务扩展 (下周完成)

> **学习重点**: 基于已有的微服务架构基础，扩展实时协作功能

### 3.1 文件服务基础实现 📁 文件管理
- [ ] **文件服务核心功能**
  - [ ] 文件上传API: 支持文本文件和静态资源
  - [ ] 文件下载和预览: 基于文件ID的访问控制
  - [ ] 文件基本信息管理: 文件名、大小、类型、创建时间
  - [ ] 项目文件树结构: 与项目服务的文件树逻辑分离

- [ ] **文件服务与项目服务集成**
  - [ ] 项目服务调用文件服务: 创建/删除文件时的服务间通信
  - [ ] 权限检查联动: 确保用户只能访问有权限的项目文件
  - [ ] 文件存储路径规划: 按项目ID组织文件存储结构

### 3.2 实时协作服务基础 ⚡ WebSocket实时通信  
- [ ] **WebSocket连接管理**
  - [ ] WebSocket连接建立和认证: JWT Token验证
  - [ ] 用户连接状态管理: 在线用户列表和状态同步
  - [ ] 连接断开处理: 清理资源和通知其他用户

- [ ] **简单协作功能实现**
  - [ ] 文档编辑状态同步: 谁在编辑哪个文件
  - [ ] 光标位置同步: 显示其他用户的光标位置  
  - [ ] 简单文本同步: 基础的文本更新广播(不含冲突解决)
  - [ ] 用户状态指示: 在线状态、正在编辑状态等

### 3.3 微服务架构优化 🔧 架构进阶
- [ ] **服务健康和容错**
  - [ ] 熔断器实现: Hystrix或Resilience4j
  - [ ] 服务降级策略: 依赖服务不可用时的处理
  - [ ] 重试机制: 网络波动时的自动重试
  - [ ] 超时配置: 服务调用的超时和取消机制

- [ ] **分布式数据一致性**
  - [ ] 消息队列引入: RabbitMQ基础使用
  - [ ] 事件驱动架构: 用户创建事件、项目变更事件等  
  - [ ] 最终一致性: 跨服务数据同步的异步处理
  - [ ] 数据同步监控: 检测和处理数据不一致问题

### 3.4 前端基础集成 🖥️ 前后端联调
- [ ] **前端基础功能对接**
  - [ ] 用户注册登录页面: 对接用户服务API
  - [ ] 项目管理界面: 项目列表、创建、详情页面
  - [ ] 简单的文件浏览器: 显示项目文件树结构  
  - [ ] WebSocket连接测试: 验证实时通信功能

- [ ] **前后端集成测试**
  - [ ] JWT认证流程: 前端存储和使用JWT Token
  - [ ] API错误处理: 统一的错误信息显示
  - [ ] 分页和查询: 前端分页组件与后端分页API对接
  - [ ] 实时状态更新: WebSocket消息的前端处理

## 📊 进度跟踪

### 当前状态 (2025-08-27)
- ✅ **用户服务**: 100%完成 (认证、CRUD、异常处理、参数验证)
- ✅ **异常处理体系**: 100%完成 (全局异常处理器、错误码体系、业务异常重构)
- ✅ **项目服务**: 85%完成 (CRUD功能完成，成员管理功能待实现)
- 🔄 **API网关**: 基础搭建完成，等待路由配置和认证集成
- ❌ **协作服务**: 0% (等待项目服务完成后开始)
- ❌ **文件服务**: 0% (第3阶段开始)

### 里程碑目标 🎯
- **第2周目标**: 
  - ✅ 异常处理体系完成
  - ✅ 项目服务CRUD功能完成 (创建、查询、更新、删除、权限验证)
  - 🔄 项目成员管理功能 (添加、移除、角色变更)
  - 🔄 API网关路由配置和统一认证
- **第3周目标**:
  - 🎯 服务间通信实现 (OpenFeign、服务发现)
  - 🎯 分布式部署验证 (Docker Compose整体部署)
  - 🎯 文件服务基础功能
- **第4周目标**:
  - 🎯 实时协作服务基础 (WebSocket、简单协作)
  - 🎯 前端基础集成 (登录、项目管理界面)
  - 🎯 系统整体测试和优化

### 微服务架构学习重点 📚
1. **分布式系统设计**: 服务拆分、数据隔离、接口设计
2. **服务间通信**: HTTP调用、消息队列、事件驱动
3. **API网关模式**: 统一入口、认证授权、负载均衡
4. **容器化部署**: Docker镜像构建、服务编排、健康检查
5. **监控和运维**: 日志聚合、链路追踪、故障处理

## 🎯 阶段学习目标

### 核心技能掌握
1. **企业级异常处理**: @ControllerAdvice、自定义异常体系、错误码管理
2. **微服务数据建模**: 实体关系设计、JPA高级特性、事务管理
3. **API网关集成**: 路由配置、统一认证、负载均衡
4. **服务间通信**: OpenFeign、服务发现、容错机制

### 开发质量目标
- **代码覆盖率**: 异常处理100%覆盖所有业务场景
- **API文档**: 完整的接口文档和错误码说明
- **测试用例**: 每个API至少3个测试场景(成功、失败、边界)
- **性能基准**: 单个API响应时间<200ms

---

*创建时间: 2025-08-22*  
*基于: 用户服务100%完成的基础*
*预计完成: 2025-08-29*