# Codivio å‰ç«¯æŠ€æœ¯æ–¹æ¡ˆ

## ğŸ¯ æŠ€æœ¯æ ˆé€‰æ‹©

åŸºäºç°ä»£å‰ç«¯å¼€å‘æœ€ä½³å®è·µï¼Œæ„å»ºé«˜æ€§èƒ½ã€å¯ç»´æŠ¤çš„åä½œç¼–è¾‘å™¨å‰ç«¯åº”ç”¨ã€‚

### æ ¸å¿ƒæŠ€æœ¯æ ˆ
- ğŸš€ **Vue 3** - æ¸è¿›å¼æ¡†æ¶ï¼ŒComposition API
- ğŸ“ **TypeScript** - ç±»å‹å®‰å…¨ï¼Œä»£ç è´¨é‡ä¿è¯
- âš¡ **Vite** - ç°ä»£æ„å»ºå·¥å…·ï¼Œå¼€å‘ä½“éªŒä¼˜ç§€
- ğŸ¨ **Element Plus** - ä¼ä¸šçº§UIç»„ä»¶åº“
- ğŸ“¦ **Pinia** - ç°ä»£çŠ¶æ€ç®¡ç†æ–¹æ¡ˆ
- ğŸ”— **Monaco Editor** - VS CodeåŒæ¬¾ä»£ç ç¼–è¾‘å™¨
- ğŸŒ **WebSocket** - å®æ—¶é€šä¿¡åè®®

## ğŸ“ é¡¹ç›®ç»“æ„è®¾è®¡

```
frontend/
â”œâ”€â”€ public/                    # é™æ€èµ„æº
â”‚   â”œâ”€â”€ index.html
â”‚   â””â”€â”€ favicon.ico
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ assets/               # é™æ€èµ„æº
â”‚   â”‚   â”œâ”€â”€ styles/          # å…¨å±€æ ·å¼
â”‚   â”‚   â”œâ”€â”€ images/          # å›¾ç‰‡èµ„æº
â”‚   â”‚   â””â”€â”€ icons/           # å›¾æ ‡èµ„æº
â”‚   â”œâ”€â”€ components/          # é€šç”¨ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ common/          # åŸºç¡€ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ editor/          # ç¼–è¾‘å™¨ç»„ä»¶
â”‚   â”‚   â””â”€â”€ collaboration/   # åä½œç»„ä»¶
â”‚   â”œâ”€â”€ views/               # é¡µé¢ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ auth/           # è®¤è¯é¡µé¢
â”‚   â”‚   â”œâ”€â”€ dashboard/      # å·¥ä½œå°
â”‚   â”‚   â”œâ”€â”€ project/        # é¡¹ç›®ç®¡ç†
â”‚   â”‚   â””â”€â”€ editor/         # ç¼–è¾‘å™¨é¡µé¢
â”‚   â”œâ”€â”€ stores/             # çŠ¶æ€ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ auth.ts
â”‚   â”‚   â”œâ”€â”€ project.ts
â”‚   â”‚   â””â”€â”€ collaboration.ts
â”‚   â”œâ”€â”€ services/           # APIæœåŠ¡
â”‚   â”‚   â”œâ”€â”€ api.ts
â”‚   â”‚   â”œâ”€â”€ websocket.ts
â”‚   â”‚   â””â”€â”€ collaboration.ts
â”‚   â”œâ”€â”€ utils/              # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ request.ts
â”‚   â”‚   â”œâ”€â”€ storage.ts
â”‚   â”‚   â””â”€â”€ editor.ts
â”‚   â”œâ”€â”€ types/              # TypeScriptç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ api.ts
â”‚   â”‚   â”œâ”€â”€ user.ts
â”‚   â”‚   â””â”€â”€ collaboration.ts
â”‚   â”œâ”€â”€ router/             # è·¯ç”±é…ç½®
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ plugins/            # æ’ä»¶é…ç½®
â”‚   â”‚   â””â”€â”€ element-plus.ts
â”‚   â”œâ”€â”€ App.vue
â”‚   â””â”€â”€ main.ts
â”œâ”€â”€ package.json
â”œâ”€â”€ vite.config.ts
â”œâ”€â”€ tsconfig.json
â””â”€â”€ Dockerfile
```

---

## ğŸ¨ UI/UX è®¾è®¡æ–¹æ¡ˆ

### è®¾è®¡ç³»ç»Ÿ

#### è‰²å½©æ–¹æ¡ˆ
```scss
// ä¸»è‰²è°ƒ
$primary-color: #007bff;      // è“è‰² - ä¸»è¦æ“ä½œ
$success-color: #28a745;      // ç»¿è‰² - æˆåŠŸçŠ¶æ€
$warning-color: #ffc107;      // é»„è‰² - è­¦å‘Šæç¤º
$danger-color: #dc3545;       // çº¢è‰² - å±é™©æ“ä½œ
$info-color: #17a2b8;         // é’è‰² - ä¿¡æ¯æç¤º

// åä½œè‰²å½©ï¼ˆç”¨æˆ·æ ‡è¯†ï¼‰
$collaboration-colors: (
  user1: #ff6b6b,  // çº¢è‰²
  user2: #4ecdc4,  // é’è‰²
  user3: #45b7d1,  // è“è‰²
  user4: #96ceb4,  // ç»¿è‰²
  user5: #feca57,  // é»„è‰²
  user6: #ff9ff3,  // ç²‰è‰²
  user7: #54a0ff,  // å¤©è“è‰²
  user8: #5f27cd   // ç´«è‰²
);

// æš—è‰²ä¸»é¢˜
$dark-bg: #1e1e1e;
$dark-surface: #252526;
$dark-border: #3e3e42;
$dark-text: #cccccc;
```

#### å¸ƒå±€ç³»ç»Ÿ
```vue
<!-- ä¸»å¸ƒå±€ç»„ä»¶ -->
<template>
  <div class="app-layout">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <AppHeader />
    
    <!-- ä¸»å†…å®¹åŒº -->
    <div class="app-main">
      <!-- ä¾§è¾¹æ  -->
      <AppSidebar v-if="showSidebar" />
      
      <!-- å†…å®¹åŒºåŸŸ -->
      <div class="app-content">
        <router-view />
      </div>
    </div>
    
    <!-- çŠ¶æ€æ  -->
    <AppStatusBar />
  </div>
</template>

<style scoped>
.app-layout {
  height: 100vh;
  display: flex;
  flex-direction: column;
}

.app-main {
  flex: 1;
  display: flex;
  overflow: hidden;
}

.app-content {
  flex: 1;
  overflow: auto;
}
</style>
```

---

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. ç”¨æˆ·è®¤è¯ç³»ç»Ÿ

#### ç™»å½•ç»„ä»¶
```vue
<!-- views/auth/Login.vue -->
<template>
  <div class="login-container">
    <el-card class="login-card">
      <h2>ç™»å½• Codivio</h2>
      
      <el-form :model="loginForm" :rules="rules" ref="formRef">
        <el-form-item prop="username">
          <el-input
            v-model="loginForm.username"
            placeholder="ç”¨æˆ·å"
            prefix-icon="User"
          />
        </el-form-item>
        
        <el-form-item prop="password">
          <el-input
            v-model="loginForm.password"
            type="password"
            placeholder="å¯†ç "
            prefix-icon="Lock"
            show-password
          />
        </el-form-item>
        
        <el-form-item>
          <el-button
            type="primary"
            :loading="loading"
            @click="handleLogin"
            class="login-btn"
          >
            ç™»å½•
          </el-button>
        </el-form-item>
      </el-form>
      
      <div class="login-footer">
        <router-link to="/register">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿç«‹å³æ³¨å†Œ</router-link>
      </div>
    </el-card>
  </div>
</template>

<script setup lang="ts">
import { reactive, ref } from 'vue'
import { useRouter } from 'vue-router'
import { ElMessage } from 'element-plus'
import { useAuthStore } from '@/stores/auth'

const router = useRouter()
const authStore = useAuthStore()

const loading = ref(false)
const formRef = ref()

const loginForm = reactive({
  username: '',
  password: ''
})

const rules = {
  username: [
    { required: true, message: 'è¯·è¾“å…¥ç”¨æˆ·å', trigger: 'blur' }
  ],
  password: [
    { required: true, message: 'è¯·è¾“å…¥å¯†ç ', trigger: 'blur' }
  ]
}

const handleLogin = async () => {
  if (!formRef.value) return
  
  await formRef.value.validate(async (valid: boolean) => {
    if (!valid) return
    
    loading.value = true
    try {
      await authStore.login(loginForm)
      ElMessage.success('ç™»å½•æˆåŠŸ')
      router.push('/dashboard')
    } catch (error: any) {
      ElMessage.error(error.message || 'ç™»å½•å¤±è´¥')
    } finally {
      loading.value = false
    }
  })
}
</script>
```

#### è®¤è¯çŠ¶æ€ç®¡ç†
```typescript
// stores/auth.ts
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import { authApi } from '@/services/api'
import { getToken, setToken, removeToken } from '@/utils/storage'
import type { User, LoginParams } from '@/types/user'

export const useAuthStore = defineStore('auth', () => {
  const token = ref<string>(getToken() || '')
  const user = ref<User | null>(null)
  
  const isAuthenticated = computed(() => !!token.value)
  
  // ç™»å½•
  const login = async (params: LoginParams) => {
    const response = await authApi.login(params)
    const { accessToken, user: userInfo } = response.data
    
    token.value = accessToken
    user.value = userInfo
    setToken(accessToken)
  }
  
  // ç™»å‡º
  const logout = async () => {
    try {
      await authApi.logout()
    } catch (error) {
      console.error('ç™»å‡ºè¯·æ±‚å¤±è´¥:', error)
    } finally {
      token.value = ''
      user.value = null
      removeToken()
    }
  }
  
  // è·å–ç”¨æˆ·ä¿¡æ¯
  const fetchUserInfo = async () => {
    if (!token.value) return
    
    try {
      const response = await authApi.getUserInfo()
      user.value = response.data
    } catch (error) {
      // Tokenå¯èƒ½å·²è¿‡æœŸï¼Œæ¸…é™¤æœ¬åœ°çŠ¶æ€
      logout()
      throw error
    }
  }
  
  return {
    token,
    user,
    isAuthenticated,
    login,
    logout,
    fetchUserInfo
  }
})
```

### 2. é¡¹ç›®ç®¡ç†ç•Œé¢

#### é¡¹ç›®åˆ—è¡¨ç»„ä»¶
```vue
<!-- views/dashboard/ProjectList.vue -->
<template>
  <div class="project-list">
    <div class="project-header">
      <h2>æˆ‘çš„é¡¹ç›®</h2>
      <el-button type="primary" @click="showCreateDialog = true">
        <el-icon><Plus /></el-icon>
        æ–°å»ºé¡¹ç›®
      </el-button>
    </div>
    
    <!-- é¡¹ç›®å¡ç‰‡ç½‘æ ¼ -->
    <div class="project-grid" v-loading="loading">
      <div
        v-for="project in projects"
        :key="project.id"
        class="project-card"
        @click="openProject(project.id)"
      >
        <div class="project-info">
          <h3>{{ project.name }}</h3>
          <p class="project-desc">{{ project.description }}</p>
          
          <div class="project-meta">
            <el-tag :type="getLanguageType(project.language)">
              {{ project.language }}
            </el-tag>
            <span class="last-activity">
              {{ formatTime(project.lastActivity) }}
            </span>
          </div>
          
          <div class="project-members">
            <el-avatar-group :max="4">
              <el-avatar
                v-for="member in project.members"
                :key="member.userId"
                :src="member.avatar"
                :title="member.nickname"
                size="small"
              />
            </el-avatar-group>
            <span v-if="project.memberCount > 4" class="member-count">
              +{{ project.memberCount - 4 }}
            </span>
          </div>
        </div>
        
        <div class="project-actions">
          <el-dropdown @command="handleProjectAction">
            <el-button text>
              <el-icon><MoreFilled /></el-icon>
            </el-button>
            <template #dropdown>
              <el-dropdown-menu>
                <el-dropdown-item :command="{action: 'edit', project}">
                  ç¼–è¾‘
                </el-dropdown-item>
                <el-dropdown-item :command="{action: 'members', project}">
                  æˆå‘˜ç®¡ç†
                </el-dropdown-item>
                <el-dropdown-item :command="{action: 'delete', project}" divided>
                  åˆ é™¤
                </el-dropdown-item>
              </el-dropdown-menu>
            </template>
          </el-dropdown>
        </div>
      </div>
    </div>
    
    <!-- åˆ›å»ºé¡¹ç›®å¯¹è¯æ¡† -->
    <CreateProjectDialog
      v-model="showCreateDialog"
      @created="handleProjectCreated"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { ElMessage, ElMessageBox } from 'element-plus'
import { useProjectStore } from '@/stores/project'
import { formatRelativeTime } from '@/utils/time'
import type { Project } from '@/types/project'

const router = useRouter()
const projectStore = useProjectStore()

const loading = ref(false)
const showCreateDialog = ref(false)
const projects = ref<Project[]>([])

const getLanguageType = (language: string) => {
  const types: Record<string, string> = {
    javascript: 'warning',
    typescript: 'primary',
    python: 'success',
    java: 'danger'
  }
  return types[language] || 'info'
}

const formatTime = (time: string) => {
  return formatRelativeTime(new Date(time))
}

const openProject = (projectId: string) => {
  router.push(`/project/${projectId}`)
}

const handleProjectAction = async ({ action, project }: any) => {
  switch (action) {
    case 'edit':
      // ç¼–è¾‘é¡¹ç›®é€»è¾‘
      break
    case 'members':
      // æˆå‘˜ç®¡ç†é€»è¾‘
      break
    case 'delete':
      await handleDeleteProject(project)
      break
  }
}

const handleDeleteProject = async (project: Project) => {
  try {
    await ElMessageBox.confirm(
      `ç¡®å®šè¦åˆ é™¤é¡¹ç›® "${project.name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,
      'åˆ é™¤ç¡®è®¤',
      { type: 'warning' }
    )
    
    await projectStore.deleteProject(project.id)
    ElMessage.success('é¡¹ç›®åˆ é™¤æˆåŠŸ')
    await loadProjects()
  } catch (error: any) {
    if (error !== 'cancel') {
      ElMessage.error(error.message || 'åˆ é™¤å¤±è´¥')
    }
  }
}

const handleProjectCreated = () => {
  loadProjects()
}

const loadProjects = async () => {
  loading.value = true
  try {
    projects.value = await projectStore.fetchProjects()
  } catch (error: any) {
    ElMessage.error(error.message || 'åŠ è½½é¡¹ç›®åˆ—è¡¨å¤±è´¥')
  } finally {
    loading.value = false
  }
}

onMounted(() => {
  loadProjects()
})
</script>

<style scoped>
.project-list {
  padding: 24px;
}

.project-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}

.project-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 20px;
}

.project-card {
  border: 1px solid var(--el-border-color);
  border-radius: 8px;
  padding: 20px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
}

.project-card:hover {
  border-color: var(--el-color-primary);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.project-info h3 {
  margin: 0 0 8px 0;
  font-size: 16px;
  font-weight: 600;
}

.project-desc {
  color: var(--el-text-color-regular);
  margin: 0 0 16px 0;
  line-height: 1.4;
}

.project-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.last-activity {
  font-size: 12px;
  color: var(--el-text-color-secondary);
}

.project-members {
  display: flex;
  align-items: center;
  gap: 8px;
}

.member-count {
  font-size: 12px;
  color: var(--el-text-color-secondary);
}

.project-actions {
  position: absolute;
  top: 16px;
  right: 16px;
}
</style>
```

### 3. å®æ—¶åä½œç¼–è¾‘å™¨

#### Monaco ç¼–è¾‘å™¨ç»„ä»¶
```vue
<!-- components/editor/MonacoEditor.vue -->
<template>
  <div class="monaco-editor-container">
    <!-- åä½œç”¨æˆ·çŠ¶æ€æ  -->
    <div class="collaboration-bar" v-if="activeUsers.length > 0">
      <div class="active-users">
        <span class="users-label">åœ¨çº¿ç”¨æˆ·:</span>
        <div class="user-avatars">
          <div
            v-for="user in activeUsers"
            :key="user.userId"
            class="user-avatar"
            :style="{ borderColor: user.cursorColor }"
            :title="user.nickname"
          >
            <img :src="user.avatar" :alt="user.nickname" />
          </div>
        </div>
      </div>
      
      <div class="connection-status">
        <el-icon :class="connectionStatusClass">
          <Connection v-if="isConnected" />
          <Close v-else />
        </el-icon>
        <span>{{ connectionStatusText }}</span>
      </div>
    </div>
    
    <!-- ç¼–è¾‘å™¨å®¹å™¨ -->
    <div ref="editorContainer" class="editor-container"></div>
    
    <!-- ç”¨æˆ·å…‰æ ‡æ˜¾ç¤º -->
    <div class="cursors-overlay">
      <div
        v-for="cursor in remoteCursors"
        :key="cursor.userId"
        class="remote-cursor"
        :style="getCursorStyle(cursor)"
      >
        <div 
          class="cursor-line"
          :style="{ backgroundColor: cursor.color }"
        ></div>
        <div 
          class="cursor-label"
          :style="{ backgroundColor: cursor.color }"
        >
          {{ cursor.nickname }}
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, onUnmounted, watch } from 'vue'
import * as monaco from 'monaco-editor'
import { useCollaborationStore } from '@/stores/collaboration'
import { useWebSocket } from '@/services/websocket'
import type { RemoteCursor, CollaborationUser } from '@/types/collaboration'

interface Props {
  modelValue: string
  language: string
  projectId: string
  filePath: string
  readonly?: boolean
}

interface Emits {
  (e: 'update:modelValue', value: string): void
  (e: 'change', value: string): void
}

const props = withDefaults(defineProps<Props>(), {
  readonly: false
})

const emit = defineEmits<Emits>()

const collaborationStore = useCollaborationStore()
const { connect, disconnect, sendOperation, isConnected } = useWebSocket()

const editorContainer = ref<HTMLDivElement>()
const editor = ref<monaco.editor.IStandaloneCodeEditor>()
const activeUsers = ref<CollaborationUser[]>([])
const remoteCursors = ref<RemoteCursor[]>([])

let isLocalChange = false

const connectionStatusClass = computed(() => ({
  'status-connected': isConnected.value,
  'status-disconnected': !isConnected.value
}))

const connectionStatusText = computed(() => 
  isConnected.value ? 'å·²è¿æ¥' : 'è¿æ¥æ–­å¼€'
)

// åˆå§‹åŒ–ç¼–è¾‘å™¨
const initEditor = () => {
  if (!editorContainer.value) return
  
  editor.value = monaco.editor.create(editorContainer.value, {
    value: props.modelValue,
    language: props.language,
    theme: 'vs-dark',
    readOnly: props.readonly,
    fontSize: 14,
    lineNumbers: 'on',
    minimap: { enabled: true },
    scrollBeyondLastLine: false,
    automaticLayout: true,
    wordWrap: 'on'
  })
  
  // ç›‘å¬å†…å®¹å˜åŒ–
  editor.value.onDidChangeModelContent((e) => {
    if (isLocalChange) return
    
    const value = editor.value?.getValue() || ''
    emit('update:modelValue', value)
    emit('change', value)
    
    // å‘é€æ“ä½œåˆ°æœåŠ¡å™¨
    for (const change of e.changes) {
      sendOperation({
        type: 'insert',
        position: change.rangeOffset,
        text: change.text,
        length: change.text.length
      })
    }
  })
  
  // ç›‘å¬å…‰æ ‡ä½ç½®å˜åŒ–
  editor.value.onDidChangeCursorPosition((e) => {
    collaborationStore.updateCursorPosition({
      line: e.position.lineNumber,
      column: e.position.column
    })
  })
  
  // ç›‘å¬é€‰æ‹©å˜åŒ–
  editor.value.onDidChangeCursorSelection((e) => {
    collaborationStore.updateSelection({
      startLine: e.selection.startLineNumber,
      startColumn: e.selection.startColumn,
      endLine: e.selection.endLineNumber,
      endColumn: e.selection.endColumn
    })
  })
}

// åº”ç”¨è¿œç¨‹æ“ä½œ
const applyRemoteOperation = (operation: any) => {
  if (!editor.value) return
  
  isLocalChange = true
  
  try {
    const model = editor.value.getModel()
    if (!model) return
    
    const position = model.getPositionAt(operation.position)
    
    switch (operation.type) {
      case 'insert':
        model.applyEdits([{
          range: new monaco.Range(
            position.lineNumber,
            position.column,
            position.lineNumber,
            position.column
          ),
          text: operation.text
        }])
        break
        
      case 'delete':
        const endPosition = model.getPositionAt(operation.position + operation.length)
        model.applyEdits([{
          range: new monaco.Range(
            position.lineNumber,
            position.column,
            endPosition.lineNumber,
            endPosition.column
          ),
          text: ''
        }])
        break
    }
  } finally {
    isLocalChange = false
  }
}

// è·å–å…‰æ ‡æ ·å¼
const getCursorStyle = (cursor: RemoteCursor) => {
  if (!editor.value) return {}
  
  const position = new monaco.Position(cursor.line, cursor.column)
  const coords = editor.value.getScrolledVisiblePosition(position)
  
  if (!coords) return { display: 'none' }
  
  return {
    left: `${coords.left}px`,
    top: `${coords.top}px`,
    display: 'block'
  }
}

// åŠ å…¥åä½œæˆ¿é—´
const joinCollaboration = async () => {
  try {
    await connect(props.projectId, props.filePath)
    
    // ç›‘å¬åä½œäº‹ä»¶
    collaborationStore.$subscribe((mutation, state) => {
      activeUsers.value = state.activeUsers
      remoteCursors.value = state.remoteCursors
    })
    
    // ç›‘å¬è¿œç¨‹æ“ä½œ
    collaborationStore.onRemoteOperation(applyRemoteOperation)
    
  } catch (error) {
    console.error('åŠ å…¥åä½œå¤±è´¥:', error)
  }
}

// ç¦»å¼€åä½œæˆ¿é—´
const leaveCollaboration = () => {
  disconnect()
}

// ç›‘å¬å†…å®¹å˜åŒ–
watch(() => props.modelValue, (newValue) => {
  if (!editor.value || isLocalChange) return
  
  const currentValue = editor.value.getValue()
  if (currentValue !== newValue) {
    isLocalChange = true
    editor.value.setValue(newValue)
    isLocalChange = false
  }
})

// ç›‘å¬è¯­è¨€å˜åŒ–
watch(() => props.language, (newLanguage) => {
  if (!editor.value) return
  monaco.editor.setModelLanguage(editor.value.getModel()!, newLanguage)
})

onMounted(() => {
  initEditor()
  joinCollaboration()
})

onUnmounted(() => {
  leaveCollaboration()
  editor.value?.dispose()
})
</script>

<style scoped>
.monaco-editor-container {
  position: relative;
  height: 100%;
  display: flex;
  flex-direction: column;
}

.collaboration-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 16px;
  background: var(--el-bg-color-page);
  border-bottom: 1px solid var(--el-border-color);
}

.active-users {
  display: flex;
  align-items: center;
  gap: 12px;
}

.users-label {
  font-size: 12px;
  color: var(--el-text-color-secondary);
}

.user-avatars {
  display: flex;
  gap: 4px;
}

.user-avatar {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  border: 2px solid;
  overflow: hidden;
}

.user-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.connection-status {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
}

.status-connected {
  color: var(--el-color-success);
}

.status-disconnected {
  color: var(--el-color-danger);
}

.editor-container {
  flex: 1;
  min-height: 0;
}

.cursors-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  pointer-events: none;
  z-index: 10;
}

.remote-cursor {
  position: absolute;
  pointer-events: none;
}

.cursor-line {
  width: 2px;
  height: 20px;
  animation: blink 1s infinite;
}

.cursor-label {
  position: absolute;
  top: -20px;
  left: 0;
  padding: 2px 6px;
  font-size: 11px;
  color: white;
  border-radius: 3px;
  white-space: nowrap;
  opacity: 0.9;
}

@keyframes blink {
  0%, 50% { opacity: 1; }
  51%, 100% { opacity: 0; }
}
</style>
```

### 4. WebSocket å®æ—¶é€šä¿¡

#### WebSocket æœåŠ¡
```typescript
// services/websocket.ts
import { ref, computed } from 'vue'
import { ElMessage } from 'element-plus'
import { useAuthStore } from '@/stores/auth'
import { useCollaborationStore } from '@/stores/collaboration'
import type { OperationMessage, WebSocketMessage } from '@/types/collaboration'

class WebSocketService {
  private ws: WebSocket | null = null
  private reconnectTimer: number | null = null
  private heartbeatTimer: number | null = null
  private reconnectAttempts = 0
  private maxReconnectAttempts = 5
  
  public isConnected = ref(false)
  public isConnecting = ref(false)
  
  constructor() {
    this.setupEventListeners()
  }
  
  // è¿æ¥WebSocket
  async connect(projectId: string, filePath: string): Promise<void> {
    if (this.ws?.readyState === WebSocket.OPEN) {
      return Promise.resolve()
    }
    
    return new Promise((resolve, reject) => {
      try {
        const authStore = useAuthStore()
        const wsUrl = `${import.meta.env.VITE_WS_URL}/ws/editor`
        
        this.ws = new WebSocket(wsUrl)
        this.isConnecting.value = true
        
        this.ws.onopen = () => {
          console.log('WebSocketè¿æ¥å·²å»ºç«‹')
          this.isConnected.value = true
          this.isConnecting.value = false
          this.reconnectAttempts = 0
          
          // å‘é€è®¤è¯æ¶ˆæ¯
          this.sendMessage({
            type: 'auth',
            data: { token: authStore.token }
          })
          
          // åŠ å…¥æ–‡æ¡£åä½œæˆ¿é—´
          this.sendMessage({
            type: 'join-document',
            data: { projectId, filePath }
          })
          
          this.startHeartbeat()
          resolve()
        }
        
        this.ws.onmessage = (event) => {
          this.handleMessage(JSON.parse(event.data))
        }
        
        this.ws.onclose = (event) => {
          console.log('WebSocketè¿æ¥å·²å…³é—­', event)
          this.isConnected.value = false
          this.isConnecting.value = false
          this.stopHeartbeat()
          
          if (!event.wasClean && this.reconnectAttempts < this.maxReconnectAttempts) {
            this.scheduleReconnect(projectId, filePath)
          }
        }
        
        this.ws.onerror = (error) => {
          console.error('WebSocketé”™è¯¯:', error)
          this.isConnecting.value = false
          reject(new Error('WebSocketè¿æ¥å¤±è´¥'))
        }
        
      } catch (error) {
        this.isConnecting.value = false
        reject(error)
      }
    })
  }
  
  // æ–­å¼€è¿æ¥
  disconnect(): void {
    if (this.reconnectTimer) {
      clearTimeout(this.reconnectTimer)
      this.reconnectTimer = null
    }
    
    this.stopHeartbeat()
    
    if (this.ws) {
      this.ws.close(1000, 'Client disconnect')
      this.ws = null
    }
    
    this.isConnected.value = false
    this.isConnecting.value = false
  }
  
  // å‘é€æ“ä½œ
  sendOperation(operation: OperationMessage): void {
    this.sendMessage({
      type: 'operation',
      data: operation
    })
  }
  
  // å‘é€å…‰æ ‡ä½ç½®
  sendCursorPosition(position: { line: number; column: number }): void {
    this.sendMessage({
      type: 'cursor-update',
      data: position
    })
  }
  
  // å‘é€æ¶ˆæ¯
  private sendMessage(message: WebSocketMessage): void {
    if (this.ws?.readyState === WebSocket.OPEN) {
      this.ws.send(JSON.stringify(message))
    } else {
      console.warn('WebSocketæœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯')
    }
  }
  
  // å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯
  private handleMessage(message: WebSocketMessage): void {
    const collaborationStore = useCollaborationStore()
    
    switch (message.type) {
      case 'document-joined':
        collaborationStore.handleDocumentJoined(message.data)
        break
        
      case 'operation':
        collaborationStore.handleRemoteOperation(message.data)
        break
        
      case 'cursor-update':
        collaborationStore.handleCursorUpdate(message.data)
        break
        
      case 'user-joined':
        collaborationStore.handleUserJoined(message.data)
        ElMessage.success(`${message.data.nickname} åŠ å…¥äº†åä½œ`)
        break
        
      case 'user-left':
        collaborationStore.handleUserLeft(message.data)
        ElMessage.info(`${message.data.nickname} ç¦»å¼€äº†åä½œ`)
        break
        
      case 'error':
        console.error('æœåŠ¡å™¨é”™è¯¯:', message.data)
        ElMessage.error(message.data.message || 'åä½œæœåŠ¡é”™è¯¯')
        break
        
      case 'pong':
        // å¿ƒè·³å“åº”ï¼Œå¿½ç•¥
        break
        
      default:
        console.warn('æœªçŸ¥æ¶ˆæ¯ç±»å‹:', message.type)
    }
  }
  
  // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
  private setupEventListeners(): void {
    // é¡µé¢å¯è§æ€§å˜åŒ–
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        this.stopHeartbeat()
      } else if (this.isConnected.value) {
        this.startHeartbeat()
      }
    })
    
    // é¡µé¢å¸è½½
    window.addEventListener('beforeunload', () => {
      this.disconnect()
    })
  }
  
  // å¼€å§‹å¿ƒè·³
  private startHeartbeat(): void {
    this.stopHeartbeat()
    this.heartbeatTimer = window.setInterval(() => {
      this.sendMessage({ type: 'ping', data: {} })
    }, 30000) // 30ç§’å¿ƒè·³
  }
  
  // åœæ­¢å¿ƒè·³
  private stopHeartbeat(): void {
    if (this.heartbeatTimer) {
      clearInterval(this.heartbeatTimer)
      this.heartbeatTimer = null
    }
  }
  
  // è®¡åˆ’é‡è¿
  private scheduleReconnect(projectId: string, filePath: string): void {
    if (this.reconnectTimer) return
    
    this.reconnectAttempts++
    const delay = Math.min(1000 * Math.pow(2, this.reconnectAttempts), 30000)
    
    console.log(`${delay}msåå°è¯•ç¬¬${this.reconnectAttempts}æ¬¡é‡è¿`)
    
    this.reconnectTimer = window.setTimeout(() => {
      this.reconnectTimer = null
      this.connect(projectId, filePath).catch(console.error)
    }, delay)
  }
}

// å¯¼å‡ºå•ä¾‹
export const wsService = new WebSocketService()

// ç»„åˆå¼API
export function useWebSocket() {
  return {
    connect: wsService.connect.bind(wsService),
    disconnect: wsService.disconnect.bind(wsService),
    sendOperation: wsService.sendOperation.bind(wsService),
    sendCursorPosition: wsService.sendCursorPosition.bind(wsService),
    isConnected: computed(() => wsService.isConnected.value),
    isConnecting: computed(() => wsService.isConnecting.value)
  }
}
```

---

## ğŸ¯ çŠ¶æ€ç®¡ç†æ–¹æ¡ˆ

### åä½œçŠ¶æ€ç®¡ç†
```typescript
// stores/collaboration.ts
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import type { 
  CollaborationUser, 
  RemoteCursor, 
  OperationMessage,
  DocumentState
} from '@/types/collaboration'

export const useCollaborationStore = defineStore('collaboration', () => {
  const documentState = ref<DocumentState | null>(null)
  const activeUsers = ref<CollaborationUser[]>([])
  const remoteCursors = ref<RemoteCursor[]>([])
  const operationQueue = ref<OperationMessage[]>([])
  
  const currentUser = computed(() => {
    const authStore = useAuthStore()
    return activeUsers.value.find(user => user.userId === authStore.user?.id)
  })
  
  const otherUsers = computed(() => {
    const authStore = useAuthStore()
    return activeUsers.value.filter(user => user.userId !== authStore.user?.id)
  })
  
  // å¤„ç†æ–‡æ¡£åŠ å…¥
  const handleDocumentJoined = (data: any) => {
    documentState.value = {
      documentId: data.documentId,
      content: data.content,
      version: data.version
    }
    
    activeUsers.value = data.activeUsers || []
    remoteCursors.value = []
  }
  
  // å¤„ç†è¿œç¨‹æ“ä½œ
  const handleRemoteOperation = (operation: OperationMessage) => {
    // åº”ç”¨æ“ä½œè½¬æ¢ç®—æ³•
    const transformedOperation = transformOperation(operation)
    
    // è§¦å‘æ“ä½œäº‹ä»¶
    operationCallbacks.forEach(callback => callback(transformedOperation))
    
    // æ›´æ–°æ–‡æ¡£ç‰ˆæœ¬
    if (documentState.value) {
      documentState.value.version++
    }
  }
  
  // å¤„ç†å…‰æ ‡æ›´æ–°
  const handleCursorUpdate = (data: any) => {
    const existingCursor = remoteCursors.value.find(
      cursor => cursor.userId === data.userId
    )
    
    if (existingCursor) {
      Object.assign(existingCursor, data)
    } else {
      const user = activeUsers.value.find(u => u.userId === data.userId)
      if (user) {
        remoteCursors.value.push({
          userId: data.userId,
          nickname: user.nickname,
          color: user.cursorColor,
          line: data.line,
          column: data.column
        })
      }
    }
  }
  
  // å¤„ç†ç”¨æˆ·åŠ å…¥
  const handleUserJoined = (user: CollaborationUser) => {
    const existingIndex = activeUsers.value.findIndex(
      u => u.userId === user.userId
    )
    
    if (existingIndex >= 0) {
      activeUsers.value[existingIndex] = user
    } else {
      activeUsers.value.push(user)
    }
  }
  
  // å¤„ç†ç”¨æˆ·ç¦»å¼€
  const handleUserLeft = (data: { userId: string }) => {
    activeUsers.value = activeUsers.value.filter(
      user => user.userId !== data.userId
    )
    
    remoteCursors.value = remoteCursors.value.filter(
      cursor => cursor.userId !== data.userId
    )
  }
  
  // æ›´æ–°å…‰æ ‡ä½ç½®
  const updateCursorPosition = (position: { line: number; column: number }) => {
    wsService.sendCursorPosition(position)
  }
  
  // æ›´æ–°é€‰æ‹©åŒºåŸŸ
  const updateSelection = (selection: any) => {
    // å‘é€é€‰æ‹©åŒºåŸŸæ›´æ–°
    wsService.sendMessage({
      type: 'selection-update',
      data: selection
    })
  }
  
  // æ“ä½œè½¬æ¢ç®—æ³•
  const transformOperation = (operation: OperationMessage): OperationMessage => {
    // ç®€åŒ–çš„OTç®—æ³•å®ç°
    // åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œè¿™é‡Œéœ€è¦æ›´å¤æ‚çš„è½¬æ¢é€»è¾‘
    
    let transformedOperation = { ...operation }
    
    // å¯¹é˜Ÿåˆ—ä¸­çš„æ“ä½œè¿›è¡Œè½¬æ¢
    for (const queuedOp of operationQueue.value) {
      if (queuedOp.timestamp < operation.timestamp) {
        transformedOperation = applyTransformation(transformedOperation, queuedOp)
      }
    }
    
    return transformedOperation
  }
  
  // åº”ç”¨æ“ä½œè½¬æ¢
  const applyTransformation = (op1: OperationMessage, op2: OperationMessage): OperationMessage => {
    // æ’å…¥-æ’å…¥è½¬æ¢
    if (op1.type === 'insert' && op2.type === 'insert') {
      if (op2.position <= op1.position) {
        return {
          ...op1,
          position: op1.position + op2.text.length
        }
      }
    }
    
    // åˆ é™¤-æ’å…¥è½¬æ¢
    if (op1.type === 'insert' && op2.type === 'delete') {
      if (op2.position <= op1.position) {
        return {
          ...op1,
          position: Math.max(op1.position - op2.length, op2.position)
        }
      }
    }
    
    return op1
  }
  
  // æ“ä½œå›è°ƒ
  const operationCallbacks = new Set<(operation: OperationMessage) => void>()
  
  const onRemoteOperation = (callback: (operation: OperationMessage) => void) => {
    operationCallbacks.add(callback)
    return () => operationCallbacks.delete(callback)
  }
  
  // æ¸…ç†çŠ¶æ€
  const cleanup = () => {
    documentState.value = null
    activeUsers.value = []
    remoteCursors.value = []
    operationQueue.value = []
    operationCallbacks.clear()
  }
  
  return {
    documentState,
    activeUsers,
    remoteCursors,
    currentUser,
    otherUsers,
    handleDocumentJoined,
    handleRemoteOperation,
    handleCursorUpdate,
    handleUserJoined,
    handleUserLeft,
    updateCursorPosition,
    updateSelection,
    onRemoteOperation,
    cleanup
  }
})
```

---

## ğŸ”§ å·¥ç¨‹åŒ–é…ç½®

### Vite é…ç½®
```typescript
// vite.config.ts
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import { resolve } from 'path'
import AutoImport from 'unplugin-auto-import/vite'
import Components from 'unplugin-vue-components/vite'
import { ElementPlusResolver } from 'unplugin-vue-components/resolvers'

export default defineConfig({
  plugins: [
    vue(),
    AutoImport({
      resolvers: [ElementPlusResolver()],
      imports: ['vue', 'vue-router', 'pinia']
    }),
    Components({
      resolvers: [ElementPlusResolver()]
    })
  ],
  
  resolve: {
    alias: {
      '@': resolve(__dirname, 'src')
    }
  },
  
  css: {
    preprocessorOptions: {
      scss: {
        additionalData: `@import "@/assets/styles/variables.scss";`
      }
    }
  },
  
  server: {
    port: 3000,
    proxy: {
      '/api': {
        target: 'http://localhost:8080',
        changeOrigin: true
      },
      '/ws': {
        target: 'ws://localhost:8083',
        ws: true,
        changeOrigin: true
      }
    }
  },
  
  build: {
    target: 'es2015',
    outDir: 'dist',
    sourcemap: false,
    rollupOptions: {
      output: {
        manualChunks: {
          vue: ['vue', 'vue-router', 'pinia'],
          element: ['element-plus'],
          monaco: ['monaco-editor']
        }
      }
    }
  }
})
```

### TypeScript é…ç½®
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "preserve",
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  },
  "include": ["src/**/*.ts", "src/**/*.d.ts", "src/**/*.tsx", "src/**/*.vue"],
  "references": [{ "path": "./tsconfig.node.json" }]
}
```

---

## ğŸ¯ é¢è¯•å‡†å¤‡è¦ç‚¹

### ğŸ’¡ å‰ç«¯æŠ€æœ¯äº®ç‚¹

1. **ç°ä»£å‰ç«¯æ¶æ„** - Vue 3 + TypeScript + Vite å…¨å®¶æ¡¶
2. **å®æ—¶åä½œç¼–è¾‘å™¨** - Monaco Editor + WebSocket + OTç®—æ³•
3. **çŠ¶æ€ç®¡ç†** - Piniaæ¨¡å—åŒ–çŠ¶æ€ç®¡ç†
4. **å·¥ç¨‹åŒ–å®Œå–„** - è‡ªåŠ¨å¯¼å…¥ã€ç»„ä»¶åº“é›†æˆã€ä»£ç åˆ†å‰²
5. **TypeScriptå…¨è¦†ç›–** - ç±»å‹å®‰å…¨ï¼Œå¼€å‘ä½“éªŒä¼˜ç§€

### ğŸ¯ å¸¸è§é¢è¯•é—®é¢˜

#### 1. "ä¸ºä»€ä¹ˆé€‰æ‹©Vue 3è€Œä¸æ˜¯Reactï¼Ÿ"
```yaml
å›ç­”è¦ç‚¹:
  - å­¦ä¹ æˆæœ¬ä½ï¼Œæ¸è¿›å¼æ¡†æ¶æ˜“ä¸Šæ‰‹
  - Composition APIæä¾›æ›´å¥½çš„é€»è¾‘å¤ç”¨
  - æ¨¡æ¿è¯­æ³•æ›´æ¥è¿‘HTMLï¼Œå¼€å‘æ•ˆç‡é«˜
  - TypeScriptæ”¯æŒä¼˜ç§€ï¼Œç±»å‹æ¨å¯¼å¼º
  - ç”Ÿæ€æˆç†Ÿï¼ŒElement Plusç­‰UIåº“å®Œå–„
```

#### 2. "å®æ—¶åä½œçš„æŠ€æœ¯éš¾ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ"
```yaml
å›ç­”è¦ç‚¹:
  - æ“ä½œè½¬æ¢ç®—æ³•ï¼Œè§£å†³å¹¶å‘ç¼–è¾‘å†²çª
  - WebSocketè¿æ¥ç®¡ç†ï¼Œæ–­çº¿é‡è¿æœºåˆ¶
  - å…‰æ ‡ä½ç½®åŒæ­¥ï¼Œå¤šç”¨æˆ·çŠ¶æ€å±•ç¤º
  - æ€§èƒ½ä¼˜åŒ–ï¼Œå¤§æ–‡æ¡£ç¼–è¾‘æµç•…æ€§
  - æ•°æ®ä¸€è‡´æ€§ï¼Œç¡®ä¿æ‰€æœ‰ç”¨æˆ·çœ‹åˆ°ç›¸åŒå†…å®¹
```

#### 3. "å¦‚ä½•ä¼˜åŒ–å¤§å‹å•é¡µåº”ç”¨çš„æ€§èƒ½ï¼Ÿ"
```yaml
å›ç­”è¦ç‚¹:
  - ä»£ç åˆ†å‰²ï¼ŒæŒ‰è·¯ç”±å’Œç»„ä»¶æ‡’åŠ è½½
  - ç»„ä»¶ç¼“å­˜ï¼Œkeep-aliveå’Œv-memo
  - è™šæ‹Ÿæ»šåŠ¨ï¼Œå¤„ç†å¤§é‡æ•°æ®å±•ç¤º
  - é˜²æŠ–èŠ‚æµï¼Œä¼˜åŒ–ç”¨æˆ·è¾“å…¥å“åº”
  - CDNèµ„æºï¼Œé™æ€èµ„æºåŠ é€Ÿ
```

#### 4. "çŠ¶æ€ç®¡ç†æ–¹æ¡ˆå¦‚ä½•é€‰æ‹©ï¼Ÿ"
```yaml
å›ç­”è¦ç‚¹:
  - å°é¡¹ç›®ç”¨Provide/Injectæˆ–Composables
  - ä¸­å¤§å‹é¡¹ç›®ç”¨Piniaï¼Œæ¨¡å—åŒ–ç®¡ç†
  - è·¨ç»„ä»¶é€šä¿¡ç”¨äº‹ä»¶æ€»çº¿æˆ–çŠ¶æ€åº“
  - æœåŠ¡ç«¯çŠ¶æ€ç”¨ä¸“é—¨çš„åº“å¦‚TanStack Query
  - æœ¬åœ°çŠ¶æ€ä¼˜å…ˆï¼Œé¿å…è¿‡åº¦é›†ä¸­åŒ–
```

### ğŸš€ æŠ€æœ¯æ‰©å±•æ€è€ƒ

å½“é¢è¯•å®˜é—®"å¦‚ä½•æ”¯æŒæ›´å¤§è§„æ¨¡çš„å‰ç«¯åº”ç”¨ï¼Ÿ"

```yaml
æ¶æ„å‡çº§:
  - å¾®å‰ç«¯æ¶æ„ï¼Œæ¨¡å—ç‹¬ç«‹å¼€å‘éƒ¨ç½²
  - ç»„ä»¶åº“æŠ½ç¦»ï¼Œç»Ÿä¸€è®¾è®¡ç³»ç»Ÿ
  - å·¥ç¨‹åŒ–å‡çº§ï¼ŒMonorepoç®¡ç†å¤šé¡¹ç›®

æ€§èƒ½ä¼˜åŒ–:
  - SSR/SSGï¼Œé¦–å±æ¸²æŸ“ä¼˜åŒ–
  - Service Workerï¼Œç¦»çº¿ç¼“å­˜
  - Web Workersï¼Œè®¡ç®—å¯†é›†ä»»åŠ¡

å¼€å‘ä½“éªŒ:
  - å¯è§†åŒ–æ­å»ºï¼Œä½ä»£ç å¹³å°
  - è‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œå•å…ƒæµ‹è¯•+E2E
  - CI/CDé›†æˆï¼Œè‡ªåŠ¨åŒ–éƒ¨ç½²
```